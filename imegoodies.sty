% 2017/01/01 -> fontenc TU and mandatory e-TeX support
%
% TODO: After ubuntu 18.04 EOL (April/2023), we should switch to
%       2018/12/01 (kernel uses utf8 by default) and remove inputenc
%       and the "@combinedblfloats" bugfix below. After ubuntu 20.04
%       EOL (April/2025), check whether arxiv uses at least version
%       2021 of TeXLive; if so, change this to version 2020/10/01,
%       which includes file hooks, and make the corresponding
%       adjustments (in particular, the AtEndDvi fix further below).
\NeedsTeXFormat{LaTeX2e}[2017/01/01]
\ProvidesPackage{imegoodies}[2022/11/13 1.0 Load several common
                                            and useful packages]


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%% CONFIGURAÇÕES E PACOTES BÁSICOS %%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Vários comandos auxiliares para o desenvolvimento de packages e classes;
% aqui, usamos em alguns comandos de formatação e condicionais.
\RequirePackage{etoolbox}
%\RequirePackage{pdftexcmds}
\RequirePackage{letltxmacro}
%\RequirePackage{ltxcmds}

% LaTeX 3
\RequirePackage{expl3}
\RequirePackage{xparse}

%%%% Opções
\newtoggle{IMEguaranteeBrazilian}
\newtoggle{IMEappearance}
\newtoggle{IMEbeamer}
\newtoggle{IMEthesis}

\DeclareOption{beamer}{
    \toggletrue{IMEguaranteeBrazilian}
    \toggletrue{IMEappearance}
    \toggletrue{IMEbeamer}
}

\DeclareOption{thesis}{
    \toggletrue{IMEguaranteeBrazilian}
    \toggletrue{IMEappearance}
    \toggletrue{IMEthesis}
}

\DeclareOption{brazilian}{\toggletrue{IMEguaranteeBrazilian}}
\DeclareOption{nobrazilian}{\togglefalse{IMEguaranteeBrazilian}}
\DeclareOption{imestyle}{\toggletrue{IMEappearance}}
\DeclareOption{noimestyle}{\togglefalse{IMEappearance}}

\ExecuteOptions{brazilian,imestyle}
\ProcessOptions\relax

%\RequirePackage{filehook}

% Detecta se estamos usando pdftex, luatex, xetex etc.
\RequirePackage{iftex}

%\RequirePackage{xfp} % Floating-point calculations

\RequirePackage{regexpatch}

% O projeto LaTeX3 renomeou algumas macros em 2019-03-05 e removeu
% a compatibilidade com os nomes antigos em 2020-07-17 a partir de
% 2021-01-01 (veja o arquivo l3deprecation.dtx e o changelog em
% https://github.com/latex3/latex3/blob/main/l3kernel/CHANGELOG.md).
% Isso afetou a package regexpatch: versões antigas da package não
% funcionam com versões novas de LaTeX e vice-versa. Infelizmente,
% ubuntu 21.04 (hirsute) e debian 11 (bullseye) incluem essas versões
% incompatíveis e, portanto, a package regexpatch não funciona nesses
% ambientes. Talvez fosse possível contornar esse problema com a
% package latexrelease, mas isso afetaria muitos outros recursos.
% Ao invés disso, vamos restaurar manualmente a compatibilidade.
% TODO: remover isto após debian bullseye se tornar obsoleta,
%       provavelmente no final de 2024.
\ExplSyntaxOn
\@ifpackagelater{regexpatch}{2021/03/21}
  {} % Se regexpatch é "nova", expl3 deve ser também; nada a fazer
  {
    % Talvez o correto seja 2021/01/01, mas na prática o resultado é o mesmo
    \@ifpackagelater{expl3}{2020/07/17}
      {
        % As versões são incompatíveis; vamos recuperar as macros preteridas
        \cs_gset:Npn \token_get_prefix_spec:N { \cs_prefix_spec:N }
        \cs_gset:Npn \token_get_arg_spec:N { \cs_argument_spec:N }
        \cs_gset:Npn \token_get_replacement_spec:N { \cs_replacement_spec:N }
      }
      {} % As duas packages são antigas e, portanto, compatíveis entre si
  }
\ExplSyntaxOff

% Algumas packages dependem de xpatch e tentam carregá-la, causando conflitos
% com regexpatch. Como regexpatch oferece todos os recursos de xpatch (ela
% é uma versão estendida de xpatch, mas ainda considerada experimental), vamos
% fazê-las acreditar que xpatch já foi carregada.
\@ifpackagelater{regexpatch}{2020/10/06}
    {\expandafter\xdef\csname ver@xpatch.sty\endcsname{2020/03/25}}
    {\expandafter\xdef\csname ver@xpatch.sty\endcsname{2012/10/02}}

% Acrescenta a correção deste bug (contida na release 2018-11-28):
% https://github.com/latex3/latex2e/issues/94 . Se a correção não
% puder ser aplicada, temos uma versão de LaTeX que já a incorpora.
% Esse bug afeta apenas textos em duas colunas.
% TODO: remover após ubuntu 18.04 se tornar obsoleta (abril/2023)
\patchcmd\@combinedblfloats{\box\@outputbox}{\unvbox\@outputbox}{}{}

% Expressões aritméticas em \set{length,counter} & \addto{length,counter};
% comandos \widthof, \heightof, \depthof, \totalheightof, \settototalheight
\RequirePackage{calc}

% Algumas packages "padrão" da AMS, que são praticamente obrigatórias.
% Algumas delas devem ser carregadas antes de unicode-math ou das
% definições das fontes do documento. É preciso carregar amsthm após
% amsmath para o comando \qedhere funcionar dentro do ambiente align.
\RequirePackage{amssymb}
\RequirePackage{amsmath}
\RequirePackage{amsthm}

% TeXLive 2018 inclui a versão 2.7a da package microtype e a versão
% 1.07 de luatex. Essa combinação faz aparecer um bug:
% https://tex.stackexchange.com/a/476742
% Aqui, aplicamos a solução sugerida, que não tem "contra-indicações".
% TODO: remover após ubuntu 18.04 se tornar obsoleta (abril/2023)
\ifLuaTeX
  \RequirePackage{luatexbase}
\fi

% microajustes no tamanho das letras, espaçamento etc. para melhorar
% a qualidade visual do resultado.
\RequirePackage{microtype}

% Alguns "truques" (sujos?) para minimizar over/underfull boxes.
%
% Para fazer um texto justificado, é preciso modificar o tamanho dos espaços
% em cada linha para mais ou para menos em relação ao seu tamanho ideal. Para
% escolher as quebras de linha, TeX vai percorrendo o texto procurando lugares
% possíveis para quebrar as linhas considerando essa flexibilidade mas dentro
% de um certo limite mínimo/máximo. Nesse processo, ele associa a cada possível
% linha o valor *badness*, que é o nível de distorção do tamanho dos espaços
% daquela linha em relação ao ideal, e ignora opções que tenham badness muito
% grande (esse limite é dado por \tolerance). Depois de encontradas todas
% as possíveis quebras de linha e a badness de cada uma, TeX calcula as
% *penalties* das quebras encontradas, que são uma medida de quebras "ruins".
% Por exemplo, na configuração padrão, quebrar uma linha hifenizando uma
% palavra gera uma penalty de 50; já uma quebra que faça a última linha
% do parágrafo ficar sozinha na página seguinte gera uma penalty de 150.
% Finalmente, TeX calcula a "feiúra" de cada possível linha (demerits)
% com base na badness e nas penalties e escolhe a solução que minimiza os
% demerits totais do parágrafo. Os comandos \linebreak e \pagebreak funcionam
% simplesmente acrescentando uma penalty negativa ao lugar desejado para a
% quebra.
%
% Para cada fonte, o espaço entre palavras tem um tamanho ideal, um
% tamanho mínimo e um tamanho máximo (é possível obter os valores com
% \number\fontdimenX\font\relax, veja https://tex.stackexchange.com/q/88991 ).
% TeX nunca reduz um espaço para menos que o mínimo da fonte, mas pode
% aumentá-lo para mais que o máximo. Se os espaços de uma linha ficam
% com o tamanho ideal, a badness da linha é 0; se o tamanho é
% reduzido/aumentado 50% do mínimo/máximo, a badness da linha é 12; se
% o tamanho é reduzido/aumentado para o mínimo/máximo, a badness é 100,
% e assim por diante. O valor máximo possível para badness é 10.000, que
% significa "badness infinita". Como é feito o cálculo: se as medidas
% do espaço definidas pela fonte são "x plus y minus z" e o tamanho
% final do espaço é "x + k*y" ou "x - k*z", a badness é 100*(k^3). Com
% Libertinus corpo 12, os valores são "3pt plus 1.5pt minus .9996pt",
% Então se o espaço tiver sido aumentado para 3.75pt, o fator é 0.5 e
% a badness é 100*(.5^3) = 12.
%
% \tolerance indica a badness máxima que TeX aceita para uma linha; seu valor
% default é 200. Assim, aumentar para, digamos, 300 ou 400, permite que
% TeX escolha parágrafos com maior variação no espaçamento entre as palavras.
% No entanto, no cálculo de demerits, a badness e as penalties de cada linha
% são elevadas ao quadrado, então TeX geralmente prefere escolher outras
% opções no lugar de uma linha com espaçamento ruim. Por exemplo, órfãs/viúvas
% têm demerit de 22.500 e dois hífens seguidos têm demerit de 10.000; já uma
% linha com badness 400 tem demerit 160.000. Portanto, não é surpreendente que
% a maioria dos parágrafos tenha demerits abaixo de 40.000, quase todos abaixo
% de 100.000 e praticamente nenhum acima de 1.000.000. Isso significa que, para
% a grande maioria dos parágrafos, aumentar \tolerance não faz diferença: uma
% linha com badness 400 nunca será efetivamente escolhida se houver qualquer
% outra opção com badness menor. Também fica claro que não há muita diferença
% real entre definir \tolerance como 800 ou 9.999 (a não ser fazer TeX
% trabalhar mais desnecessariamente).
%
% O problema muda de figura se TeX não consegue encontrar uma solução. Isso
% pode acontecer em dois casos: (1) o parágrafo tem ao menos uma linha que não
% pode ser quebrada com badness < 10.000 ou (2) o parágrafo tem ao menos uma
% linha que não pode ser quebrada com badness < tolerance (mas essa badness é
% menor que 10.000).
%
% No primeiro caso, se houver várias possibilidades de linhas que não podem ser
% quebradas, TeX não vai ser capaz de compará-las e escolher a melhor: todas
% têm a badness máxima (10.000) e, portanto, a que gerar menos deméritos no
% restante do parágrafo será a escolhida. Na realidade, no entanto, essas
% linhas *não* são igualmente ruins entre si, o que pode levar TeX a fazer uma
% má escolha. Para evitar isso, TeX tenta novamente aplicando
% \emergencystretch, que "faz de conta" que o tamanho máximo ideal dos espaços
% da linha é maior que o definido na fonte. Isso reduz a badness de todas as
% linhas, o que soa parecido com aumentar \tolerance. Há três diferenças, no
% entanto: (1) essa mudança só afeta os parágrafos que falharam; (2) soluções
% que originalmente teriam badness = 10.000 (e, portanto, seriam vistas como
% equivalentes) podem ser avaliadas e comparadas entre si; e (3) como a badness
% de todas as linhas diminui, a possibilidade de outras linhas que
% originalmente tinham badness alta serem escolhidas aumenta. Esse último ponto
% significa que \emergencystretch pode fazer TeX escolher linhas mais
% espaçadas, fazendo o espaçamento do parágrafo inteiro aumentar e, portanto,
% tornando o resultado mais homogêneo mesmo com uma linha particularmente ruim.
%
% É esse último ponto que justifica o uso de \emergencystretch no segundo caso
% também: apenas aumentar a tolerância, nesse caso, poderia levar TeX a
% diagramar uma linha ruim em meio a um parágrafo bom, enquanto
% \emergencystretch pode fazer TeX aumentar o espaçamento de maneira geral no
% parágrafo, minimizando o contraste da linha problemática com as demais.
% Colocando a questão de outra maneira, aumentar \tolerance para lidar com
% esses parágrafos problemáticos pode fazê-los ter uma linha especialmente
% ruim, enquanto \emergencystretch pode dividir o erro entre várias linhas.
% Assim, definir \tolerance em torno de 800 parece razoável: no caso geral,
% não há diferença e, se um desses casos difíceis não pode ser resolvido com
% uma linha de badness até 800, \emergencystretch deve ser capaz de gerar um
% resultado igual ou melhor.
%
% Penalties & demerits: https://tex.stackexchange.com/a/51264
% Definições (fussy, sloppy etc.): https://tex.stackexchange.com/a/241355
% Mais definições (hfuzz, hbadness etc.): https://tex.stackexchange.com/a/50850
% Donald Arseneau defendendo o uso de \sloppy: https://groups.google.com/d/msg/comp.text.tex/Dhf0xxuQ66E/QTZ7aLYrdQUJ
% Artigo detalhado sobre \emergencystretch: https://www.tug.org/TUGboat/tb38-1/tb118wermuth.pdf
% Esse artigo me leva a crer que algo em torno de 1.5em é suficiente

\tolerance=800
\hyphenpenalty=100 % Default 50; se o texto é em 2 colunas, 50 é melhor
\setlength{\emergencystretch}{1.5em}

% Não gera warnings para Overfull menor que 1pt
\hfuzz=1pt
\vfuzz\hfuzz

% Não gera warnings para Underfull com badness < 1000
\hbadness=1000
\vbadness=1000

% Por padrão, o algoritmo LaTeX para textos não-justificados é (muito) ruim;
% este pacote implementa um algoritmo bem melhor
\RequirePackage[newcommands]{ragged2e}

% ragged2e funciona porque permite que LaTeX hifenize palavras em textos
% não-justificados quando necessário. No caso de textos centralizados,
% no entanto, isso em geral não é desejável. Assim, newcommands não é
% interessante para \centering e \begin{center}. newcommands também
% causa problemas com legendas se o float correspondente usa \centering
% (o que é muito comum). Assim, vamos voltar \centering e \begin{center}
% à definição padrão.
\let\centering\LaTeXcentering
\let\center\LaTeXcenter
\let\endcenter\endLaTeXcenter

% Com ragged2e e a opção "newcommands", textos curtos não-justificados
% podem gerar warnings sobre "underfull \hbox". Não há razão para pensar
% muito nesses warnings, então melhor desabilitá-los.
% https://tex.stackexchange.com/a/18019
\gappto{\raggedright}{\hbadness=\@M}
\gappto{\RaggedRight}{\hbadness=\@M}
\gappto{\raggedleft}{\hbadness=\@M}
\gappto{\RaggedLeft}{\hbadness=\@M}
\gappto{\Centering}{\hbadness=\@M} % not \centering
\gappto{\flushleft}{\hbadness=\@M}
\gappto{\FlushLeft}{\hbadness=\@M}
\gappto{\flushright}{\hbadness=\@M}
\gappto{\FlushRight}{\hbadness=\@M}
\gappto{\Center}{\hbadness=\@M} % not \center

% Espaçamento entre linhas configurável (\singlespacing, \onehalfspacing etc.)
\RequirePackage{setspace}

% LaTeX às vezes coloca notas de rodapé logo após o final do texto da
% página ao invés de no final da página; este pacote evita isso e faz
% notas de rodapé funcionarem corretamente em títulos de seções.
% Esta package deve ser carregada depois de setspace.
\RequirePackage[stable,bottom]{footmisc}

% Se uma página está vazia, não imprime número de página ou cabeçalho
\RequirePackage{emptypage}

% hyperref deve preferencialmente ser carregada próximo ao final
% do preâmbulo mas, para o caso de alguma package forçar a sua
% carga antes de executarmos \usepackage explicitamente, vamos
% garantir que estas opções estejam ativas.
\PassOptionsToPackage{
  unicode=true,
  pdfencoding=unicode,
  plainpages=false,
  pdfpagelabels,
  bookmarksopen=true,
  breaklinks=true,
  %hyperfootnotes=false, % polui desnecessariamente com bordercolor
  hyperindex=false, % Vamos cuidar disso "manualmente" TODO: ou voltar atrás
}{hyperref}

% Carrega nomes de cores disponíveis (podem ser usados com hyperref e listings)
\RequirePackage[hyperref,svgnames,x11names,table]{xcolor}

% LaTeX oferece 2 pares de comandos nativos para mudar textos para caixa
% alta ou baixa: \uppercase ou \lowercase (TeX "puro") e \MakeUppercase
% ou \MakeLowecase (LaTeX), mas esses comandos têm algumas limitações
% (https://tug.org/TUGboat/tb41-1/tb127wright-case.pdf ). Esta package
% define os comandos \MakeTextUppercase e \MakeTextLowercase que resolvem
% isso.
% TODO: quando TeXLive 2023 for a versão mais antiga de LaTeX a que
%       estivermos dando suporte, podemos eliminar a package textcase
%       e usar \MakeUppercase e \MakeLowercase diretamente. A partir
%       dessa versão, essas macros usam \text_[upper|lower]case:n de
%       expl3.
\RequirePackage{textcase}

% Em documentos frente-e-verso, LaTeX faz o final da página terminar sempre
% no mesmo lugar (exceto no final dos capítulos). Esse comportamento pode ser
% ativado explicitamente com o comando "\flushbottom". Mas se, por alguma
% razão, o volume de texto na página é "pequeno", essa página vai ter espaços
% verticais artificialmente grandes. Uma solução para esse problema é utilizar
% "\raggedbottom" (padrão em documentos que não são frente-e-verso): com essa
% opção, as páginas podem terminar em alturas ligeiramente diferentes. Outra
% opção é corrigir manualmente cada página problemática, por exemplo com o
% comando "\enlargethispage".
%\raggedbottom
\flushbottom

% Por padrão, LaTeX coloca uma espaço aumentado após sinais de pontuação;
% Isso não é tão bom quanto alguns TeX-eiros defendem :) .
% Esta opção desabilita isso e, consequentemente, evita problemas com
% "id est" (i.e.) e "exempli gratia" (e.g.)
\frenchspacing

% AAAAA FIXME
% Durante o processamento, LaTeX procura por arquivos adicionais necessários
% (tanto componentes do próprio LaTeX, como packages e fontes, quanto partes
% do conteúdo em si, como imagens carregadas com \includegraphics ou arquivos
% solicitados com \input ou \include) no diretório de instalação e também
% no diretório atual (ou seja, o diretório do projeto). Assim, normalmente
% é preciso usar caminhos relativos para incluir arquivos de subdiretórios:
% "\input{diretorio/arquivo}". No entanto, há duas limitações:
%
% 1. É necessário dizer "\input{diretorio/arquivo}" mesmo quando o arquivo
%    que contém esse comando já está dentro do subdiretório.
%
% 2. Isso não deve ser usado para packages ("\usepackage{diretorio/package}"),
%    embora na prática funcione.
%
% Há três maneiras recomendadas de resolver esses problemas:
%
% 1. Acrescentando os diretórios desejados ao arquivo texmf.cnf
%
% 2. Acrescentando os diretórios desejados às variáveis de ambiente
%    TEXINPUTS e BSTINPUTS
%
% 3. Colocando os arquivos adicionais na árvore TEXMF (geralmente, no
%    diretório texmf dentro do diretório do usuário).
%
% Essas soluções, no entanto, não podem ser automatizadas por este modelo
% e são um tanto complicadas para usuários menos experientes. Veja mais a
% respeito na seção 5 de "texdoc kpathsea" e em
% https://www.overleaf.com/learn/latex/Articles/An_introduction_to_Kpathsea_and_how_TeX_engines_search_for_files .
%
% A package import pode solucionar o primeiro problema, mas exige o uso
% de outro comando no lugar de \input, então não a usamos aqui.
%\RequirePackage{import}
%
% Uma solução mais simples é acrescentar os diretórios desejados à macro
% \input@path, originalmente criada para resolver um problema relacionado
% à portabilidade. Seu uso não é normalmente recomendado por razões de
% desempenho, mas no nosso caso (em que adicionamos apenas um diretório
% com poucos arquivos e com máquinas modernas) isso não é um problema. Veja
% https://tex.stackexchange.com/questions/241828/define-path-for-packages-in-the-latex-file-analog-of-inputpath-or-graphicspa#comment705011_241832
\csappto{input@path}{{extras/}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% FORCE BRAZILIAN %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% For theses, we need to have at least some variant of Portuguese and of
% English loaded to generate the abstract/resumo, palavras-chave/keywords
% etc. For other documents, they might come in handy too. Here we make sure
% that both languages are present in the class options list by adding them
% if needed. With this, these options become global and therefore are seen
% by all packages (among them, babel).
%
% babel traditionally uses "portuguese", "brazilian", "portuges", or
% "brazil" to support the Portuguese language, using .ldf files. babel
% is also in the process of implementing a new scheme, using .ini
% files, based on the concept of "locales" instead of "languages". This
% mechanism uses the names "portuguese-portugal", "portuguese-brazil",
% "portuguese-pt", "portuguese-br", "portuguese", "brazilian", "pt",
% "pt-PT", and "pt-BR" (i.e., neither "portuges" nor "brazil"). To avoid
% compatibility problems, let's stick with "brazilian" or "portuguese"
% by substituting portuges and brazil if necessary.

\ExplSyntaxOn
\NewDocumentCommand\@IMEportugueseAndEnglish{m}{

  % Make sure any instances of "portuges" and "brazil" are replaced
  % by "portuguese" e "brazilian"; other options are unchanged.
  \seq_gclear_new:N \l_tmpa_seq
  \seq_gclear_new:N \l_tmpb_seq
  \seq_gset_from_clist:Nc \l_tmpa_seq {#1}

  \seq_map_inline:Nn \l_tmpa_seq{
    \def\@tempa{##1}
    \ifstrequal{portuges}{##1}
      {
        \GenericInfo{sbc2019}{}{Substituting~language~portuges~->~portuguese}
        \def\@tempa{portuguese}
      }
      {}
    \ifstrequal{brazil}{##1}
      {
        \GenericInfo{}{Substituting~language~brazil~->~brazilian}
        \def\@tempa{brazilian}
      }
      {}
    \seq_gput_right:NV \l_tmpb_seq {\@tempa}
  }

  % Remove the leftmost duplicates (default is to remove the rightmost ones).
  % Necessary in case the user did "portuges,portuguese", "brazil,brazilian"
  % or some variation: When we substitute the language, we end up with the
  % exact same language twice, which may mess up the main language selection.
  \seq_greverse:N \l_tmpb_seq
  \seq_gremove_duplicates:N \l_tmpb_seq
  \seq_greverse:N \l_tmpb_seq

  % If the user failed to select some variation of English and Portuguese,
  % we add them here. We also remember which ones of portuguese/brazilian,
  % english/american/british etc. were selected.
  \exp_args:Nnx \regex_extract_all:nnNTF
    {\b(portuguese|brazilian)\b}
    {\seq_use:Nn \l_tmpb_seq {,}}
    \l_tmpa_tl
    {
      \tl_reverse:N \l_tmpa_tl
      \xdef\@IMEpt{\tl_head:N \l_tmpa_tl}
    }
    {
      \seq_gput_left:Nn \l_tmpb_seq {brazilian}
      \gdef\@IMEpt{brazilian}
    }

  \exp_args:Nnx \regex_extract_all:nnNTF
    {\b(english|american|USenglish|canadian|british|UKenglish|australian|newzealand)\b}
    {\seq_use:Nn \l_tmpb_seq {,}}
    \l_tmpa_tl
    {
      \tl_reverse:N \l_tmpa_tl
      \xdef\@IMEen{\tl_head:N \l_tmpa_tl}
    }
    {
      \seq_gput_left:Nn \l_tmpb_seq {english}
      \gdef\@IMEen{english}
    }

  \exp_args:Nc \xdef {#1} {\seq_use:Nn \l_tmpb_seq {,}}
}
\ExplSyntaxOff

\iftoggle{IMEguaranteeBrazilian}
  {
    % https://tex.stackexchange.com/a/43541
    % This message is part of a larger thread that discusses some
    % limitations of this method, but it is enough for us here.
    \def\@getcl@ss#1.cls#2\relax{\def\@currentclass{#1}}
    \def\@getclass{\expandafter\@getcl@ss\@filelist\relax}
    \@getclass

    % The three class option lists we need to update: \@unusedoptionlist,
    % \@classoptionslist and one of \opt@book.cls, \opt@article.cls etc.
    % according to the current class. Note that beamer.cls (and maybe
    % others) does not use \@unusedoptionlist; with it, we incorrectly
    % add "english,brazilian" to \@unusedoptionlist, but that does not
    % cause problems.
    \@IMEportugueseAndEnglish{@unusedoptionlist}
    \@IMEportugueseAndEnglish{@classoptionslist}
    \@IMEportugueseAndEnglish{opt@\@currentclass .cls}
  }
  {}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% LÍNGUAS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Babel permite definir a língua ou línguas usadas no documento e deve
% ser um dos primeiros pacotes a serem carregados. É possível definir
% as línguas como parâmetro aqui ou ao carregar a classe, no início do
% documento. A definição ao carregar a classe é uma opção melhor, pois
% algumas outras packages além de babel também utilizam essa informação.
%
% A escolha da língua afeta quatro coisas:
%
% 1. A internacionalização das palavras criadas automaticamente, como
%    "Capítulo/Chapter", "Sumário/Table of Contents" etc. - babel chama
%    essas palavras de "captions";
%
% 2. A hifenização das palavras;
%
% 3. Algumas convenções tipográficas. Por exemplo, em francês é usual
%    acrescentar um espaço antes de caracteres como "?" e "!"; línguas
%    diferentes usam caracteres diferentes para as aspas tipográficas;
%    com algumas línguas asiáticas, pode ser necessário utilizar uma
%    fonte diferente etc.;
%
% 4. Atalhos (shorthands) - algumas línguas definem "atalhos" (shorthands"),
%    ou seja, tratam alguns caracteres como comandos especiais; por exemplo,
%    em francês o espaço que é colocado antes da exclamação funciona porque
%    o caracter "!" é, na verdade, um comando.
%
%%%% MUDANDO A LÍNGUA E HIFENIZAÇÃO %%%%
%
% Cada documento tem uma língua padrão; quando usamos pequenos trechos em
% outra língua, como por exemplo em citações, queremos alterar apenas os
% aspectos 2, 3 e 4; nesse caso, a troca da língua deve ser feita com
% \foreignlanguage{língua}{texto} ou com \begin{otherlanguage*}{língua}.
% Para alterar todos os quatro aspectos, deve-se usar \selectlanguage{língua}
% (que altera a língua padrão a partir desse ponto) ou
% \begin{otherlanguage}{língua}{texto}, que faz a alteração apenas até
% \end{otherlanguage}. Se você quiser apenas desabilitar a hifenização de
% um trecho de texto, pode usar \begin{hyphenrules}{nohyphenation}.
% Finalmente, com \babeltags é possível definir comandos curtos como
% "\textbr" (para "brazilian") que são equivalentes a \foreignlanguage.
%
%%%% PERSONALIZANDO CAPTIONS %%%%
%
% É possível personalizar os captions. Para versões de babel a partir
% de 3.51 (lançada em outubro de 2020), basta fazer
% \setlocalecaption{english}{contents}{Table of Contents}. Com versões
% anteriores, por razões históricas há dois mecanismos para fazer isso,
% então é preciso checar qual deve ser usado para cada língua (veja a
% documentação de babel ou faça um teste). São eles:
%
%   1. \renewcommand\spanishchaptername{Capítulo}
%
%   2. \addto\captionsenglish{\renewcommand\contentsname{Table of Contents}}
%      (este é o mais comum)
%
% Esses métodos valem também para a bibliografia, mas apenas se você
% estiver usando bibtex; com biblatex, é melhor usar o comando
% "\DefineBibliographyStrings" (veja a documentação de biblatex).
%
% Quando babel faz uma troca de língua, ele executa \extraslíngua e, se for
% necessário trocar os "captions", \captionslíngua (ou seja, os comandos
% acima modificam \captionslíngua). Então, se você quiser executar algo a
% mais quando uma língua é selecionada, faça \addto\extrasenglish{\blah}.
\RequirePackage{babel}
\RequirePackage{iflang}

% Por padrão, LaTeX utiliza maiúsculas no início de cada palavra nestas
% expressões ("Lista de Figuras"); vamos usar maiúsculas apenas na primeira
% palavra.
\addto\captionsbrazilian{%
  \renewcommand\listfigurename{Lista de figuras}%
  \renewcommand\listtablename{Lista de tabelas}%
  \renewcommand\indexname{Índice remissivo}%
}

% Alguns pacotes (tikz, siunitx) usam, além de babel, este pacote como
% auxiliar para a tradução de palavras-chave, como os meses do ano.
\RequirePackage{translator}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% FONTE %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% É possível usar várias famílias tipográficas diferentes em um único
% documento LaTeX, mas isso não é trivial. Algumas (poucas) packages
% fornecem comandos prontos para ativar uma família tipográfica a partir
% de seu nome, como "\carlito", mas esse tipo de recurso raramente é
% utilizado. Ao invés disso, LaTeX considera que, em geral, um documento
% precisa de apenas três estilos de letras genéricos, acionados pelos
% comandos abaixo:
%
% * \rmfamily e \textrm -> letras serifadas, para o corpo do texto. É o
%   padrão inicial do documento;
%
% * \sffamily e \textsf -> letras sem serifa, para títulos ou "entidades".
%   Por exemplo, "a classe \textsf{TimeManager} é responsável..." ou
%   "chamamos \textsf{primos} os números que...". Observe que em quase
%   todos os casos desse tipo é mais adequado usar negrito ou itálico;
%
% * \ttfamily e \texttt -> letras "teletype", para trechos de programas.
%
% LaTeX também carrega uma fonte específica, visualmente similar à fonte
% serifada, ao ativar o modo matemático.
%
% Por padrão, esses comandos selecionam fontes da família "Computer Modern"
% (veja abaixo), mas diversas packages os redefinem para carregar outras.
% Algumas dessas packages alteram apenas uma das quatro fontes, mas a
% maioria altera todas de uma vez, de maneira que o conjunto seja coerente.
% Então, se você quer simplesmente experimentar alguns tipos diferentes
% de letra para seu documento, consulte https://tug.org/FontCatalogue/ e
% utilize as packages correspondentes a cada uma. Se o sítio informa que
% a fonte está disponível *apenas* em formato OTF, use lualatex; se *não*
% está disponível em formato OTF, use pdflatex (lualatex também funciona,
% mas o resultado será inferior). Se está disponível em formato OTF e algum
% outro, você pode usar qualquer um dos dois. Para usar alguma outra fonte
% instalada em seu computador, use lualatex e leia a documentação da package
% fontspec.
%
% Você normalmente não precisa lidar com isso, mas pode ser útil saber:
% O mecanismo usado por LaTeX para gerir fontes é o NFSS (veja "texdoc
% fntguide"). NFSS funciona com todas as versões de LaTeX, mas só com fontes
% que foram adaptadas para funcionar com ele. LuaLaTeX e XeLaTeX estendem o
% NFSS: através da package fontspec, eles podem utilizar quaisquer fontes
% instaladas no computador e acessar diversos recursos tipográficos com mais
% facilidade. De maneira geral, se quiser fazer algo especial com as fontes
% do seu documento, atualmente não é mais necessário entender o NFSS; basta
% usar lualatex e seguir a documentação da package fontspec.


%%%%%%%%%% TUDO QUE VOCÊ NÃO QUERIA SABER SOBRE FONTENC %%%%%%%%%%
%
% Você só precisa ler este trecho se estiver curioso sobre isto :)
%
% Primeiro, terminologia: os diferentes tipos de letras (como Times, Arial,
% Comic Sans etc.) são chamados famílias tipográficas. Os arquivos que contêm
% as informações necessárias para o computador manipular os caracteres de
% uma família são chamados de fontes. É comum usar "fonte" para se referir
% à família tipográfica, mas aqui esta distinção é importante, como veremos
% a seguir.
%
% Fontes "tradicionais" (tanto as fontes originais de TeX quanto fontes
% PostScript Type 1 ou TrueType) são capazes de armazenar no máximo 256
% caracteres diferentes. Isso é um problema por duas razões:
%
%  1. Uma família tipográfica completa deve incluir, além dos caracteres em
%     sua forma "normal", versões em itálico, negrito, negrito + itálico,
%     versalete, versalete + itálico, versalete + negrito etc.
%
%  2. Existem muito mais de 256 caracteres: além dos números, letras latinas
%     maiúsculas e minúsculas, há caracteres gregos, cirílicos, árabes etc.
%
% Os dois problemas são resolvidos da mesma forma: usamos vários arquivos
% (fontes) para uma mesma família tipográfica. Para o primeiro problema,
% criamos uma fonte separada para cada variação no formato dos caracteres;
% Para o segundo problema, criamos uma fonte separada para cada subconjunto
% de caracteres que atendem um determinado sistema de escrita (por exemplo,
% o alfabeto latino). Note que isso significa que alguns caracteres, como
% os números arábicos, são repetidos em algumas fontes por serem usados em
% mais de um sistema de escrita. Note também que uma dada família pode
% não incluir caracteres em negrito e, portanto, não incluir a fonte
% correspondente. Da mesma forma, uma família pode não incluir caracteres
% cirílicos e, portanto, não incluir a fonte correspondente (na prática,
% a maioria das famílias tipográficas incluem suporte a apenas um sistema
% de escrita).
%
% Há um conjunto de padrões que determinam quais são os caracteres que
% devem ser incluídos em cada fonte de acordo com o sistema de escrita
% desejado: são os "character encodings". Por exemplo, as fontes com o
% alfabeto latino (as mais usadas no Brasil, EUA e Europa ocidental)
% usam o "character encoding" ISO-8859-1 (ou similares, como "latin1",
% "Windows-1252" e "ECMA-94"); outras línguas e regiões utilizam outros
% padrões. Mas TeX nasceu antes que esses padrões fossem definidos e,
% portanto, criou seus próprios padrões (encodings). O resultado é que,
% obviamente, os encodings de LaTeX são incompatíveis com os demais.
% Por essa razão, LaTeX tradicionalmente não era capaz de usar fontes
% "comuns"; elas precisavam ser adaptadas para funcionar com LaTeX (como
% veremos abaixo, isso mudou com XeLaTeX/luaLaTeX).
%
% LaTeX chama de "fontenc" os "character encodings" de cada fonte. As
% fontes mais comumente usadas hoje para o alfabeto latino usam o fontenc
% "T1". Por padrão, LaTeX "entende" os fontenc's T1 e OT1, mas é possível
% carregar outros (para línguas como cirílico ou árabe) com a package
% fontenc. Além de acrescentar fontenc's, a package também define qual
% deles é o padrão (o último da lista). Diferentemente de outras, essa
% package pode ser chamada mais de uma vez com parâmetros diferentes para
% carregar mais fontenc's ou para alterar o fontenc default. Esse default
% é importante porque, quando uma família tipográfica oferece fontes com
% diferentes fontenc's, o default determina qual delas deverá ser usada no
% documento. Sem a package fontenc, o default é OT1, mas esse fontenc não é
% recomendado porque ele só dá suporte de fato a 128 caracteres; caracteres
% acentuados são construídos sobrescrevendo um caracter "acento" sobre
% o caracter da letra, com resultados visualmente pobres. Assim, quando
% estiver usando pdflatex, sempre utilize o fontenc T1.
%
% "Character encodings" são usados para outros fins além da codificação
% dos caracteres em fontes e são fundamentais para línguas diferentes do
% inglês, mas acabam gerando problemas de compatibilidade. Por conta
% disso, surgiram o UTF-8 (um "character encoding" capaz de representar
% todos os caracteres possíveis) e o formato de fontes "OTF", capaz de
% armazenar 65.536 caracteres. XeLaTeX e luaLaTeX foram criados para
% tirar proveito desses avanços: ao usar uma fonte OTF, esses programas
% usam o fontenc "TU", que nada mais é que uma "cópia" do encoding padrão
% das fontes OTF que cobre todos os caracteres. Com isso, as fontes OTF
% disponíveis no sistema podem ser usadas diretamente, sem a necessidade
% de adaptações, e não é preciso carregar a package fontenc, porque
% fontspec já faz isso.
%
% E por que isso tudo é importante? Porque cada versão de LaTeX só é capaz
% de hifenizar palavras acentuadas corretamente com um fontenc específico:
% pdflatex, com fontenc T1; luaLaTeX e XeLaTeX, com fontenc TU. Assim,
% embora seja possível usar uma fonte com fontenc T1 e processar o documento
% com luaLaTeX, isso não é recomendado porque palavras acentuadas não serão
% hifenizadas (mas serão hifenizadas usando pdflatex). De maneira similar,
% o fontenc OT1, embora seja o default, não é recomendado.

\ifPDFTeX
  \RequirePackage[T1]{fontenc} % fontenc padrão recomendado para texto latino

  % O texto está escrito em utf8.
  % TODO: remover após ubuntu 18.04 se tornar obsoleta (abril/2023),
  %       veja o comentário em \NeedsTexFormat
  \RequirePackage[utf8]{inputenc}

  % Várias packages que definem as fontes do documento carregam fontaxes
  % porque ela oferece diversos recursos para a criação da package, mas
  % carregamos aqui porque, mesmo com fontes que não a usam diretamente,
  % ela permite utilizar small caps + itálico. Algumas raras packages de
  % fontes podem causar conflitos com fontaxes, em geral por utilizarem
  % a package "concorrente" nfssext-cfr.
  %
  % TODO A funcionalidade pela qual faz sentido carregar fontaxes aqui
  %      (small caps + itálico) foi incorporada ao kernel do LaTeX na
  %      versão 2020-02-02, então está em TeXLive 2021. Remover isto
  %      quando arxiv usar TeXLive >= 2021 e ubuntu 20.04 (focal) for
  %      descontinuada (abril de 2025). As packages que precisam de
  %      fontaxes por outras razões podem continuar a carregá-la sem
  %      problemas, mas não precisamos fazer isso aqui.
  \RequirePackage{fontaxes}

  % LaTeX substitui algumas sequências de caracteres, como "fi", "fl" e
  % outras, por caracteres especiais ("ligaduras"). Para que seja possível
  % fazer copiar/colar ou buscas por textos contendo essas ligaduras, o
  % arquivo PDF precisa conter uma tabela indicando quais são elas. Com
  % fontes OTF (LuaLaTeX ou XeLaTeX) isso não costuma ser um problema, mas
  % com pdfLaTeX pode ser. Estes dois comandos (que só existem no pdfLaTeX)
  % incluem uma tabela genérica que funciona para a maioria das fontes. Veja
  % a seção 5 de http://www.tug.org/TUGboat/Articles/tb29-1/tb91thanh-fonts.pdf
  % Note que alguns visualizadores de PDF tentam "adivinhar" o conteúdo da
  % tabela quando ela está incompleta ou não existe, então copiar/colar e
  % buscas podem funcionar em alguns visualizadores (não todos) mesmo sem
  % estes comandos.
  %
  % TODO Isto foi incluído no kernel do LaTeX versão 2021-06-01,
  %      então está em TeXLive 2022. Remover isto quando arxiv
  %      usar TeXLive >= 2022 e ubuntu 22.04 (jammy) for
  %      descontinuada (abril de 2027).
  \input glyphtounicode.tex
  \pdfgentounicode=1
\else
  % Não é preciso carregar inputenc com LuaTeX e XeTeX, pois
  % com eles utf8 é obrigatório.
  % TODO: remover este comentário ao remover inputenc acima

  % Com XeLaTeX e luaLaTeX, não é preciso usar a package fontenc; a package
  % fontspec carrega o fontenc TU (mencionado acima) automaticamente.
  \RequirePackage{fontspec}

  % Ao invés de usar o sistema tradicional de LaTeX para gerir as fontes
  % matemáticas, esta package faz LaTeX utilizar as extensões matemáticas
  % do formato otf definidas pela microsoft. Ao ativar esta package, o
  % mecanismo tradicional não funciona mais! Há poucas fontes com suporte
  % a unicode-math, então provavelmente *não* é uma boa ideia carregar
  % esta package aqui; melhor deixar que a package de fontes com suporte
  % a unicode-math faça isso, como é o caso da package libertinus. Mas
  % pode ser interessante ler a documentação desta package, já que ela
  % oferece algumas melhorias em relação ao sistema "tradicional" de LaTeX.
  %\RequirePackage{unicode-math}
\fi

% Acesso a símbolos adicionais, como \textrightarrow, \texteuro etc.,
% disponíveis na maioria das fontes através do fontenc TS1 ou mudando
% momentaneamente para computer modern/latin modern. Raramente útil
% com lualatex/xelatex, mas não causa problemas. Várias packages de
% fontes carregam textcomp, às vezes com opções específicas; assim,
% para evitar problemas, vamos carregá-la no final do preâmbulo para
% o caso de ela não ter sido carregada antes.
%
% TODO A funcionalidade oferecida por textcomp foi incorporada ao kernel
%      do LaTeX na versão 2020-02-02, então está em TeXLive 2021. Remover
%      isto quando arxiv usar TeXLive >= 2021 e ubuntu 20.04 (focal) for
%      descontinuada (abril de 2025). As packages que precisam de textcomp
%      podem continuar a carregá-la sem problemas, mas não precisamos fazer
%      isso aqui.
\AtBeginDocument{\usepackage{textcomp}}


% LaTeX usa por default a família de fontes "Computer Modern". Essas fontes
% precisaram ser re-criadas diversas vezes em formatos diferentes, então há
% diversas variantes dela. Com o fontenc OT1 (default "ruim" do LaTeX, como
% explicado mais acima), a versão usada é a BlueSky Computer Modern, que é
% de boa qualidade, mas com os problemas do OT1. Com fontenc T1 (padrão deste
% modelo e recomendado com pdfLaTeX), LaTeX usa o conjunto "cm-super". Com
% fontspec (ou seja, com LuaLaTeX e XeLaTeX), LaTeX utiliza a versão "Latin
% Modern". Versões diferentes dessas fontes foram recomendadas como sendo
% "a melhor" ao longo do tempo; atualmente, a recomendada é "Latin Modern",
% mesmo com pdflatex.

\ifPDFTeX
    % Usando pdfLaTeX

    % Ativa Latin Modern como a fonte padrão.
    \RequirePackage{lmodern}

    % Alguns truques para melhorar a aparência das fontes Latin Modern;
    % eles não funcionam com LuaLaTeX e XeLaTeX.

    % Latin Modern não tem fontes bold + Small Caps, mas cm-super sim;
    % assim, vamos ativar o suporte às fontes cm-super (sem ativá-las
    % como a fonte padrão do documento) e configurar substituições
    % automáticas para que a fonte Latin Modern seja substituída por
    % cm-super quando o texto for bold + Small Caps.
    \RequirePackage{fix-cm}

    % Com Latin Modern, é preciso incluir substituições para o encoding TS1
    % também por conta dos números oldstyle, porque para inclui-los nas fontes
    % computer modern foi feita uma hack: os dígitos são declarados como sendo
    % os números itálicos da fonte matemática e, portanto, estão no encoding TS1.
    %
    % Primeiro forçamos o LaTeX a carregar a fonte Latin Modern (ou seja, ler
    % o arquivo que inclui "DeclareFontFamily") e, a seguir, definimos a
    % substituição
    \fontencoding{TS1}\fontfamily{lmr}\selectfont
    \DeclareFontShape{TS1}{lmr}{b}{sc}{<->ssub * cmr/bx/n}{}
    \DeclareFontShape{TS1}{lmr}{bx}{sc}{<->ssub * cmr/bx/n}{}

    \fontencoding{T1}\fontfamily{lmr}\selectfont
    \DeclareFontShape{T1}{lmr}{b}{sc}{<->ssub * cmr/bx/sc}{}
    \DeclareFontShape{T1}{lmr}{bx}{sc}{<->ssub * cmr/bx/sc}{}

    % Latin Modern não tem "small caps + itálico", mas tem "small caps + slanted";
    % vamos definir mais uma substituição aqui.
    \fontencoding{T1}\fontfamily{lmr}\selectfont % já feito acima, mas tudo bem
    \DeclareFontShape{T1}{lmr}{m}{scit}{<->ssub * lmr/m/scsl}{}
    \DeclareFontShape{T1}{lmr}{bx}{scit}{<->ssub * lmr/bx/scsl}{}

    % Se fizermos mudanças manuais na fonte Latin Modern, estes comandos podem
    % vir a ser úteis
    %\newcommand\lmodern{%
    %  \renewcommand{\oldstylenums}[1]{{\fontencoding{TS1}\selectfont ##1}}%
    %  \fontfamily{lmr}\selectfont%
    %}
    %
    %\DeclareRobustCommand\textlmodern[1]{%
    %  {\lmodern #1}%
    %}
\else
    % Com LuaLaTex e XeLaTeX, Latin Modern é a fonte padrão. Existem
    % diversas packages e "truques" para melhorar alguns aspectos de
    % Latin Modern, mas eles foram feitos para pdflatex (veja mais
    % acima). Assim, se você pretende usar Latin Modern como a fonte
    % padrão do documento, é melhor usar pdfLaTeX. Deve ser possível
    % implementar essas melhorias com fontspec também, mas este modelo
    % não faz isso, apenas ativamos Small Caps aqui.
    %
    % TODO: isso funciona automaticamente em versões recentes do LaTeX;
    %       Remover essa correção para LuaLaTeX e XeLaTeX quando arxiv
    %       usar TeXLive >= 2021 e ubuntu 20.04 (focal) for descontinuada
    %       (abril de 2025).

    \ifLuaTeX
      % Com LuaTeX, basta indicar o nome de cada fonte; para descobrir
      % o nome "certo", use o comando "otfinfo -i" e veja os itens
      % "preferred family" e "full name"
      \setmainfont{Latin Modern Roman}[
        SmallCapsFont = {LMRomanCaps10-Regular},
        ItalicFeatures = {
          SmallCapsFont = {LMRomanCaps10-Oblique},
        },
        SlantedFont = {LMRomanSlant10-Regular},
        SlantedFeatures = {
          SmallCapsFont = {LMRomanCaps10-Oblique},
          BoldFont = {LMRomanSlant10-Bold}
        },
      ]
    \fi

    \ifXeTeX
      % Com XeTeX, é preciso informar o nome do arquivo de cada fonte.
      \setmainfont{lmroman10-regular.otf}[
        SmallCapsFont = {lmromancaps10-regular.otf},
        ItalicFeatures = {
          SmallCapsFont = {lmromancaps10-oblique.otf},
        },
        SlantedFont = {lmromanslant10-regular.otf},
        SlantedFeatures = {
          SmallCapsFont = {lmromancaps10-oblique.otf},
          BoldFont = {lmromanslant10-bold.otf}
        },
      ]
    \fi
\fi

% É possível mudar apenas uma das fontes. Em particular, a fonte teletype
% da família Computer Modern foi criada para simular as impressoras dos
% anos 1970/1980. Sendo assim, ela é uma fonte (1) com serifas e (2) de
% espaçamento fixo. Hoje em dia, é mais comum usar fontes sem serifa para
% representar código-fonte. Além disso, ao imprimir, é comum adotar fontes
% que não são de espaçamento fixo para fazer caber mais caracteres em uma
% linha de texto. Algumas opções de fontes para esse fim:
%\usepackage{newtxtt} % Não funciona com fontspec (lualatex / xelatex)
%\usepackage{DejaVuSansMono}
% inconsolata é uma boa fonte, mas não tem variante itálico
%\ifPDFTeX
%  \usepackage[narrow]{inconsolata}
%\else
%  \setmonofont{inconsolatan}
%\fi
%\usepackage[scale=.85]{sourcecodepro}

% Ao invés da família Computer Modern, é possível usar outras como padrão.
% Uma ótima opção é a libertinus, similar (mas não igual) à Times mas com
% suporte a Small Caps e outras qualidades. A fonte teletype da família é
% serifada, então é melhor definir outra; a opção "mono=false" faz o pacote
% não carregar sua própria fonte, mantendo a escolha anterior.

%\usepackage[mono=false]{libertinus}
%% Com LuaLaTeX/XeLaTeX, Libertinus configura também
%% a fonte matemática; aqui só precisamos corrigir \mathit
%\ifLuaTeX
%  \setmathfontface\mathit{Libertinus Serif Italic}
%\fi
%\ifXeTeX
%  % O nome de arquivo da fonte mudou na versão 2019-04-04
%  \@ifpackagelater{libertinus-otf}{2019/04/03}
%      {\setmathfontface\mathit{LibertinusSerif-Italic.otf}}
%      {\setmathfontface\mathit{libertinusserif-italic.otf}}
%\fi
%
%\ifPDFTeX
%  % A família libertinus por padrão não define uma fonte matemática
%  % específica para pdfLaTeX; uma opção que funciona bem com ela:
%  %\usepackage[libertine]{newtxmath}
%  % Outra, provavelmente melhor:
%  \usepackage{libertinust1math}
%\fi

% Ativa apenas a fonte biolinum, que é a fonte sem serifa da família.
%\usepackage[sans]{libertinus}

% Também é possível usar a Times como padrão; nesse caso, a fonte
% sem serifa usualmente é a Helvetica. Mas provavelmente libertinus
% é uma opção melhor.
%\ifPDFTeX
%  \usepackage[helvratio=0.95,largesc]{newtxtext}
%  \usepackage{newtxtt} % Fonte teletype
%  \usepackage{newtxmath}
%\else
%  % Clone da fonte Times como fonte principal
%  \setmainfont{TeX Gyre Termes}
%  \setmathfont[Scale=MatchLowercase]{TeX Gyre Termes Math}
%  % TeX Gyre Termes Math tem um bug e não define o caracter
%  % \setminus; Vamos contornar esse problema usando apenas
%  % esse caracter da fonte STIX Two Math
%  \setmathfont[range=\setminus]{STIX Two Math}
%  % Clone da fonte Helvetica como fonte sem serifa
%  \setsansfont{TeX Gyre Heros}
%  % Clone da Courier como fonte teletype, mas provavelmente
%  % é melhor utilizar sourcecodepro
%  %\setmonofont{TeX Gyre Cursor}
%\fi

% Cochineal é outra opção de qualidade; ela define apenas a fonte
% com serifa.
%
% Com NFSS (recomendado no caso de cochineal):
%\usepackage{cochineal}
%\usepackage[cochineal,vvarbb]{newtxmath}
%\usepackage[cal=boondoxo]{mathalfa}
%
% Com fontspec (até a linha "setmathfontface..."):
%
%\setmainfont{Cochineal}[
%  Extension=.otf,
%  UprightFont=*-Roman,
%  ItalicFont=*-Italic,
%  BoldFont=*-Bold,
%  BoldItalicFont=*-BoldItalic,
%  %Numbers={Proportional,OldStyle},
%]
%
%\DeclareRobustCommand{\lfstyle}{\addfontfeatures{Numbers=Lining}}
%\DeclareTextFontCommand{\textlf}{\lfstyle}
%\DeclareRobustCommand{\tlfstyle}{\addfontfeatures{Numbers={Tabular,Lining}}}
%\DeclareTextFontCommand{\texttlf}{\tlfstyle}
%
%% Cochineal não tem uma fonte matemática; com fontspec, provavelmente
%% o melhor a fazer é usar libertinus.
%\setmathfont{Libertinus Math}
%\setmathfontface\mathit{Cochineal-Italic.otf}

% gentium inclui apenas uma fonte serifada, similar a Garamond, que busca
% cobrir todos os caracteres unicode
%\usepackage{gentium}

% LaTeX normalmente funciona com fontes que foram adaptadas para ele, ou
% seja, ele não usa as fontes padrão instaladas no sistema: para usar
% uma fonte é preciso ativar o pacote correspondente, como visto acima.
% É possível escapar dessa limitação e acessar as fontes padrão do sistema
% com XeTeX ou LuaTeX. Com eles, além dos pacotes de fontes "tradicionais",
% pode-se usar o pacote fontspec para usar fontes do sistema.
%\usepackage{fontspec}
%\setmainfont{DejaVu Serif}
%\setmainfont{Charis SIL}
%\setsansfont{DejaVu Sans}
%\setsansfont{Libertinus Sans}[Scale=1.1]
%\setmonofont{DejaVu Sans Mono}

% fontspec oferece vários recursos interessantes para manipular fontes.
% Por exemplo, Garamond é uma fonte clássica; a versão EBGaramond é muito
% boa, mas não possui versões bold e bold-italic; aqui, usamos
% CormorantGaramond ou Gentium para simular a versão bold.
%\setmainfont{EBGaramond12}[
%  Numbers        = {Lining,} ,
%  Scale          = MatchLowercase ,
%  UprightFont    = *-Regular ,
%  ItalicFont     = *-Italic ,
%  BoldFont       = gentiumbasic-bold ,
%  BoldItalicFont = gentiumbasic-bolditalic ,
%%  BoldFont       = CormorantGaramond Bold ,
%%  BoldItalicFont = CormorantGaramond Bold Italic ,
%]
%
%\newfontfamily\garamond{EBGaramond12}[
%  Numbers        = {Lining,} ,
%  Scale          = MatchLowercase ,
%  UprightFont    = *-Regular ,
%  ItalicFont     = *-Italic ,
%  BoldFont       = gentiumbasic-bold ,
%  BoldItalicFont = gentiumbasic-bolditalic ,
%%  BoldFont       = CormorantGaramond Bold ,
%%  BoldItalicFont = CormorantGaramond Bold Italic ,
%]

% Crimson tem Small Caps, mas o recurso é considerado "em construção".
% Vamos utilizar Gentium para Small Caps
%\setmainfont{Crimson}[
%  Numbers           = {Lining,} ,
%  Scale             = MatchLowercase ,
%  UprightFont       = *-Roman ,
%  ItalicFont        = *-Italic ,
%  BoldFont          = *-Bold ,
%  BoldItalicFont    = *-Bold Italic ,
%  SmallCapsFont     = Gentium Plus ,
%  SmallCapsFeatures = {Letters=SmallCaps} ,
%]
%
%\newfontfamily\crimson{Crimson}[
%  Numbers           = {Lining,} ,
%  Scale             = MatchLowercase ,
%  UprightFont       = *-Roman ,
%  ItalicFont        = *-Italic ,
%  BoldFont          = *-Bold ,
%  BoldItalicFont    = *-Bold Italic ,
%  SmallCapsFont     = Gentium Plus ,
%  SmallCapsFeatures = {Letters=SmallCaps} ,
%]

% Com o pacote fontspec, também é possível usar o comando "\fontspec" para
% selecionar uma fonte temporariamente, sem alterar as fontes-padrão do
% documento.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%% FIGURAS / FLOATS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% LaTeX escolhe automaticamente o "melhor" lugar para colocar cada float.
% Por padrão, ele tenta colocá-los no topo da página e depois no pé da
% página; se não tiver sucesso, vai para a página seguinte e recomeça.
% Se esse algoritmo não tiver sucesso "logo", LaTeX cria uma página só
% com floats. É possível modificar esse comportamento com as opções de
% posicionamento: "tp", por exemplo, instrui LaTeX a considerar apenas
% o topo da página ou uma página só de floats (ignorando o pé da página),
% e "htbp" o instrui para tentar "aqui" como a primeira opção. A ordem
% dessas opções não é relevante: dentre as opções disponíveis, LaTeX sempre
% tenta a ordem "aqui, topo, pé, página". Os pacotes "float" e "floatrow"
% acrescentam a opção "H", que significa "aqui, incondicionalmente". Nesse
% caso, a figura/tabela não é mais um float "de verdade" (já que o seu lugar
% é fixo) e seria possível carregar a imagem sem usar o float; a diferença
% é que, com floats, a numeração das figuras/tabelas funciona corretamente.
%
% A escolha do "melhor" lugar leva em conta os parâmetros abaixo, mas é
% possível ignorá-los com a opção de posicionamento "!". Dado que os
% valores default não são muito bons para floats "grandes" ou documentos
% com muitos floats, é muito comum usar "!" ou "H". No entanto, modificando
% estes parâmetros o algoritmo automático tende a funcionar melhor. Ainda
% assim, vale ler a discussão a respeito na seção "Limitações do LaTeX"
% deste modelo.

% Fração da página que pode ser ocupada por floats no topo. Default: 0.7
\renewcommand{\topfraction}{.8}
% Idem para documentos em colunas e floats que tomam as 2 colunas. Default: 0.7
%\renewcommand{\dbltopfraction}{.7}
% Fração da página que pode ser ocupada por floats no pé. Default: 0.3
%\renewcommand{\bottomfraction}{.3}
% Fração mínima da página que deve conter texto. Default: 0.2
%\renewcommand{\textfraction}{.2}
% Numa página só de floats, fração mínima que deve ser ocupada. Default: 0.5
% floatpagefraction *deve* ser menor que topfraction.
\renewcommand{\floatpagefraction}{.66}
% Idem para documentos em colunas e floats que tomam as 2 colunas. Default: 0.5
\renewcommand{\dblfloatpagefraction}{.66}
% Máximo de floats no topo da página. Default: 2
\setcounter{topnumber}{3}
% Idem para documentos em colunas e floats que tomam as 2 colunas. Default: 2
%\setcounter{dbltopnumber}{2}
% Máximo de floats no pé da página. Default: 1
\setcounter{bottomnumber}{2}
% Máximo de floats por página. Default: 3
\setcounter{totalnumber}{5}

% A package float é amplamente utilizada; ela permite definir novos tipos
% de float e também acrescenta a possibilidade de definir "H" como opção de
% posicionamento do float, que significa "aqui, incondicionalmente". No
% entanto, ela tem algumas fragilidades e não é atualizada desde 2001.
% floatrow é uma versão aprimorada e com mais recursos da package "float",
% mas também não é atualizada desde 2009. Aqui utilizamos alguns recursos
% disponibilizados por ambas e é possível escolher qual delas utilizar.
% Um dos principais recursos dessas packages é permitir a criação de novos
% tipos de float; veja o arquivo source-code.tex para um exemplo.
%\RequirePackage{float}
\RequirePackage{floatrow}

% Por padrão, LaTeX prefere colocar floats no topo da página que
% onde eles foram definidos; vamos mudar isso. Este comando depende
% do pacote "floatrow", carregado logo acima.
\floatplacement{table}{htbp}
\floatplacement{figure}{htbp}

% Em alguns casos, um float pode aparecer antes do local do texto em que
% foi definido (ou seja, no topo da página ao invés do meio da página).
% Esta package garante que floats (tabelas e figuras) só apareçam após
% o local no texto em que foram definidos; veja os detalhes em
% https://tex.stackexchange.com/a/297580 . Note que, se o float tem a
% opção "h", normalmente LaTeX *não* coloca o float no topo da página
% atual: se o float não pode ser colocado "here", ele é delegado para
% a página seguinte. Portanto, com a opção "h" flafter em geral não faz
% diferença.
\RequirePackage{flafter}

% Em documentos com duas colunas, floats normalmente são colocados como
% parte de uma das colunas. No entanto, é possível usar "\begin{figure*}"
% ou "\begin{table*}" para criar floats que ocupam as duas colunas. Floats
% "duplos" desse tipo têm algumas limitações:
%
% 1. Mesmo que haja espaço disponível na página atual, eles são sempre
%    inseridos na página seguinte ao lugar em que foram definidos (então
%    é comum defini-los antes do lugar "certo" para compensar isso)
%
% 2. Eles só podem aparecer no topo da página ou em uma página de floats,
%    ou seja, nunca "here" nem no pé da página.
%
% 3. Em alguns casos, eles podem aparecer fora da ordem em relação aos
%    demais floats do mesmo tipo (o que não acontece com floats "normais")
%
% Esta package:
%
% 1. Soluciona parcialmente o primeiro problema: floats "duplos" podem
%    aparecer na página em que são definidos se sua definição está contida
%    no texto da coluna da esquerda;
%
% 2. Soluciona o segundo problema: floats "duplos" podem aparecer tanto no
%    topo quanto no pé da página. Observe que eles *não* podem aparecer
%    "here" porque isso não faz sentido: a figura interromperia o fluxo
%    do texto da "outra" coluna (ainda assim, as packages midfloat e cuted
%    permitem fazer isso).
%
% 3. Soluciona o terceiro problema.
\RequirePackage{stfloats}

% Permite importar figuras. LaTeX "tradicional" só é capaz de trabalhar com
% figuras EPS; hoje em dia não há nenhuma boa razão para usar essa versão.
% Já pdfTeX, XeTeX e LuaTeX podem usar figuras nos formatos PDF, JPG e PNG.
% Em algumas instalações, essas versões conseguem converter automaticamente
% arquivos EPS para PDF, mas não isso é garantido, então é melhor evitar o
% formato EPS.
\RequirePackage{graphicx}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% BIBLIOGRAFIA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Tradicionalmente, bibliografias no LaTeX são geradas com uma combinação entre
% LaTeX (muitas vezes usando o pacote natbib) e um programa auxiliar chamado
% bibtex. Nesse esquema, LaTeX e natbib são responsáveis por formatar as
% referências ao longo do texto e a formatação da bibliografia fica por conta
% do programa bibtex. A configuração dessa formatação é feita através de um
% arquivo auxiliar de "estilo", com extensão ".bst". Vários journals etc.
% fornecem o arquivo .bst que corresponde ao formato esperado da bibliografia.
%
% bibtex e natbib funcionam bem e, se você tiver alguma boa razão para usá-los,
% obterá bons resultados. No entanto, bibtex tem dois problemas: não lida
% corretamente com caracteres acentuados (embora, na prática, funcione com
% os caracteres usados em português) e o formato .bst, que define a formatação
% da bibliografia, é complexo e pouco flexível.
%
% Por conta disso, a comunidade está migrando para um novo sistema chamado
% biblatex. No biblatex, as formatações da bibliografia e das citações são
% feitas pelo próprio pacote biblatex, dentro do LaTeX. Assim, é bem mais fácil
% modificar e personalizar o estilo da bibliografia. biblatex usa o mesmo
% formato de arquivo de dados do bibtex (".bib") e, portanto, não é difícil
% migrar de um para o outro. biblatex também usa um programa auxiliar (biber),
% mas não para realizar a formatação da bibliografia. A maior desvantagem de
% biblatex é que ele é significativamente mais lento que bibtex.
%
% Observe que biblatex pode criar bibliografias independentes por capítulo
% ou outras divisões do texto. Normalmente é preciso indicar essas seções
% manualmente, mas as opções "refsection" e "refsegment" fazem biblatex
% identificar cada capítulo/seção/etc como uma nova divisão desse tipo.
% No entanto, refsection e refsegment são incompatíveis com o pacote
% titlesec, mencionado em imeusp-formatting.tex. Se você pretende criar
% bibliografias independentes por seções, há duas soluções: (1) desabilitar
% o pacote titlesec; (2) indicar as seções manualmente.
%
% Algumas dicas de configuração:
% https://tex.stackexchange.com/q/12806
% https://github.com/PaulStanley/biblatex-tutorial/releases

\PassOptionsToPackage{
  natbib=true, % Reconhece a sintaxe de natbib (\citet, \citep)
  hyperref=true, % Ativa o suporte ao pacote hyperref
  % Se um item da bibliografia tem língua definida (com langid), permite
  % hifenizar com base na língua selecionada.
  autolang=hyphen,
}{biblatex}

% Este arquivo é executado antes de carregarmos biblatex, então precisamos
% adiar a execução deste comando. Não carregamos biblatex neste arquivo
% porque o usuário pode querer modificar o estilo bibliográfico, que é
% definido por um parâmetro na hora da carga da package.
\AtEndPreamble{
  % TODO: remover menção ao bug de atendvi/hyperxmp em 2024
  % Impede que um item da bibliografia seja dividido em duas páginas.
  % À parte a estética, isso contorna este bug, que afeta links na
  % úlima página do trabalho, ou seja, pode afetar a bibliografia
  % (atenddvi pode ser carregada por hyperxmp):
  % https://github.com/ho-tex/atenddvi/issues/1
  \AtBeginBibliography{\interlinepenalty=10000\raggedbottom}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% HIPERLINKS E REFERÊNCIAS %%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% O comando \ref por padrão mostra apenas o número do elemento a que se
% refere; assim, é preciso escrever "veja a Figura~\ref{grafico}" ou
% "como visto na Seção~\ref{sec:introducao}". Usando o pacote hyperref
% (carregado mais abaixo), esse número é transformado em um hiperlink.
%
% Se você quiser mudar esse comportamento, ative as packages varioref
% e cleveref e também as linhas "labelformat" e "crefname" mais abaixo.
% Nesse caso, você deve escrever apenas "veja a \ref{grafico}" ou
% "como visto na \ref{sec:introducao}" etc. e o nome do elemento será
% gerado automaticamente como hiperlink.
%
% Se, além dessa mudança, você quiser usar os recursos de varioref ou
% cleveref, mantenha as linhas labelformat comentadas e use os comandos
% \vref ou \cref, conforme sua preferência, também sem indicar o nome do
% elemento, que é inserido automaticamente. Vale lembrar que o comando
% \vref de varioref pode causar problemas com hyperref, impedindo a
% geração do PDF final.
%
% ATENÇÃO: varioref, hyperref e cleveref devem ser carregadas nessa ordem!
%\RequirePackage{varioref}

%\labelformat{figure}{Figura~#1}
%\labelformat{table}{Tabela~#1}
%\labelformat{equation}{Equação~#1}
%% Isto não funciona corretamente com os apêndices; o comando seguinte
%% contorna esse problema
%%\labelformat{chapter}{Capítulo~#1}
%\labelformat{chapter}{\@chapapp~#1}
%\labelformat{section}{Seção~#1}
%\labelformat{subsection}{Seção~#1}
%\labelformat{subsubsection}{Seção~#1}

% Cria hiperlinks para capítulos, seções, \ref's, URLs etc.
\RequirePackage{hyperref}

\providetoggle{IMEcolorlinks}
\providetoggle{IMEhidelinks}
\newcommand\hidelinks{\toggletrue{IMEhidelinks}}
\newcommand\colorlinks{\toggletrue{IMEcolorlinks}}
\newcommand\nocolorlinks{\togglefalse{IMEcolorlinks}}
\colorlinks
\AtEndPreamble{
  \iftoggle{IMEhidelinks}
    {\hypersetup{hidelinks}}
    {
      \iftoggle{IMEcolorlinks}{
        \hypersetup{
          colorlinks=true, % também desabilita pdfborderstyle
          %citecolor=black,
          %linkcolor=black,
          %urlcolor=black,
          %filecolor=black,
          citecolor=DarkGreen,
          linkcolor=NavyBlue,
          urlcolor=DarkRed,
          filecolor=green,
          anchorcolor=black,
        }
      }{
        \hypersetup{
          colorlinks=false,
          pdfborder={0 0 .6},
          pdfborderstyle={/S/U/W .6},
          urlbordercolor=DodgerBlue,
          citebordercolor=green!30!white,
          linkbordercolor=blue!30!white,
          filebordercolor=green!30!white,
        }
      }
    }
}

%\RequirePackage[nameinlink,noabbrev,capitalise]{cleveref}
%% cleveref não tem tradução para o português
%\crefname{figure}{Figura}{Figuras}
%\crefname{table}{Tabela}{Tabelas}
%\crefname{chapter}{Capítulo}{Capítulos}
%\crefname{section}{Seção}{Seções}
%\crefname{subsection}{Seção}{Seções}
%\crefname{subsubsection}{Seção}{Seções}
%\crefname{appendix}{Apêndice}{Apêndices}
%\crefname{subappendix}{Apêndice}{Apêndices}
%\crefname{subsubappendix}{Apêndice}{Apêndices}
%\crefname{line}{Linha}{Linhas}
%\crefname{subfigure}{Figura}{Figuras}
%\crefname{equation}{Equação}{Equações}
%\crefname{listing}{Código-fonte}{Códigos-fonte}
%\crefname{lstlisting}{Código-fonte}{Códigos-fonte}
%\crefname{lstnumber}{Linha}{Linhas}
%\crefrangelabelformat{chapter}{#3#1#4~a~#5#2#6}
%\crefrangelabelformat{section}{#3#1#4~a~#5#2#6}
%\newcommand{\crefrangeconjunction}{ e }
%\newcommand{\crefpairconjunction}{ e }
%\newcommand{\crefmiddleconjunction}{, }
%\newcommand{\creflastconjunction}{ e }
%\crefmultiformat{type}{first}{second}{middle}{last}
%\crefrangemultiformat{type}{first}{second}{middle}{last}

% Ao criar uma referência hyperref para um float, a referência aponta
% para o final do caption do float, o que não é muito bom. Este pacote
% faz a referência apontar para o início do float (é possível personalizar
% também). Esta package é incompatível com a classe beamer (usada para
% criar posters e apresentações).
\iftoggle{IMEbeamer}
  {}
  {\RequirePackage[all]{hypcap}}

% hyperref detecta url's definidas com \url que começam com "http" e
% "www" e cria links adequados. No entanto, quando a url não começa
% com essas strings (por exemplo, "usp.br"), hyperref considera que
% se trata de um link para um arquivo local. Isto força todas as
% \url's que não tem esquema definido a serem do tipo http.
\hyperbaseurl{http://}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% METADADOS XMP %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% XMP (eXtensible Metadata Platform) é um mecanismo proposto pela Adobe
% para a inclusão dos metadados de um documento no próprio documento.
% Esta package se integra com hyperref e não depende de praticamente
% nenhuma modificação em documentos que já utilizam os mecanismos de
% hyperref para a definição de metadados PDF. Ela deve ser carregada
% depois de hyperref mas antes de as opções relacionadas a metadados
% de hyperref serem definidas.

% HACK ALERT! As versões 5.5 e 5.6 de hyperxmp podem "confundir" latexmk,
% fazendo a compilação do documento entrar em um laço infinito. Essas
% versões, assim como a 5.7 que corrige o problema, foram incluídas no
% TeXLive durante o ano de 2020, ou seja, nem a primeira versão nem a
% última atualização de TeXLive 2020 são afetadas. Ainda assim, aqui
% contornamos o problema desabilitando o recurso relacionado (o cálculo
% automático de "byteCount", ou seja, do tamanho aproximado do documento).
% TODO: remover esse código após 2024. Ao mesmo tempo, também podemos
%       desabilitar a package letltxmacro, que é usada apenas aqui.
\ifPDFTeX
  \LetLtxMacro\HACKoldpdffilesize\pdffilesize
  \renewcommand\pdffilesize[1]{}
\fi
\RequirePackage{hyperxmp}
\ifPDFTeX
  \LetLtxMacro\pdffilesize\HACKoldpdffilesize
\fi

% HACK ALERT! hyperxmp usa atenddvi, que tem este bug:
% https://github.com/ho-tex/atenddvi/issues/1 . Aparentemente, ele não
% afeta xelatex (cf https://github.com/latex3/latex2e/issues/94 ), então
% só precisamos nos preocupar com pdflatex e lualatex. Com pdflatex,
% hyperxmp não deveria utilizar atenddvi, mas às vezes usa. Com lualatex,
% atenddvi parece também não ser necessária, pois hyperxmp não usa
% \special ou \write com lualatex. Então, vamos deixar hyperxmp carregar
% atenddvi mas (1) vamos impedi-la de funcionar e (2) vamos garantir que
% hyperxmp sempre use AtEndDocument com pdflatex e lualatex. Há ainda um
% outro truque para contornar esse problema na configuração da bibliografia,
% mas não podemos ter certeza de que apenas a bibliografia pode ser afetada
% por este bug.

% TODO: esse bug foi resolvido com o lançamento do LaTeX 2020-10-01, que
%       deve ser incluído no TeXlive 2021. Assim, provavelmente podemos
%       remover isto em abril/2025 (veja o comentário em \NeedsTeXFormat)
\ifXeTeX
\else
  \let\AtEndDvi@AtBeginShipout\relax
  \let\AtEndDvi@CheckImpl\relax
  \let\hyxmp@at@end\AtEndDocument
\fi

% Às vezes é necessário forçar quebras de linha no título para a capa, mas
% essas quebras não devem aparecer em outros lugares (especialmente nos
% metadados XMP). hyperref e hyperxmp removem essas quebras automaticamente,
% mas isso pode fazer duas palavras ficarem grudadas. Estas macros "apagam"
% esses comandos de maneira mais cuidadosa.

\ExplSyntaxOn

% Primeiro definimos a regex que vamos usar. O que estamos fazendo aqui é
% "(regex1)|(regex2)|(regex3)|(regex4)"
\regex_const:Nn \@IMEbreakRegex
  {
    ( \c{break} ) % Encontra "\break"
    |
    ( \c{newline} ) % Encontra "\newline"
    |
      % Isto encontra:
      % 1. A control sequence "\linebreak" -> "\c{linebreak}"
      % 2. Opcionalmente seguida de "[NÚMERO]" -> "( \s*\x{5B}\s*\d\s*\x{5D} )?"
    ( \c{linebreak} (\s*\x{5B}\s*\d\s*\x{5D})? )
    |
      % Isto encontra:
      % 1. A control sequence "\\" (quebra de linha) -> "\c{\\}"
      % 2. Optionalmente seguida de "[...]" -> "( \s*\x{5B}\s*...\s*\x{5D} )?"
      % 3. Onde "..." é qualquer dimensão TeX válida
      %    (veja o exemplo de regex em texdoc interface3)
    ( \c{\\}
      ( \s*\x{5B}\s*
          [\+\-]?(\d+|\d*\.\d+)\s*((?i)pt|in|[cem]m|ex|[bs]p|[dn]d|[pcn]c)
        \s*\x{5D}
      )?
    )
  }

\newcommand{\@IMEremoveLinebreaksEtc}[1]{
    % Primeiro, substitui todas as quebras de linha por espaços
    \regex_replace_all:NnN \@IMEbreakRegex {\ } #1

    % Depois elimina eventuais notas de rodapé
    \regex_replace_all:nnN {\s*\c{footnote}} {\c{@gobble}} #1
    \regex_replace_all:nnN {\s*\c{thanks}} {\c{@gobble}} #1

    % Depois transforma URLs em texto simples
    \regex_replace_all:nnN {\c{url}} {\c{@firstofone}} #1
    \regex_replace_all:nnN {\c{href}} {\c{@secondoftwo}} #1

    % Substitui \par (ou uma linha em branco) por um caractere de nova linha
    \regex_replace_all:nnN {\c{par}} {\n} #1

    % Depois elimina espaços repetidos
    \regex_replace_all:nnN {\h+} {\ } #1
    \regex_replace_all:nnN {\ \n} {\n} #1
    \regex_replace_all:nnN {\n+} {\n} #1
}

\ExplSyntaxOff

% Agora inserimos de fato os metadados essenciais XMP no arquivo PDF. Se
% o documento é uma tese/dissertação no formato do IME, outros metadados
% são definidos mais à frente e sobrescrevem o que está definido aqui.
\let\@cleantitle\@title
\let\@cleanauthor\@author
\@IMEremoveLinebreaksEtc{\@cleantitle}
\@IMEremoveLinebreaksEtc{\@cleanauthor} % pode incluir \thanks

\hypersetup{
  pdfauthor={\@cleanauthor},
  pdftitle={\@cleantitle},
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% UTILS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Você provavelmente vai querer ler a documentação de alguns destes pacotes
% para personalizar algum aspecto do trabalho ou usar algum recurso específico.

% Mais recursos para trechos de texto "puro" (texto em que tabs, quebras de
% linha etc. não são modificados), e também o ambiente "\begin{comment}".
\RequirePackage{verbatim}
%\RequirePackage{fvextra} % Ainda mais recursos adicionais para texto "puro"

% Às vezes um float pode ser adiado por muitas páginas; é possível forçar
% LaTeX a imprimir todos os floats pendentes com o comando \clearpage mas,
% para isso, o usuário deve identificar os casos problemáticos e inserir
% \clearpage manualmente. Esta package acrescenta o comando \FloatBarrier,
% que executa \clearpage apenas se necessário no local em que é chamado.
% "above" e "below" desabilitam a barreira quando os floats estão na mesma
% página. A desvantagem de placeins é que, para funcionar, ela gera quebras
% de página que muitas vezes são inesperadas; em muitos casos, é melhor
% fazer ajustes manualmente.
%\RequirePackage[above,below]{placeins}

% Às vezes é interessante utilizar uma imagem mais larga que o texto.
% Por padrão, \centering *não* vai centralizar a imagem corretamente
% nesse caso. Com esta package, podemos acrescentar a opção "center"
% ao comando \includegraphics para resolver esse problema:
% \noindent\includegraphics[width=1.2\textwidth,center]{imagem}.
% A package tem muitos outros recursos também.
\RequirePackage[export]{adjustbox}

% Define o ambiente "\begin{landscape} -- \end{landscape}"; o texto entre
% esses comandos é impresso em modo paisagem, podendo se estender por
% várias páginas. A rotação não inclui os cabeçalhos e rodapés das páginas.
% O principal uso desta package é em conjunto com a package longtable: se
% você precisa mostrar uma tabela muito larga (que precisa ser impressa em
% modo paisagem) e longa (que se estende por várias páginas), use
% "\begin{landscape}" e "\begin{longtable}" em conjunto. Note que o modo
% landscape entra em ação imediatamente, ou seja, "\begin{landscape}" gera
% uma quebra de página no local em que é chamado. Na maioria dos casos, o
% que se quer não é isso, mas sim um "float paisagem"; isso é o que a
% package rotating oferece (veja abaixo).
\RequirePackage{pdflscape}

% Define dois novos tipos de float: sidewaystable e sidewaysfigure, que
% imprimem a figura ou tabela sozinha em uma página em modo paisagem. Além
% disso, permite girar elementos na página de diversas outras maneiras.
\RequirePackage[figuresright,clockwise]{rotating}

% Sub-figuras (e seus captions) - observe que existe uma package chamada
% "subfigure", mas ela é obsoleta; use esta no seu lugar.
\RequirePackage{subcaption}

% Permite criar imagens com texto ao redor.
%\RequirePackage{wrapfig}
% Esta é similar, mas me parece uma opção melhor:
%\RequirePackage{cutwin}

% Permite incorporar um arquivo PDF como uma página adicional. Útil se
% for necessário importar uma imagem ou tabela muito grande ou ainda
% para definir uma capa personalizada.
\RequirePackage{pdfpages}

% Caixas de texto coloridas
%\RequirePackage{tcolorbox}

% LaTeX por padrão não permite notas de rodapé dentro de tabelas. De maneira
% geral, notas de rodapé em tabelas são consideradas "ruins" em termos de
% tipografia, mas às vezes são necessárias. Se esse é o caso, o recomendado
% é que as notas de rodapé apareçam no "rodapé" da tabela, com numeração
% própria, e não no rodapé da página. Você pode fazer isso com esta package:
\RequirePackage{threeparttable}
% Formatação personalizada das notas de threeparttable:
\appto{\TPTnoteSettings}{\footnotesize\itshape}
\def\TPTtagStyle{\textit}
% Outra opção é a package ctable, que ainda oferece vários outros
% recursos mas usa uma sintaxe diferente.
%\RequirePackage{ctable}

% Se você realmente quer notas de rodapé em tabelas que aparecem como as
% demais notas de rodapé (no final da página e mantendo a sequência numérica),
% você pode usar a package abaixo. No entanto, ela não funciona com floats
% duplos (floats que ocupam toda a largura da página em um documento de duas
% colunas) e, em alguns casos, a nota pode desaparecer ou aparecer em uma
% página diferente da tabela (mova o lugar do texto em que ela é definida
% para resolver esse problema).
\RequirePackage{tablefootnote}

% Por padrão, cada coluna de uma tabela tem a largura do maior texto contido
% nela, ou seja, se uma coluna contém uma célula muito larga, LaTeX não
% força nenhuma quebra de linha e a tabela "estoura" a largura do papel. A
% solução simples, nesses casos, é inserir uma ou mais quebras de linha
% manualmente, o que além de deselegante não é totalmente trivial (é preciso
% usar \makecell).
% Esta package estende o ambiente tabular para permitir definir um tamanho
% fixo para uma ou mais colunas; nesse caso, LaTeX quebra as linhas se uma
% célula é larga demais para a largura definida. array também traz algumas
% outras melhorias para tabelas e é praticamente obrigatória.
%
% Encontrar valores "bons" % para as larguras das colunas é um trabalho
% manual um tanto penoso. As packages tabularx e tabulary permitem configurar
% algumas colunas como "largura automática", evitando a necessidade da
% definição manual. Finalmente, ltxtable permite utilizar tabularx e
% longtable juntas. Neste modelo, não usamos tabularx/tabulary, mas você
% pode carregá-las se quiser.
\RequirePackage{array}

% Permite alinhar os elementos de uma coluna pelo ponto decimal; dê
% preferência à package siunitx (carregada mais abaixo), que também
% oferece esse recurso e muitos outros.
%\RequirePackage{dcolumn}

% Define tabelas do tipo "longtable", similares a "tabular" mas que podem ser
% divididas em várias páginas. "longtable" também funciona corretamente com
% notas de rodapé. Note que, como uma longtable pode se estender por várias
% páginas, não faz sentido colocá-las em um float "table". Por conta disso,
% longtable define o comando "\caption" internamente.
\RequirePackage{longtable}

% Permite agregar linhas de tabelas, fazendo colunas "compridas".
\RequirePackage{multirow}

% Cria comando adicional para possibilitar a inserção de quebras de linha
% em uma célula de tabela, entre outros.
\RequirePackage{makecell}

% Modifica (melhora) o layout default das tabelas e acrescenta os comandos
% \toprule, \bottomrule, \midrule e \cmidrule. Vale muito a pena ler a
% documentação desta package! Como ela realiza medições usando o tamanho
% da fonte do documento, carregamos ao final do preâmbulo, quando a fonte
% correta já foi configurada.
\AtEndPreamble{\RequirePackage{booktabs}}

% Permite colorir linhas, colunas ou células de uma tabela.
\RequirePackage{colortbl}

% Ao invés de digitar os dados de uma tabela dentro do seu documento,
% você pode fazer LaTeX ler os dados de um arquivo CSV e criar uma
% tabela automaticamente com uma destas duas packages:
%\RequirePackage{csvsimple}     % mais simples
%\RequirePackage{pgfplotstable} % mais complexa

% Você também pode se interessar pelo ambiente "tabbing", que permite
% criar tabelas simples com algumas vantagens em relação a "tabular",
% ou por esta package, que permite criar tabulações.
%\RequirePackage{tabto}


\iftoggle{IMEappearance}
  {
    % Formato personalizado para as notas de rodapé. Copiado quase
    % literalmente do exemplo na documentação das classes-padrão de
    % LaTeX2e (texdoc classes). Seria possível fazer algo similar
    % usando list{} com um único item usando \@thefnmark como label.

    % \footnotesep não é um espaço adicional, mas sim um strut que
    % existe no começo de cada nota. É por isso que o valor é "grande"
    % (\baselineskip) mas a separação de fato é pequena.

    \renewcommand\@makefntext[1]{%
        \setlength{\footnotesep}{1\baselineskip}%
        \@setpar{%
            \@@par
            \@tempdima = \hsize
            \advance\@tempdima-4pt\relax
            \parshape \@ne 4pt \@tempdima
        }%
        \par
        \parindent 1em\noindent
        \parskip .3\baselineskip
        \hbox to \z@{\hss\@makefnmark\,}#1%
    }

    % \maketitle redefine as notas de rodapé (\thanks) para usar símbolos
    % ao invés de números, mas essa não é a única mudança. \maketitle
    % também muda \@makefnmark para que a indicação de nota de rodapé
    % não ocupe espaço horizontal (isso é feito com \rlap). Isso é feito
    % porque a lista de autores em geral é similar a
    % \author{Fulano\thanks{instituição 1}, Ciclano\thanks{instituição 2}}.
    % Com essa mudança, a nota aparece acima da vírgula entre os autores.
    % Mas isso significa que\maketitle precisa também modificar \@makefntext
    % para que esse efeito aconteça apenas na lista de autores e não na
    % nota em si. Assim, como criamos um novo formato para as notas de
    % rodapé, precisamos mudar o formato em \maketitle também.

    \newcommand\@maketitlemakefntext[1]{%
        \setlength{\footnotesep}{1\baselineskip}%
        \@setpar{%
            \@@par
            \@tempdima = \hsize
            \advance\@tempdima-4pt\relax
            \parshape \@ne 4pt \@tempdima
        }%
        \par
        \parindent 1em\noindent
        \parskip .3\baselineskip
        \hbox to \z@{\hss\@textsuperscript{\normalfont\@thefnmark}\,}#1%
    }

    \patchcmd\maketitle
      {\long\def\@makefntext}
      {\let\@makefntext\@maketitlemakefntext\long\def\@disabledmakefntext}
      {}{}

  }
  {}

% melhorias e recursos adicionais para o modo matemático; leia a documentação
\RequirePackage{mathtools}

% Permite mostrar itens "cancelados" em fórmulas matemáticas, como:
% 2a = 2(b+1)
% \cancel{2}a = \cancel{2}(b+1)
% a = b+1
\RequirePackage{cancel}

% Para inserir separações no texto que não correspondem a seções com um nome
% definido, é comum usar um ornamento ou florão (em inglês e francês: fleuron).
% Esta package define o comando \froufrou que insere um florão desse tipo.
\RequirePackage{froufrou}

% Símbolos adicionais: \degree, \celsius, \ohm, \micro, \perthousand.
% Provavelmente é melhor usar os recursos da package siunitx.
%\RequirePackage{gensymb}

% Permite criar listas como glossários, listas de abreviaturas etc.
% https://en.wikibooks.org/wiki/LaTeX/Glossary
%\RequirePackage{glossaries}

% Permite formatar um trecho de texto em colunas.
\RequirePackage{multicol}

% O formato pdf permite anexar arquivos ao documento, que aparecem
% na página como ícones "clicáveis"; esta package implementa esse
% recurso em LaTeX.
%\RequirePackage{attachfile}

% Citações melhores; se você pretende fazer citações de textos
% relativamente extensos, vale a pena ler a documentação. biblatex
% utiliza recursos deste pacote.
\RequirePackage{csquotes}

% Sublinhado e outras formas de realce de texto.
\RequirePackage{soul}
\RequirePackage{soulutf8}

% Melhorias e personalização do sublinhado com soul (comando \ul)

% Distância e largura do sublinhado
\setul{1.4pt}{.5pt}

% btul -> "Better Underline" (https://alexwlchan.net/2017/10/latex-underlines/ )
% Sublinhado sem cruzar as linhas descendentes dos caracteres
\RequirePackage[outline]{contour}
\contourlength{1.1pt}
\newcommand{\btul}[2][white]{%
  \contourlength{1.1pt}%
  \setul{1.4pt}{.5pt}%
  \ul{{\phantom{#2}}}% Faz o sublinhado; precisa das chaves adicionais!
  \llap{\contour{#1}{#2}}% Escreve o texto com fundo branco/colorido
}

% Formatação personalizada das listas "itemize", "enumerate" e
% "description", além de permitir criar novos tipos de listas.
% Com a opção "inline", a package define os novos ambientes "itemize*",
% "description*" e "enumerate*", que fazem os itens da lista como
% parte de um único parágrafo. Como ela causa problemas com
% beamer, apenas a carregamos se não estivermos usando beamer.
\iftoggle{IMEbeamer}
  {}
  {\RequirePackage[inline]{enumitem}}

% TODO: siunitx removed option "binary-units" in 2021;
%       we can remove this option here after, say, 2025.
% Vários recursos para apresentação de números e grandezas (unidades, notação
% científica, melhor apresentação de números longos etc.), além de permitir
% alinhar números em tabelas pelo ponto decimal (como a package dcolumn)
% através do tipo de coluna "S". Por exemplo, \si{\ohm}, \si{\celsius},
% \si{\milli\litre} (apenas as unidades) ou \SI{10}{\hertz} (a grandeza e a
% unidade), ou \num[round-mode=places,round-precision=4]{3.1415926} -> 3,1416.

\RequirePackage[binary-units]{siunitx}
\sisetup{
  mode=text,
  round-mode=places,
}

% siunitx usa a package translator para apresentar estas expressões na
% língua do documento; vamos fornecer as traduções para o português.
\providetranslation[to=Portuguese]{to (numerical range)}{a}
\providetranslation[to=Portuguese]{and}{e}
\addto\extrasbrazil{\sisetup{output-decimal-marker = {,}}}
\addto\extrasbrazilian{\sisetup{output-decimal-marker = {,}}}

% Este comando é definido pela package url, que é carregada automaticamente
% por hyperref; ele faz URLs com fonte sem serifa ao invés de teletype
\iftoggle{IMEappearance}
  {\urlstyle{sf}}
  {}

% Permite inserir comentários, muito bom durante a escrita do texto;
% você também pode se interessar pela package pdfcomment.
\RequirePackage[textsize=scriptsize,colorinlistoftodos,textwidth=2.5cm]{todonotes}
\presetkeys{todonotes}{color=orange!40!white}{}

% Comando para fazer notas com highlight no texto correspondente:
% \hltodo[texto][opções]{comentário}
\if@todonotes@disabled
  \NewDocumentCommand{\hltodo}{O{} O{} +m}{#1}
\else
  \NewDocumentCommand{\hltodo}{O{} O{} +m}{
    \ifstrempty{#1}{}{\texthl{#1}}%
    \todo[#2]{#3}{}%
  }
\fi

% Vamos reduzir o espaçamento entre linhas nas notas/comentários
\xpatchcmd{\@todo}
  {\renewcommand{\@todonotes@text}{#2}}
  {\renewcommand{\@todonotes@text}{\begin{spacing}{0.5}#2\end{spacing}}}
  {}
  {}

% Outras ferramentas que podem ser úteis durante a preparação do texto:

% Faz LaTeX mostrar um traço ao lado de linhas "overfull".
%\overfullrule=1mm

% Faz LaTeX mostrar labels e referências bibliográficas:
%\RequirePackage{showkeys}

% Faz LaTeX mostrar linhas e traços indicando espaçamento, kerning etc.
% Funciona apenas com lualatex.
%\RequirePackage{lua-visual-debug}

% Além disso, o programa checkcites, instalado juntamente com LaTeX,
% indica problemas com citações bibliográficas.

% Gantt charts; útil para fazer o cronograma para o exame de
% qualificação, por exemplo.
\RequirePackage{pgfgantt}

% Estes parâmetros definem a aparência das gantt charts e variam
% em função da fonte do documento.
\iftoggle{IMEappearance}
  {
    \ganttset{
        vgrid,
        x unit=1.7em,
        y unit title=3ex,
        y unit chart=4ex,
        % O "strut" é necessário para alinhar o baseline dos nomes dos meses
        title label font=\strut\footnotesize,
        group label font=\footnotesize\bfseries,
        bar label font=\footnotesize,
        milestone label font=\footnotesize\itshape,
        % "align=right" é necessário para \ganttalignnewline funcionar
        group label node/.append style={align=right},
        bar label node/.append style={align=right},
        milestone label node/.append style={align=right},
        group incomplete/.append style={fill=black!50},
        bar/.append style={fill=black!25,draw=black},
        bar incomplete/.append style={fill=white,draw=black},
        % Não é preciso imprimir "0%"
        progress label text=\ifnumequal{#1}{0}{}{(#1\%)},
        % Formato e tamanho dos elementos
        title height=.9,
        group top shift=.4,
        group left shift=0,
        group right shift=0,
        group peaks tip position=0,
        group peaks width=.2,
        group peaks height=.3,
        milestone height=.4,
        milestone top shift=.4,
        milestone left shift=.8,
        milestone right shift=.2,
    }
  }
  {}

% Em inglês, tanto o nome completo quanto a abreviação do mês de maio
% são "May"; por conta disso, na tradução em português LaTeX erra a
% abreviação. Como talvez usemos o nome inteiro do mês em outro lugar,
% ao invés de forçar a tradução para "Mai" globalmente, fazemos isso
% apenas em ganttchart.
\AtBeginEnvironment{ganttchart}{\deftranslation[to=Portuguese]{May}{Mai}}

% Ilustrações, diagramas, gráficos etc. criados diretamente em LaTeX.
% Também é útil se você quiser importar gráficos gerados com GnuPlot.
\RequirePackage{tikz}

% Gráficos gerados diretamente em LaTeX; é possível usar tikz para
% isso também.
\RequirePackage{pgfplots}
% sobre níveis de compatibilidade do pgfplots, veja
% https://tex.stackexchange.com/a/81912
%\pgfplotsset{compat=1.14} % TeXLive 2016
%\pgfplotsset{compat=1.15} % TeXLive 2017
%\pgfplotsset{compat=1.16} % TeXLive 2019
\pgfplotsset{compat=newest}

% Importação direta de arquivos gerados por gnuplot com o
% driver/terminal "lua tikz"; esta package não faz parte da
% instalação padrão do LaTeX, mas sim do gnuplot.
%\RequirePackage{gnuplot-lua-tikz}

% Notas de rodapé "órfãs", ou seja, textos que aparecem junto
% das notas de rodapé mas que não têm referência em nenhum lugar.
% "0" desabilita o marcador porque não existe o 0-ésimo símbolo.
\newcommand\detachedfootnote[1]{%
    \bgroup
    \renewcommand\thefootnote{\fnsymbol{footnote}}%
    \renewcommand\thempfootnote{\fnsymbol{mpfootnote}}%
    \footnotetext[0]{#1}%
    \egroup
}

% Os comandos \TeX e \LaTeX são nativos do LaTeX; esta package acrescenta
% comandos para vários outros logos da família TeX. Você provavelmente não
% precisa desse recurso e, portanto, pode removê-la.
\RequirePackage{hologo}
\providecommand{\XeLaTeX}{\hologo{XeLaTeX}}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%% CABEÇALHOS E RODAPÉS (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}
  {
    % Permite saber o número total de páginas; útil para colocar no
    % rodapé algo como "página 3 de 10" com "\thepage\ de \zpageref{LastPage}"
    %\usepackage{zref-lastpage,zref-user}

    % Permite definir cabeçalhos e rodapés
    \usepackage{fancyhdr}

    % A formatação dos cabeçalhos/rodapés envolve duas coisas:
    %
    % 1. Definir qual texto deve ser impresso em cada página (nome
    %    do capítulo ou seção, nome do autor, número da página etc.)
    %
    % 2. Imprimir esse texto no lugar correto (esquerda, direita ou
    %    centro, cabeçalho ou rodapé)
    %
    % A definição do texto a imprimir é complexa, pois a preparação dos
    % cabeçalhos/rodapés acontece de maneira independente da construção do
    % restante da página. Textos fixos como, digamos, o nome do livro ou
    % do seu autor, não trazem dificuldades. Já textos variáveis, como o
    % nome do capítulo ou seção, o número da página etc. envolvem a
    % passagem de informações sobre a página atual para o mecanismo de
    % construção dos cabeçalhos.
    %
    % Isso é feito através de "variáveis" especiais chamadas "marks". O uso
    % mais comum das marks é armazenar o nome do capítulo e da seção atuais:
    % a cada novo capítulo ou seção, os comandos \chaptermark e \sectionmark
    % são executados (isso é automático, você não precisa fazer nada); esses
    % comandos definem uma "mark" com o nome do capítulo/seção a ser usado
    % nos cabeçalhos/rodapés. Assim, modificando a definição dos comandos
    % \chaptermark e \sectionmark, é possível modificar o texto a ser
    % incluído nos cabeçalhos/rodapés.
    %
    % Definido o conteúdo das marks, o lugar em que cada texto é impresso
    % é definido com os comandos \fancyhead e \fancyfoot. "RO" significa
    % "Right side of Odd pages"; "LE" significa "Left side of Even pages" etc.
    %
    % LaTeX por padrão tem duas "marks": "\leftmark" e "\rightmark". Elas
    % têm esses nomes porque originalmente eram usadas para armazenar o
    % conteúdo a ser impresso nas páginas pares e ímpares. Isso, no entanto,
    % não é obrigatório; a escolha desses nomes foi bastante infeliz. Para
    % definir o conteúdo dessas marks, usam-se os comandos \markboth{A}{B}
    % (define \leftmark como A e \rightmark como B) e \markright{C} (define
    % \rightmark como C). Não há o comando \markleft.
    %
    % O procedimento de definição dos cabeçalhos e rodapés, portanto, envolve:
    %
    % 1. Redefinir \chaptermark e \sectionmark (ambas recebem um parâmetro,
    %    que é o nome do capítulo/seção) para fazê-los executar \markboth e
    %    \markright, inserindo o conteúdo desejado nas marks;
    %
    % 2. Usar \fancyhead e \fancyfoot para definir os cabeçalhos e rodapés
    %    usando o conteúdo de \leftmark e \rightmark.
    %
    % Além das marks, é possível usar também as variáveis \thepage (número
    % da página), \thechapter (número do capítulo) e \thesection (número da
    % seção).
    %
    % Neste modelo, modificamos chaptermark e sectionmark para armazenar
    % o número e nome do capítulo em leftmark e o número e nome da seção
    % em rightmark. MAS imprimimos rightmark nas páginas pares (esquerda)
    % e leftmark nas páginas ímpares (direita)!
    %%%%%%%%%%

    % Sem linha separando o cabeçalho
    \renewcommand{\headrulewidth}{0pt}

    % Queremos colocar o número da página mais próximo da borda do papel (na
    % horizontal). Para isso, vamos aumentar \headwidth, somando "tamanho da
    % margem direita -10mm" (o número vai ficar a 10mm da borda).
    %
    % Observe que a package geometry define \evensidemargin, mas seu valor não
    % necessariamente corresponde ao que queremos aqui (não sei bem como nem
    % por que geometry define esse valor). Ao invés de usá-lo, vamos calcular
    % manualmente.
    %
    % A distância entre a borda esquerda/interna do papel e o início do texto
    % é dada por (1in + \hoffset + \oddsidemargin); a margem direita, portanto,
    % é dada por (\paperwidth - (1in + \hoffset + \oddsidemargin + \textwidth)).
    \dimdef{\othermargin}{\paperwidth - 1in - \hoffset - \oddsidemargin - \textwidth}
    \addtolength{\headwidth}{\othermargin}
    \addtolength{\headwidth}{-10mm}

    \newcommand{\formataNumPaginas}{
      \fancyhead[RO]{\raisebox{8mm}{\footnotesize\bfseries\thepage}}
      \fancyhead[LE]{\raisebox{8mm}{\footnotesize\bfseries\thepage}}
    }

    \newcommand{\formataCabecalhosDinamicos}{
      \fancyhead[LO]{\scriptsize\MakeTextUppercase{\rightmark}}
      \fancyhead[RE]{\scriptsize\MakeTextUppercase{\leftmark}}
    }

    \fancypagestyle{mainmatter}{
      % Número e nome do capítulo no cabeçalho das páginas pares
      % (e nas ímpares quando não há seções)
      \renewcommand{\chaptermark}[1]{
        \markboth
          {\thechapter\hskip 0.3em |\hskip 0.3em ##1}
          {\thechapter\hskip 0.3em |\hskip 0.3em ##1}
      }

      % Número e nome da seção no cabeçalho das páginas ímpares
      \renewcommand{\sectionmark}[1]{
        \markright{\thesection\hskip 0.3em |\hskip 0.3em ##1}
      }

      \fancyhf{}
      \formataNumPaginas{}
      \formataCabecalhosDinamicos{}
    }

    % Formato para capítulos não-numerados mas que devem
    % aparecer no sumário (tipicamente, a introdução):
    \fancypagestyle{onlynames}{
      % Só o nome do capítulo/seção, sem numeração
      \renewcommand{\chaptermark}[1]{\markboth{##1}{##1}}
      \renewcommand{\sectionmark}[1]{\markright{##1}}

      \fancyhf{}
      \formataNumPaginas{}
      \formataCabecalhosDinamicos{}
    }

    \fancypagestyle{appendix}{
      \renewcommand{\chaptermark}[1]{%
        \markboth{%
          % Páginas ímpares: "Apêndice/Anexo X"
          \@chapapp\ \thechapter%
        }{%
          % Páginas pares: "X | nome do apêndice/anexo"
          \thechapter\hskip 0.3em |\hskip 0.3em ##1%
        }
      }

      \fancyhf{}
      \formataNumPaginas{}
      \formataCabecalhosDinamicos{}
    }

    % Na frontmatter e backmatter, não há números de capítulos e (em geral)
    % não há subdivisões (capítulos/seções/subseções), apenas um nível.
    % O correto, então, é usar o mesmo texto (nome do capítulo ou seção,
    % sem número) nas páginas pares ou ímpares.
    %
    % Normalmente, a bibliografia e o índice remissivo não definem os
    % cabeçalhos (não executam "chaptermark/sectionmark"), mas "forçamos"
    % isso manualmente (em bibconfig.tex e index.tex).
    \fancypagestyle{backmatter}{
      \renewcommand{\chaptermark}[1]{\markboth{##1}{##1}}
      \renewcommand{\sectionmark}[1]{\markboth{##1}{##1}}

      \fancyhf{}
      \formataNumPaginas{}
      \formataCabecalhosDinamicos{}
    }

    % A página inicial de cada capítulo é automaticamente configurada para o estilo
    % "plain", então vamos definir esse estilo (colocando o número de página no
    % mesmo lugar das demais). As páginas iniciais também usam esse estilo.
    \fancypagestyle{plain}{
      \fancyhf{}
      \formataNumPaginas{}
    }
  }
  {}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% SUMÁRIO (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}
  {
    % biblatex pode ser configurado para inserir a bibliografia no sumário;
    % bibtex não oferece essa possibilidade. Com esta package, resolvemos
    % esse problema.
    \usepackage[nottoc,notlot,notlof]{tocbibind}

    % Só olha até o nível 2 (subseções) para gerar o sumário e os
    % cabeçalhos, ou seja, não coloca nomes de subsubseções (nível 3)
    % no sumário nem nos cabeçalhos.
    \setcounter{tocdepth}{2}

    % Só numera até o nível 2 (subseções, como 2.3.1), ou seja, não numera
    % sub-subseções (como 2.3.1.1). Veja que isso afeta referências
    % cruzadas: se você fizer \ref{uma-sub-subsecao} sem que ela seja
    % numerada, a referência vai apontar para a seção um nível acima.
    \setcounter{secnumdepth}{2}

    % Normalmente, o capítulo de introdução não deve ser numerado, mas
    % deve aparecer no sumário. Por padrão, LaTeX não oferece uma solução
    % para isso, então criamos aqui os comandos \unnumberedchapter,
    % \unnumberedsection e \unnumberedsubsection.
    \newcommand{\unnumberedchapter}[2][]{
      \ifblank{#1}
        {
          \chapter*{#2}
          \phantomsection
          \addcontentsline{toc}{chapter}{#2}
          \chaptermark{#2}
        }
        {
          \chapter*{#2}
          \phantomsection
          \addcontentsline{toc}{chapter}{#1}
          \chaptermark{#1}
        }
    }

    \newcommand{\unnumberedsection}[2][]{
      \ifblank{#1}
        {
          \section*{#2}
          \phantomsection
          \addcontentsline{toc}{section}{#2}
          \sectionmark{#2}
        }
        {
          \section*{#2}
          \phantomsection
          \addcontentsline{toc}{section}{#1}
          \sectionmark{#1}
        }
    }

    \newcommand{\unnumberedsubsection}[2][]{
      \ifblank{#1}
        {
          \subsection*{#2}
          \phantomsection
          \addcontentsline{toc}{subsection}{#2}
        }
        {
          \subsection*{#2}
          \phantomsection
          \addcontentsline{toc}{subsection}{#1}
        }
    }
  }
  {}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%% EPÍGRAFE (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}
  {
    % O formato padrão do pacote epigraph é bem feinho...
    % Outra opção para epígrafes é o pacote quotchap
    \usepackage{epigraph}

    \setlength\epigraphwidth{.85\textwidth}

    % Sem linha entre o texto e o autor
    \setlength{\epigraphrule}{0pt}

    % Ambiente auxiliar para colocar margem à direita da epígrafe
    % (como sempre, o modo mais simples de mudar as margens de um
    % pagrágrafo é fazer de conta que é uma lista)
    \newenvironment{epShiftLeft}
      {
        \par\begin{list}{}
          {
            \leftmargin 0pt
            \labelwidth 0pt
            \labelsep 0pt
            \itemsep 0pt
            \topsep 0pt
            \partopsep 0pt
            \rightmargin 2em
          }
        \item\FlushRight
      }
      {
        \end{list}
        % O espaço padrão que epigraph coloca entre a citação
        % e o autor é muito pequeno; vamos aumentar um pouco
        \vspace*{.3\baselineskip}
      }

    \renewcommand\textflush{epShiftLeft}
    \renewcommand\sourceflush{epShiftLeft}

    \newcommand{\epigrafe}[2] {%
      \ifstrempty{#2}{
        \epigraph{\itshape #1}{}
      }{
        \epigraph{\itshape #1}{--- #2}
      }
    }
  }
  {}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%% DEDICATÓRIA (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% A dedicatória vai em uma página separada, sem numeração,
% com o texto alinhado à direita e margens esquerda e
% superior muito grandes. Vamos fazer isso com uma minipage.
\newenvironment{dedicatoria} {
  \hypersetup{pageanchor=false} % Veja comentário em \maketitle

  \if@openright\cleardoublepage\else\clearpage\fi

  \thispagestyle{empty}
  \vspace*{140mm plus 0mm minus 100mm}
  \noindent
  \begin{FlushRight}
     \begin{minipage}[b][100mm][b]{100mm}
       \begin{FlushRight}
         \itshape
} {
       \end{FlushRight}
     \end{minipage}\hspace*{3em}
  \end{FlushRight}
  \vspace*{50mm plus 0mm minus 10mm}
  \if@openright\cleardoublepage\else\clearpage\fi

  \hypersetup{pageanchor=true}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% RESUMO (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}
  {
    % A página de resumo deve existir em português e inglês; ambas as versões
    % utilizam o mesmo environment.

    \NewDocumentCommand{\resumo}{+m}{%
      \long\gdef\@resumo{#1}%

      \bgroup
      \@IMEremoveLinebreaksEtc{\@resumo}
      \IfLanguagePatterns{brazilian}
        {
          \hypersetup{
            pdfsubject={\@resumo},
            pdfkeywords={\@commakeywordspt},
          }
        }
        {
          \XMPLangAlt{pt}{pdfsubject={\@resumo}}
          % o item "keywords" não pode ser traduzido

          % XMPLangAlt undefines "\do"; this may cause
          % problems with biblatex, but we do not need
          % to worry here because we are in a group.
          % https://github.com/plk/biblatex/issues/1105
        }
      \egroup

      \bgroup\bgroup % Dois grupos aninhados, veja a documentação da package babel
      \expandafter\selectlanguage\expandafter{\@IMEpt}
      \begin{IMEabstract}\@resumo\end{IMEabstract}
      \egroup\egroup
    }

    \DeclareDocumentCommand{\abstract}{+m}{%
      \long\gdef\@abstract{#1}%

      \bgroup
      \@IMEremoveLinebreaksEtc{\@abstract}
      \IfLanguagePatterns{brazilian}
        {
          \XMPLangAlt{en}{pdfsubject={\@abstract}}
          % o item "keywords" não pode ser traduzido

          % XMPLangAlt undefines "\do"; this may cause
          % problems with biblatex, but we do not need
          % to worry here because we are in a group.
          % https://github.com/plk/biblatex/issues/1105
        }
        {
          \hypersetup{
            pdfsubject={\@abstract},
            pdfkeywords={\@commakeywordsen},
          }
        }
      \egroup

      \bgroup\bgroup % Dois grupos aninhados, veja a documentação da package babel
      \expandafter\selectlanguage\expandafter{\@IMEen}
      \begin{IMEabstract}\@abstract\end{IMEabstract}
      \egroup\egroup
    }
  }
  {}

\NewDocumentEnvironment{IMEabstract}{} {
  \if@openright\cleardoublepage\else\clearpage\fi
  \thispagestyle{empty}

    \begin{center}\Large\bfseries\abstractname\end{center}

  \vspace*{2em plus 1em minus 1em}

  \footnotesize

  % Esse é o jeito mais simples de mudar as margens de um parágrafo:
  % faz de conta que é uma lista
  \begin{list}{}{\rightmargin 4em \leftmargin 4em}
    \item\@selfReference
  \end{list}

  \vspace*{1em plus 1em minus 0em}
} {
  % Impede uma quebra de página entre esta linha e a próxima, ou seja,
  % entre a última linha do resumo/abstract e as palavras-chave.
  \@afterheading

  \vspace*{1em plus 1em minus .5em}

  \begingroup

      \setlength{\leftmargini}{\widthof{\textbf{\keywordsname:}\quad}}
      \setlength{\labelwidth}{\widthof{\textbf{\keywordsname:}}}
      \setlength{\labelsep}{\widthof{\quad}}

      \begin{description}
        \item[\keywordsname:]\IfLanguagePatterns{brazilian}
                             {\@keywordspt}
                             {\@keywordsen}%
      \end{description}

  \endgroup
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%% TEXTOS PADRÃO PARA A CAPA (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}
  {
    % Formatação de datas de acordo com a língua
    \usepackage[useregional]{datetime2}
    \DTMusemodule{brazilian}{portuges}
    \DTMnewdatestyle{month-year}{%
      \renewcommand*{\DTMdisplaydate}[4]{##2,\space##1}%
      \renewcommand*{\DTMDisplaydate}{\DTMdisplaydate}%
    }

    % \extrasLANGUAGE vs \captionsLANGUAGE: https://tex.stackexchange.com/a/354197

    % Palavras fixas a serem traduzidas
    \providecommand\keywordsname{} % Keywords / Palavras-chave
    \providecommand\programname{} % Program / Programa
    \providecommand\committeename{} % Examining committee / Comissão julgadora
    \providecommand\advisorname{} % Advisor / Orientador(a)
    \providecommand\coadvisorname{} % Co-advisor / Coorientador(a)
    \providecommand\workname{} % Report, Thesis / Tese, Dissertação, Monografia
    \providecommand\degreename{} % Masters, Doctorate, Bachelor / Mestrado, Doutorado, Bacharelado
    \providecommand\titlename{} % Master, Doctor, Bachelor / Mestre(a), Doutor(a), Bacharel
    \providecommand\@assembleLicenseText[1]{O conteúdo deste trabalho
                                            é publicado sob a licença #1}

    % Textos longos a serem traduzidos
    \providecommand\@coverTCCText{}
    \providecommand\@coverQualiText{}
    \providecommand\@coverThesisText{}
    \providecommand\@institutionBlockText{} % Só para TCC
    \providecommand\@provisionalFrontmatterText{}
    \providecommand\@finalFrontmatterText{}
    \providecommand\@institution{}

    % Este não precisa ser traduzido, o texto em inglês não utiliza
    \providecommand\@bywhom{%
      \ifdefstring{\@authorGender}{masc}
        {pelo candidato \@author}
        {pela candidata \@author}%
    }

    %%%%%%%%%% PORTUGUÊS %%%%%%%%%%
    \expandafter\addto\csname captions\@IMEpt\endcsname{%
      \DTMrenewdatestyle{month-year}{%
        \renewcommand*{\DTMdisplaydate}[4]
          {\DTMportugesmonthname{##2}\space de\space##1}%
      }%
      \renewcommand\keywordsname{Palavras-chave}%
      \renewcommand\programname{Programa}%
      \renewcommand\committeename{Comissão julgadora}%
      \renewcommand\advisorname{%
        \iftoggle{@tcc}{%
          \ifdefstring{\@advisorGender}{masc}
            {Supervisor}
            {Supervisora}%
        }{%
          \ifdefstring{\@advisorGender}{masc}
            {Orientador}
            {Orientadora}%
        }%
      }%
      \renewcommand\coadvisorname[1]{%
        \iftoggle{@tcc}{%
          \ifcsstring{@coadvisor#1Gender}{masc}
            {Cossupervisor}
            {Cossupervisora}%
        }{%
          \ifcsstring{@coadvisor#1Gender}{masc}
            {Coorientador}
            {Coorientadora}%
        }%
      }%
      \renewcommand\workname{%
        \iftoggle{@tcc}
          {Monografia}
          {\iftoggle{@qualificacao}
            {Exame de Qualificação}
            {\iftoggle{@doutorado}
              {Tese}
              {Dissertação}%
            }%
          }%
      }%
      \renewcommand\degreename{%
        \iftoggle{@doutorado}
          {Doutorado}
          {\iftoggle{@mestrado}
            {Mestrado}
            {\iftoggle{@tcc}
              {Bacharelado}
              {Nível não definido!}%
            }%
          }%
      }%
      \renewcommand\titlename{%
        \iftoggle{@doutorado}
          {\ifdefstring{\@authorGender}{masc}{Doutor}{Doutora}}
          {\iftoggle{@mestrado}
            {\ifdefstring{\@authorGender}{masc}{Mestre}{Mestra}}
            {\iftoggle{@tcc}
              {Bacharel}{Nível não definido!}%
            }%
          }%
      }%
      %
      %
      \renewcommand\@coverTCCText{%
        Monografia Final\vspace{.5\baselineskip}\\
        \@macCDXCIX{} --- Trabalho de\\
        Formatura Supervisionado%
      }%
      \renewcommand\@coverQualiText{%
        Relatório apresentado ao\\
        Instituto de Matemática e Estatística\\
        da Universidade de São Paulo\\
        para exame de qualificação de\\
        \degreename{} em Ciências%
      }%
      \renewcommand\@coverThesisText{%
        \workname{} apresentada ao\\
        Instituto de Matemática e Estatística\\
        da Universidade de São Paulo\\
        para obtenção do título de\\
        \titlename{} em Ciências%
      }%
      \renewcommand\@institutionBlockText{%
        Universidade de São Paulo\\
        Instituto de Matemática e Estatística\\
        Bacharelado em Ciência da Computação%
      }%
      \renewcommand\@provisionalFrontmatterText{%
        \iftoggle{@qualificacao}{%
          Esta é a versão original do texto de qualificação elaborado
          \@bywhom{}, tal como submetido à Comissão Julgadora.%
        }{%
          Esta é a versão original da \MakeTextLowercase{\workname} elaborada
          \@bywhom{}, tal como submetida à Comissão Julgadora.%
        }%
      }%
      \renewcommand\@finalFrontmatterText{%
        Esta versão da \MakeTextLowercase{\workname} contém as correções e alterações
        sugeridas pela Comissão Julgadora durante a defesa da versão
        original do trabalho, realizada em \DTMusedate{@defensedate}.\\[1\baselineskip]
        Uma cópia da versão original está disponível no Instituto de
        Matemática e Estatística da Universidade de São Paulo.%
      }%
      \renewcommand\@institution{%
        Instituto de Matemática e Estatística,
        Universidade de São Paulo%
      }%
      \renewcommand{\@assembleLicenseText}[1]{O conteúdo deste trabalho
                                              é publicado sob a licença #1}%
    }


    %%%%%%%%%% INGLÊS %%%%%%%%%%
    \expandafter\addto\csname captions\@IMEen\endcsname{%
      \DTMrenewdatestyle{month-year}{%
        \renewcommand*{\DTMdisplaydate}[4]
          {\DTMenglishmonthname{##2},\space##1}%
      }%
      \renewcommand\keywordsname{Keywords}%
      \renewcommand\programname{Program}%
      \renewcommand\committeename{Examining Committee}
      \renewcommand\advisorname{%
        \iftoggle{@tcc}{Supervisor}{Advisor}%
      }%
      \renewcommand\coadvisorname[1]{%
        \iftoggle{@tcc}{Co-supervisor}{Coadvisor}%
      }%
      % "Tese" e "dissertação" têm sentido contrário em língua inglesa:
      % http://guides.lib.berkeley.edu/dissertations_theses
      % https://www.grad.ubc.ca/handbook-graduate-supervision/graduate-thesis
      % Como "Thesis" é o nome genérico, vamos usar para mestrado e doutorado
      %
      %%%%%
      %
      % Nomes possíveis para o TCC em inglês:
      %
      % * monograph/monography
      %     usado para trabalho de alto nível de um autor "senior",
      %     então não faz sentido para um trabalho de graduação.
      %
      % * undergraduate thesis / bachelor's thesis
      %     plausível, mas no nosso caso report parece melhor.
      %
      % * senior project / senior thesis / honor thesis
      %     usado para "TCCs" de caráter fortemente acadêmico;
      %     não é o caso aqui.
      %
      % * essay / report
      %     razoável, porque trata-se de um texto/relato
      %     sobre o projeto de TCC.
      \renewcommand\workname{%
        \iftoggle{@tcc}
          {Capstone Project Report}
          {\iftoggle{@qualificacao}
            {Qualifying Exam}
            {Thesis}%
          }%
      }%
      \renewcommand\degreename{%
        \iftoggle{@doutorado}
          {Doctorate}
          {\iftoggle{@mestrado}
            {Master's}
            {\iftoggle{@tcc}
              {Bachelor}
              {Nível não definido!}%
            }%
          }%
      }%
      \renewcommand\titlename{%
        \iftoggle{@doutorado}
          {Doctor}
          {\iftoggle{@mestrado}
            {Master}
            {\iftoggle{@tcc}
              {Bachelor}%
              {Nível não definido!}%
            }%
          }%
      }%
      %
      %
      \renewcommand\@coverTCCText{%
        Final Essay\vspace{.5\baselineskip}\\
        \@macCDXCIX{} --- Capstone Project%
      }%
      \renewcommand\@coverQualiText{%
        Report presented to the\\
        Institute of Mathematics and Statistics\\
        of the University of São Paulo\\
        for the \titlename{} of Science\\
        qualifying examination\\%
      }%
      \renewcommand\@coverThesisText{%
        \workname{} presented to the\\
        Institute of Mathematics and Statistics\\
        of the University of São Paulo\\
        in partial fulfillment\\
        of the requirements\\
        for the degree of\\
        \titlename{} of Science%
      }%
      \renewcommand\@institutionBlockText{%
        University of São Paulo\\
        Institute of Mathematics and Statistics\\
        Bachelor of Computer Science%
      }%
      \renewcommand\@provisionalFrontmatterText{%
        \iftoggle{@qualificacao}{%
          This is the original version of the qualifying text prepared
          by candidate \@author, as submitted to the Examining Committee.%
        }{%
          This is the original version of the \MakeTextLowercase{\workname} prepared
          by candidate \@author, as submitted to the Examining Committee.%
        }%
      }%
      \renewcommand\@finalFrontmatterText{%
        This version of the \MakeTextLowercase{\workname} includes the corrections
        and modifications suggested by the Examining Committee during
        the defense of the original version of the work, which took
        place on \DTMusedate{@defensedate}.\\[1\baselineskip]
        A copy of the original version is available at the Institute of
        Mathematics and Statistics of the University of São Paulo.%
      }%
      \renewcommand\@institution{%
        Institute of Mathematics and Statistics,
        University of São Paulo%
      }%
      \renewcommand{\@assembleLicenseText}[1]{The content of this work is
                                              published under the #1 license}%
    }
  }
  {}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%% COLETA E DEFINIÇÃO DE METADADOS (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn
% Mais de um coorientador é raro, mas pode acontecer
\newcounter{numberOfCoadvisors}
\NewDocumentCommand\coorientador{O{masc} m}{
    \stepcounter{numberOfCoadvisors}
    \tl_gclear_new:c {@coadvisor\Roman{numberOfCoadvisors}}
    \tl_gclear_new:c {@coadvisor\Roman{numberOfCoadvisors}Gender}

    \tl_set:cn {@coadvisor\Roman{numberOfCoadvisors}} {#2}
    \tl_set:cn {@coadvisor\Roman{numberOfCoadvisors}Gender} {#1}
}

\seq_gclear_new:N \@committeeMembers

\newtoggle{@mestrado}
\newtoggle{@doutorado}
\newtoggle{@tcc}
\newtoggle{@qualificacao}
\newtoggle{@finalversion}

% Opções usando LaTeX3 (veja texdoc l3keys).
\keys_define:nn { IME / defense }
  {
    % Chaves à esquerda definem as variáveis à direita
    data .code:n= {\DTMsavedate{@defensedate}{#1}},
    data .value_required:n = true,
    nivel .choice:,
    nivel / mestrado .code:n = {\@mestrado},
    nivel / masters .code:n = {\@mestrado},
    nivel / dissertacao .code:n = {\@mestrado},
    nivel / doutorado .code:n = {\@doutorado},
    nivel / phd .code:n = {\@doutorado},
    nivel / tese .code:n = {\@doutorado},
    nivel / graduacao .code:n = {\@tcc},
    nivel / bachelor .code:n = {\@tcc},
    nivel / tcc .code:n = {\@tcc},
    nivel .value_required:n = true,
    quali .code:n = {\ifstrequal{#1}{true}{\toggletrue{@qualificacao}}{\togglefalse{@qualificacao}}},
    quali .default:n = {true},
    definitiva .code:n = {\ifstrequal{#1}{true}{\toggletrue{@finalversion}}{\togglefalse{@finalversion}}},
    definitiva .default:n = {true},
    provisoria .code:n = {\ifstrequal{#1}{true}{\togglefalse{@finalversion}}{\toggletrue{@finalversion}}},
    provisoria .default:n = {true},
    programa .tl_gset:N = \@program,
    program .value_required:n = true,
    apoio .tl_gset:N = \@financing,
    apoio .value_required:n = true,
    local .tl_gset:N = \@defenselocation,
    local .value_required:n = true,
    direitos .tl_gset:N = \@license,
    direitos .value_required:n = true,
    fichacatalografica .tl_gset:N = \@catalogingData,
    fichacatalografica .value_required:n = true,
    membrobanca .code:n = {\seq_gput_right:Nn \@committeeMembers {#1}},
    membrobanca .value_required:n = true,
  }

\NewDocumentCommand\defesa{+m}{%
  \keys_set:nn {IME/defense}{#1}

  \exp_args:NV \str_case:nnF \@license
    {
      {CC-BY}{\gdef\@license{\@assembleLicenseText{CC~BY~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by/4.0/}{%
        (Creative~Commons~Attribution~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by/4.0/}}
      }

      {CC-BY-NC}{\gdef\@license{\@assembleLicenseText{CC~BY-NC~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nc/4.0/}{%
        (Creative~Commons~Attribution-NonCommercial~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc/4.0/}}
      }

      {CC-BY-ND}{\gdef\@license{\@assembleLicenseText{CC~BY-ND~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nd/4.0/}{%
        (Creative~Commons~Attribution-NoDerivatives~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc-nd/4.0/}}
      }

      {CC-BY-SA}{\gdef\@license{\@assembleLicenseText{CC~BY-SA~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-sa/4.0/}{%
        (Creative~Commons~Attribution-ShareAlike~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-sa/4.0/}}
      }

      {CC-BY-NC-SA}{\gdef\@license{\@assembleLicenseText{CC~BY-NC-SA~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nc-sa/4.0/}{%
        (Creative~Commons~Attribution-NonCommercial-ShareAlike~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc-sa/4.0/}}
      }

      {CC-BY-NC-ND}{\gdef\@license{\@assembleLicenseText{CC~BY-NC-ND~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nc-nd/4.0/}{%
        (Creative~Commons~Attribution-NonCommercial-NoDerivatives~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc-nd/4.0/}}
      }
    }
    % If there is no match, use the user-supplied text
    {}
}
\ExplSyntaxOff

\ExplSyntaxOn
% Dentro deste "if" porque não queremos mexer com \keyword
% indevidamente, talvez alguma classe defina essa macro.
\iftoggle{IMEthesis}
  {
    \seq_gclear_new:N \@seqkeywordspt
    \seq_gclear_new:N \@seqkeywordsen
    \newcommand*{\palavrachave}[1]{\seq_gput_right:Nn \@seqkeywordspt {#1}}
    \newcommand*{\keyword}[1]{\seq_gput_right:Nn \@seqkeywordsen {#1}}

    % Na impressão, as palavras-chave são separadas por pontos
    \newcommand*{\@keywordspt}{\seq_use:Nn \@seqkeywordspt {.\space}.}
    \newcommand*{\@keywordsen}{\seq_use:Nn \@seqkeywordsen {.\space}.}

    % Para inclusão nos metadados com hyperxmp, são separadas por vírgulas
    \newcommand*{\@commakeywordspt}{\seq_use:Nn \@seqkeywordspt {,}}
    \newcommand*{\@commakeywordsen}{\seq_use:Nn \@seqkeywordsen {,}}
  }
  {}
\ExplSyntaxOff

\NewDocumentCommand{\orientador}{O{masc} m}{
  \gdef\@advisor{#2}
  \gdef\@advisorGender{#1}
}

\NewDocumentCommand{\@doutorado}{}{
  \toggletrue{@doutorado}
  \togglefalse{@mestrado}
  \togglefalse{@tcc}
}

\NewDocumentCommand{\@mestrado}{}{
  \togglefalse{@doutorado}
  \toggletrue{@mestrado}
  \togglefalse{@tcc}
}

\NewDocumentCommand{\@tcc}{}{
  \togglefalse{@mestrado}
  \togglefalse{@doutorado}
  \toggletrue{@tcc}
}

\ExplSyntaxOn
% Opções usando LaTeX3 (veja texdoc l3keys).
\keys_define:nn { IME / title }
  {
    % Chaves à esquerda definem as variáveis à direita
    titlept .tl_gset:N = \@titlept,
    titlept .value_required:n = true,
    titleen .tl_gset:N = \@titleen,
    titleen .value_required:n = true,
    subtitlept .tl_gset:N = \@subtitlept,
    subtitlept .value_required:n = true,
    subtitleen .tl_gset:N = \@subtitleen,
    subtitleen .value_required:n = true,
  }
\ExplSyntaxOff

\ExplSyntaxOn
\iftoggle{IMEthesis}
  {
    \renewcommand\author[2][masc]{
      \gdef\@author{#2}
      \gdef\@authorGender{#1}
      \hypersetup{pdfauthor={\@author}}
    }

    \RenewDocumentCommand\title{m}{
      \keys_set:nn {IME/title}{#1}

      \bgroup
      % O título deve existir nas duas línguas; o subtítulo é opcional,
      % mas se houver também deve existir nas duas línguas.
      \IfLanguagePatterns{brazilian}
        {
          \global\let\@title\@titlept
          \ifdefvoid{\@subtitlept}
            {}
            {\global\let\@subtitle\@subtitlept}

          \let\@mainlangtitle\@titlept
          \let\@mainlangsubtitle\@subtitlept
          \let\@otherlangtitle\@titleen
          \let\@otherlangsubtitle\@subtitleen
          \def\@otherlangname{en}
        }
        {
          \global\let\@title\@titleen
          \ifdefvoid{\@subtitleen}
            {}
            {\global\let\@subtitle\@subtitleen}

          \let\@mainlangtitle\@titleen
          \let\@mainlangsubtitle\@subtitleen
          \let\@otherlangtitle\@titlept
          \let\@otherlangsubtitle\@subtitlept
          \def\@otherlangname{pt}
        }

      % Insere os metadados XMP no arquivo PDF final.
      % \@IMEremoveLinebreaksEtc está definida em hyperlinks.tex.

      \@IMEremoveLinebreaksEtc{\@mainlangtitle}
      \@IMEremoveLinebreaksEtc{\@mainlangsubtitle}
      \@IMEremoveLinebreaksEtc{\@otherlangtitle}
      \@IMEremoveLinebreaksEtc{\@otherlangsubtitle}

      \hypersetup{
        pdftitle={\@mainlangtitle
                  \ifdefvoid{\@mainlangsubtitle}{}{:~\@mainlangsubtitle}%
                 },
      }

      \XMPLangAlt{\@otherlangname}{
          pdftitle={\@otherlangtitle
                    \ifdefvoid{\@otherlangsubtitle}{}{:~\@otherlangsubtitle}%
                   },
      }

      % XMPLangAlt undefines "\do"; this may cause
      % problems with biblatex, but we do not need
      % to worry here because we are in a group.
      % https://github.com/plk/biblatex/issues/1105
      \egroup
    }
  }
  {}
\ExplSyntaxOff

\iftoggle{IMEthesis}
  {
    % Defaults quando o usuário não define alguma dessas variáveis.
    % Não podemos usar \title ou \author aqui porque esses comandos
    % dependem de hyperref, que ainda não foi carregada.
    \providecommand\@author{Autor não definido!}
    \orientador{Orientador não definido!}
    \DTMsavedate{@defensedate}{1970-01-01}
    \providecommand\@program{Programa não definido!}
    \providecommand\@financing{}
    \providecommand\@defenselocation{Local não definido!}
    \providecommand\@license{Direitos não definidos!}
    \providecommand\@title{Título não definido!}
    \providecommand\@titlept{Título em português não definido!}
    \providecommand\@titleen{Título em inglês não definido!}
    \providecommand\@resumo{Resumo não definido!}
    \providecommand\@abstract{Abstract não definido!}
  }
  {}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%% IMPRIME A CAPA E A FOLHA DE ROSTO %%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}
  {
    \RenewDocumentCommand\maketitle{}{
      % Embora as páginas iniciais *pareçam* não ter numeração, a numeração
      % existe, só não é impressa. Os comandos \frontmatter, \mainmatter,
      % \pagenumbering etc. reiniciam a contagem de páginas quando os números
      % passam a ser impressos. Isso significa que há mais de uma página com
      % o número "1". O pacote hyperref não lida bem com essa situação, então
      % vamos desabilitar hyperlinks para números de páginas aqui.
      \hypersetup{pageanchor=false}
      \bgroup
      \onehalfspacing

      \@IMEcover
      \iftoggle{@tcc}{}{\@IMEtitlePage}
      \@IMEversoPage

      \egroup
      \if@openright\cleardoublepage\else\clearpage\fi
      \hypersetup{pageanchor=true}
    }
  }
  {}

% Layout da capa
\NewDocumentCommand{\@IMEcover}{} {
  \cleardoublepage
  \thispagestyle{empty}

  \begin{hyphenrules}{nohyphenation}
      \iftoggle{@tcc}{\@institutionBlock}{}
      \@titleBlock
      \vspace*{\fill}
      \@detailsBlock
  \end{hyphenrules}
}

% Layout para a página de rosto (duas versões, de acordo
% com a Resolução CoPGr 6018 de 13/10/2011)
\NewDocumentCommand{\@IMEtitlePage}{} {
  \if@openright\cleardoublepage\else\clearpage\fi
  \thispagestyle{empty}

  \begin{hyphenrules}{nohyphenation}
      \@titleBlock
      \vspace*{2cm plus 2cm minus 1cm}
      \@versionInfoBlock
      \vspace*{3.5cm plus 3cm minus 3.5cm}
      \iftoggle{@finalversion}{\@committeeBlock}{}
      \vspace*{2cm plus 2cm minus 2cm}
  \end{hyphenrules}
}

\NewDocumentCommand{\@IMEversoPage}{}{
  \clearpage
  \thispagestyle{empty}
  \ifcsvoid{@catalogingData}
    {\vspace*{4cm}}
    {\vspace*{2cm}}

  \begin{list}{}{\rightmargin 3em \leftmargin 3em}
    \onehalfspacing\centering\footnotesize\itshape
    \item\@license
  \end{list}

  \ifcsvoid{@catalogingData} {} {\vspace{\fill}\@catalogingData}

  \vspace{1cm minus 1cm}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%% POSIÇÃO DOS ELEMENTOS NA CAPA %%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% O IME usa uma capa padrão de cartolina para todas as teses/dissertações.
% Essa capa tem uma janela recortada por onde se vê o título e o autor do
% trabalho. Ela fica centralizada na página, tem 100m de largura, 60mm de
% altura e começa 47mm abaixo do topo da página. Como o documento já tem
% margens definidas pelo usuário, precisamos calcular quanto precisamos
% acrescentar ou subtrair dessas margens para colocar o título e autor
% na posição exata (na verdade, com uma pequena folga: 49mm abaixo do topo
% da página, 96mm de largura e 56mm de altura).
%
% Para centralizar horizontalmente, poderíamos pensar em usar "\center",
% mas isso não funciona porque ele centraliza o texto em relação à coluna
% de texto, não à página. Assim, como as margens esquerda e direita do
% documento podem ser diferentes, a janela não ficaria na posição correta.
% O que faremos, então, é colocar essa janela em uma minipage e calcular
% a margem esquerda para que essa minipage fique centralizada.
%
% Além disso, outros elementos da capa também não podem ser centralizados
% com "\center", porque eles ficariam desalinhados em relação à janela
% com o título e autor. Vamos colocar esses outros elementos em uma
% minipage também, mas de tamanho diferente da anterior.
%
% Então, precisamos calcular três valores: a margem adicional em relação ao
% topo da página, a margem esquerda da janela com título e autor e a margem
% esquerda para os demais elementos centralizados da página.

\AtEndPreamble{
  % Calcula o valor das margens (após geometry ser carregada)

  % A distância entre o topo da página e o início do texto (fora o cabeçalho)
  % é dada por (1in + \voffset + \headsep + \topmargin + \headheight).
  % Queremos colocar a caixa com o título 49mm abaixo do topo, então:
  \dimgdef\@topTitleBlockMargin{49mm - (1in + \voffset + \headsep + \topmargin + \headheight)}

  % Quando \vspace é usado no início da página, ele não tem efeito; como
  % não é isso que queremos, vamos usar \vspace*. No entanto, \vspace*
  % é implementado inserindo uma \hrule de espessura zero e depois
  % acrescentando o espaço solicitado. O resultado não é exatamente
  % o esperado, pois \topskip, \parskip e \baselineskip interagem com
  % \vspace* de maneira um tanto complexa:
  % https://tex.stackexchange.com/a/247516
  %
  % Aqui, vamos compensar essa diferença. Note que, se a primeira linha
  % da página tivesse um tamanho de fonte especial, seria necessário
  % usar o valor de \baselineskip correspondente a essa fonte. Além
  % disso, definimos espaçamento simples porque o \vspace* mencionado
  % acima é executado com espaçamento simples.
  \bgroup
  \setstretch {\setspace@singlespace}% \singlespacing adds \baselineskip
  \dimgdef\@topTitleBlockMargin{\@topTitleBlockMargin - \baselineskip - \parskip}
  \egroup

  % Queremos colocar a caixa com o título centralizada na página. "\center"
  % centraliza em função da área de texto, não da página inteira, então
  % não podemos usá-lo, pois as margens esquerda e direita podem ser
  % diferentes. A distância entre a borda esquerda/interna do papel e o
  % início do texto é dada por (1in + \hoffset + \oddsidemargin), então:
  \dimgdef\@leftTitleBlockMargin{(\paperwidth - 96mm)/2 - (1in + \hoffset + \oddsidemargin)}
  \dimgdef\@coverLeftMargin{(\paperwidth - 160mm)/2 - (1in + \hoffset + \oddsidemargin)}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%% OS ELEMENTOS QUE COMPÕEM A CAPA E A FOLHA DE ROSTO %%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Com fontspec (ou seja, lualatex/xelatex), o comando \oldstylenums funciona
% com qualquer fonte que tenha suporte a números old-style. Já com pdflatex,
% o comando para escolher números old style depende da fonte em uso. Nesse
% caso, se não soubermos qual a fonte atual (ou seja, não é libertinus), vamos
% usar latin modern e torcer para o resultado não ser % muito discrepante do
% restante do texto.

% 499 = CDXCIX
\@ifpackageloaded{fontspec}
  {\providecommand{\@macCDXCIX}{mac~\oldstylenums{499}}}
  {
    \providecommand{\@macCDXCIX}{{\fontfamily{lmr}\selectfont mac~\oldstylenums{499}}}

    \@ifpackageloaded{libertinus}
      {\renewcommand{\@macCDXCIX}{{\LibertinusSerifOsF mac~499}}}
      {}
  }

\newcommand{\@coverText}{
  \bgroup
  \setstretch{.9}

  \iftoggle{@tcc}
    {\@coverTCCText}
    {\iftoggle{@qualificacao}{\@coverQualiText}{\@coverThesisText}}
  \par
  \egroup
}

\ExplSyntaxOn
\newcounter{@IMEtmpcnt}
\newcommand*{\@coverPeople} {%
  \begin{tabular}{rl}
    \iftoggle{@tcc}{}{\programname : & \@program \tabularnewline}
    \advisorname : & \@advisor \tabularnewline
    \setcounter{@IMEtmpcnt}{0}%
    \int_while_do:nNnn {\value{@IMEtmpcnt}} < {\value{numberOfCoadvisors}} {%
      \stepcounter{@IMEtmpcnt}%
      \coadvisorname{\Roman{@IMEtmpcnt}}: & \csuse{@coadvisor\Roman{@IMEtmpcnt}} \tabularnewline
    }%
  \end{tabular}
}

\ExplSyntaxOff

\newcommand{\@selfReference} {%
  \bgroup
  \IfLanguagePatterns{brazilian}
    {%
      \let\@currlangtitle\@titlept
      \let\@currlangsubtitle\@subtitlept
    }
    {%
      \let\@currlangtitle\@titleen
      \let\@currlangsubtitle\@subtitleen
    }%
  \@IMEremoveLinebreaksEtc{\@currlangtitle}%
  \@IMEremoveLinebreaksEtc{\@currlangsubtitle}%
  \@author.
  \textbf{\@currlangtitle\ifdefvoid{\@currlangsubtitle}{}{: \textit{\@currlangsubtitle}}}.
  \workname{} (\degreename).
  \@institution,
  São Paulo, \DTMfetchyear{@defensedate}.%
  \egroup
}

% Só para TCC
\newcommand{\@institutionBlock}{

    % A posição do quadro de título é fixa em relação à página;
    % a posição deste quadro é definida em função da posição do
    % quadro de título. Assim, primeiro vamos encontrar onde
    % deve começar o quadro do título. Veja os comentários em
    % \@titleBlock para entender o mecanismo.
    \bgroup
    \hfuzz=60pt % Não precisa avisar que estamos invadindo a margem direita aqui

    \setstretch {\setspace@singlespace}% \singlespacing adds \baselineskip

    \vspace*{\@topTitleBlockMargin}
    \ifdeflength{\@normalstrutheight}
      {}
      {\newlength{\@normalstrutheight}}
    \settoheight{\@normalstrutheight}{\strut}
    \vspace{-\@normalstrutheight}

    % Estamos alinhados com o quadro do título do trabalho,
    % mas não é isso que queremos: a parte inferior deste
    % quadro deve ficar 15mm acima do quadro de título e
    % este quadro tem 20mm de altura, então precisamos subir:
    \vspace{-20mm} % Espaço ocupado por este quadro
    \vspace{-15mm} % Espaço entre este quadro e o quadro de título

    \noindent\strut%
    \hspace*{\@coverLeftMargin}%
%    \fbox{%
      \begin{minipage}[t][20mm][s]{160mm}
        \vspace{0pt plus 20mm}

        \centering\large

        \textsc{\@institutionBlockText}

        \vspace{0pt plus 20mm}
      \end{minipage}
%    }% fbox
    \par

    % Agora precisamos voltar o "cursor" para o começo da página
    % para que o quadro de título seja inserido no lugar certo.
    % Para isso, vamos:
    %
    % 1. Chegar novamente ao início do quadro de título e
    %
    % 2. Retroceder o tamanho da margem superior

    % compensa o espaço inserido por \par logo acima
    \vspace{-\parskip}
    \egroup

    % A altura da minipage já compensou o \vspace{-20mm} acima;
    % ainda precisamos compensar o \vspace{-15mm}
    \vspace{15mm}

    % Agora estamos no início do quadro de título, então
    % podemos recuar exatamente o tamanho da margem superior.
    \vspace{-\@topTitleBlockMargin}
}

% O quadro com o título e o autor que deve ser visível
% através da janela na capa.
\NewDocumentCommand{\@titleBlock}{} {

    \bgroup
    \setstretch {\setspace@singlespace}% \singlespacing adds \baselineskip

    % Este espaço coloca o topo da próxima linha
    % na posição que queremos:
    \vspace*{\@topTitleBlockMargin}

    % No entanto, a próxima linha contém apenas
    % uma minipage, e definir o topo de uma linha
    % desse tipo é complicado. Assim, vamos:
    %
    % 1. Acrescentar um \strut a essa linha;
    %
    % 2. mover o baseline dessa linha para o topo do \strut;
    %
    % 3. Alinhar o topo da minipage ao baseline da linha.
    %
    % Sobre alinhamento de minipages:
    % https://en.wikibooks.org/wiki/LaTeX/Boxes

    \ifdeflength{\@normalstrutheight}
      {}
      {\newlength{\@normalstrutheight}}
    \settoheight{\@normalstrutheight}{\strut}
    \vspace{-\@normalstrutheight}

    \noindent\strut
    \hspace*{\@leftTitleBlockMargin}%
%    \fbox{%
      \begin{minipage}[t][56mm][s]{96mm}
          \vspace*{2cm plus 1.5cm minus 1.8cm}

          \centering\large

          \textbf{\@title}

          \vspace{0.3cm plus 0.2cm minus 0.1cm}

          \ifdefvoid{\@subtitle}{}{\textbf{\textit{\@subtitle}}}

          \vspace{1cm plus 1cm minus 0.6cm}

          \@author

          \vspace*{2cm plus 1.5cm minus 1.8cm}
      \end{minipage}%
%    }% fbox
    \par
    \egroup
}

% As demais informações da capa
\NewDocumentCommand{\@detailsBlock}{} {

  \bgroup
  \hfuzz=60pt % Não precisa avisar que estamos invadindo a margem direita aqui
  \onehalfspacing
  \noindent
  \hspace*{\@coverLeftMargin}%
%  \fbox{%
    \begin{minipage}[t][130mm][s]{160mm}
      \begin{center}
        \Large

        \vspace*{0.3cm plus 0.5cm minus 0.3cm}

        \textsc{\@coverText}

        \vspace*{1.5cm plus 0.5cm minus 0.5cm}

        \large\@coverPeople

        \vspace*{2.5cm plus 1cm minus 1cm}

        \normalsize

        \bgroup
        \singlespacing
        \@financing\par
        \egroup

        \vspace*{1cm plus 1cm minus 0.3cm}

        \@defenselocation

        \iftoggle{@tcc}
          {\DTMfetchyear{@defensedate}}
          {\DTMsetdatestyle{month-year}\DTMusedate{@defensedate}}

      \end{center}
    \end{minipage}%
%  }% fbox
  \par
  \egroup
}

% As informações da banca que vão apenas na versão definitiva
% da página de rosto
\ExplSyntaxOn
\NewDocumentCommand{\@committeeBlock}{} {
    \bgroup
    \onehalfspacing
    \begin{minipage}[t][][t]{\textwidth}
      \begin{quote}
        \normalsize\noindent\committeename :\par
        \begin{list}{}
        {
          \setlength{\leftmargin}{0pt}
          \setlength{\itemsep}{.1\baselineskip}
          \setlength{\topsep}{\baselineskip}
        }
          \item[] \seq_use:Nn \@committeeMembers {\item[]}
        \end{list}
      \end{quote}
    \end{minipage}
    \par
    \egroup
}
\ExplSyntaxOff

% A informação sobre a versão provisória ou definitiva
\NewDocumentCommand{\@versionInfoBlock}{} {%
  % As diretrizes dizem que "A natureza do trabalho, o grau pretendido, o
  % nome da instituição a que é submetido e a área de concentração devem
  % ser alinhados a partir do meio da parte impressa da página para a
  % margem direita, tanto na folha de rosto como na folha de avaliação."
  %
  % Assim, queremos alinhar o texto à direita com uma grande margem
  % à esquerda. Uma solução simples é alinhar o texto à direita
  % e inserir uma minipage. Dentro dela, definimos o texto
  % também alinhado à direita.

  \bgroup
  \onehalfspacing
  \begin{FlushRight}
    %\fbox{
      % Margem direita + 80mm de largura significa que a minipage
      % começa mais ou menos no meio da página.
      \begin{minipage}[t][50mm][s]{80mm}
        \begin{FlushRight}
          \normalsize
          \iftoggle{@finalversion}{%
            \@finalFrontmatterText%
          } {%
            \@provisionalFrontmatterText%
          }%
        \end{FlushRight}
        \vspace*{0pt plus 50mm}
      \end{minipage}
      \par
    %} % fbox
  \end{FlushRight}
  \egroup
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% METADADOS XMP %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% TODO: Com versões recentes de hyperxmp (final de 2020), não é
%       recomendado definir pdflang; no futuro, isto deve ser mudado.
\AtEndPreamble{
\IfLanguagePatterns{brazilian}
  {
    \hypersetup{
      pdflang={pt},
      pdfmetalang={pt},
    }
  }
  {
    \hypersetup{
      pdflang={en},
      pdfmetalang={en},
    }
  }
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SEÇÕES %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEappearance}
  {
    % titlesec permite definir formatação personalizada de títulos, seções etc.
    % Observe que titlesec é incompatível com os comandos refsection
    % e refsegment do pacote biblatex!
    \usepackage[raggedright]{titlesec}
  }
  {}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ANEXOS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}
  {
    % A classe Book inclui o comando \appendix, que (obviamente) permite inserir
    % apêndices no documento. No entanto, não há suporte similar para anexos. Esta
    % package acrescenta alguns recursos adicionais para apêndices; vamos usá-la
    % para permitir colocar a palavra "Apêndice" no sumário e também para definir
    % o comando \annex.
    \usepackage{appendix}
    \noappendicestocpagenum

    % Altera a formatação da palavra "Apêndice" no sumário
    %
    % Não queremos a linha "Apêndice" como a última da página no sumário;
    % para isso:
    %
    % 1. Acrescentamos um pouco de espaço elástico logo antes dela
    %
    % 2. Colocamos uma sugestão de quebra de página
    %
    % 3. Usamos \@afterheading
    %
    % 1 e 2 incentivam (mas não forçam) LaTeX a realizar a quebra antes
    % dela e 3 força LaTeX a mantê-la na mesma página que a próxima linha.
    %
    % \addtocontents pode pregar peças se usamos \include; contornamos
    % com \immediate: https://tex.stackexchange.com/a/13926
    \renewcommand\addappheadtotoc{%
      \begingroup
        \let\origwrite\write
        \def\write{\immediate\origwrite}%
        \addtocontents{toc}{{\large\vspace{0pt plus 2\baselineskip minus 0pt}}}%
        \addtocontents{toc}{\protect\pagebreak[2]}%
        \addtocontents{toc}{\vspace{.8\baselineskip}}%
        \addtocontents{toc}{{\large\bfseries\hspace{-1.3em}\appendixtocname\par}}%
        \addtocontents{toc}{\protect\@afterheading}%
      \endgroup
    }

    \let\@IMErealAppendixname\appendixname
    \let\@IMErealAppendixtocname\appendixtocname
    \let\@IMErealAppendixpagename\appendixpagename
    \def\appendixname{\@IMErealAppendixname}
    \def\appendixtocname{\@IMErealAppendixtocname}
    \def\appendixpagename{\@IMErealAppendixpagename}

    \providecommand\annexname{Annex}
    \providecommand\annextocname{Annexes}
    \providecommand\annexpagename{Annexes}

    \addto\captionsbrazil{%
      \renewcommand\annexname{Anexo}%
      \renewcommand\annextocname{Anexos}%
      \renewcommand\annexpagename{Anexos}%
      \renewcommand\@IMErealAppendixname{Apêndice}%
      \renewcommand\@IMErealAppendixtocname{Apêndices}%
      \renewcommand\@IMErealAppendixpagename{Apêndices}%
    }

    \addto\captionsbrazilian{%
      \renewcommand\annexname{Anexo}%
      \renewcommand\annextocname{Anexos}%
      \renewcommand\annexpagename{Anexos}%
      \renewcommand\@IMErealAppendixname{Apêndice}%
      \renewcommand\@IMErealAppendixtocname{Apêndices}%
      \renewcommand\@IMErealAppendixpagename{Apêndices}%
    }

    \addto\captionsenglish{%
      \renewcommand\annexname{Annex}%
      \renewcommand\annextocname{Annexes}%
      \renewcommand\annexpagename{Annexes}%
      \renewcommand\@IMErealAppendixname{Appendix}%
      \renewcommand\@IMErealAppendixtocname{Appendixes}%
      \renewcommand\@IMErealAppendixpagename{Appendixes}%
    }

    \let\@IMEorigAppendix\appendix
    \renewcommand\appendix{%
        \def\appendixname{\@IMErealAppendixname}
        \def\appendixtocname{\@IMErealAppendixtocname}
        \def\appendixpagename{\@IMErealAppendixpagename}
        \def\Hy@appendixstring{appendix}%
        \@IMEorigAppendix
    }

    \newcommand\annex{%
        \def\Hy@appendixstring{annex}
        \def\appendixname{\annexname}
        \def\appendixtocname{\annextocname}
        \def\appendixpagename{\annexpagename}
        \@IMEorigAppendix
    }
  }
  {}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ÍNDICE REMISSIVO %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}
  {
    % A criação do índice remissivo depende de um programa auxiliar, que pode ser
    % o "makeindex" (default) ou o xindy. xindy é mais poderoso e lida melhor com
    % línguas diferentes e caracteres acentuados, mas o programa não está mais
    % sendo mantido.
    %\usepackage[xindy]{imakeidx} % usando xindy
    \usepackage{imakeidx} % usando makeindex

    % Por padrão, o cabeçalho das páginas do índice é feito em maiúsculas;
    % vamos mudar isso e deixar fancyhdr definir a formatação
    \indexsetup{
      othercode={\chaptermark{\indexname}},
    }

    \makeindex[
      noautomatic,
      intoc,
      % Estas opções são usadas por xindy
      % "-C utf8" ou "-M lang/latin/utf8.xdy" são truques para contornar este
      % bug, que existe em outras distribuições tambem:
      % https://bugs.launchpad.net/ubuntu/+source/xindy/+bug/1735439
      % Se "-C utf8" não funcionar, tente "-M lang/latin/utf8.xdy"
      %options=-C utf8 -M hyperxindy.xdy,
      %options=-M lang/latin/utf8.xdy -M hyperxindy.xdy,
      % Estas opções são usadas por makeindex
      options=-s mkidxhead.ist -l -c,
    ]
  }
  {}

% Índices criados com xindy não funcionam em conjunto com hyperref; os criados
% com makeindex podem funcionar, mas apenas se hyperref for carregada após
% imakeidx. Para contornar esse problema, configuramos hyperref para *não*
% gerar hyperlinks no índice (mais abaixo) e configuramos xindy/makeindex
% para que eles gerem esses hyperlinks por conta própria (a configuração de
% makeindex foi copiada da documentação de hyperref).

% Cria o arquivo de configuração para xindy lidar corretamente com hyperlinks.
\begin{filecontents*}{hyperxindy.xdy}
(define-attributes ("emph"))
(markup-locref :open "\hyperpage{" :close "}" :attr "default")
(markup-locref :open "\textbf{\hyperpage{" :close "}}" :attr "textbf")
(markup-locref :open "\textit{\hyperpage{" :close "}}" :attr "textit")
(markup-locref :open "\emph{\hyperpage{" :close "}}" :attr "emph")
\end{filecontents*}

% Cria o arquivo de configuração para makeindex lidar corretamente com
% hyperlinks e colocar um cabeçalho para cada letra do índice.
\begin{filecontents*}{mkidxhead.ist}
delim_0 ", \\hyperpage{"
delim_1 ", \\hyperpage{"
delim_2 ", \\hyperpage{"
delim_n "}, \\hyperpage{"
delim_t "}"
encap_prefix "}\\"
encap_infix "{\\hyperpage{"
encap_suffix "}"
headings_flag 1
heading_prefix "{\\bfseries "
heading_suffix "}\\nopagebreak\n"
\end{filecontents*}

