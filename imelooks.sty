% 2017/01/01 -> fontenc TU and mandatory e-TeX support
\NeedsTeXFormat{LaTeX2e}[2017/01/01]
\ProvidesPackage{imelooks}[2023/05/03 1.0 IME/USP-style theses, articles etc.]

\RequirePackage{imegoodies}

\newtoggle{IMEslides}
\newtoggle{IMEbeamer} % Não carrega pacotes incompatíveis com beamer
\newtoggle{IMEreport}
\newtoggle{IMEthesis}
\newtoggle{IMEposter}

\DeclareOption{presentation}{
    \toggletrue{IMEslides}
    \toggletrue{IMEbeamer}
    \togglefalse{IMEreport}
    \togglefalse{IMEthesis}
    \togglefalse{IMEposter}
}
\DeclareOption{slides}{
    \toggletrue{IMEslides}
    \toggletrue{IMEbeamer}
    \togglefalse{IMEreport}
    \togglefalse{IMEthesis}
    \togglefalse{IMEposter}
}
\DeclareOption{poster}{
    \togglefalse{IMEslides}
    \togglefalse{IMEbeamer}
    \togglefalse{IMEreport}
    \togglefalse{IMEthesis}
    \toggletrue{IMEposter}
}
\DeclareOption{report}{
    \togglefalse{IMEslides}
    \togglefalse{IMEbeamer}
    \toggletrue{IMEreport}
    \togglefalse{IMEposter}
}
\DeclareOption{thesis}{
    \togglefalse{IMEslides}
    \togglefalse{IMEbeamer}
    \toggletrue{IMEreport}
    \toggletrue{IMEthesis}
    \togglefalse{IMEposter}
    \toggletrue{IMEbrazilian}
}

% Isto deve vir *após* slides, report, thesis etc!
% Veja o comentário junto a \ExecuteOptions
\DeclareOption{beamer}{\toggletrue{IMEbeamer}}
\DeclareOption{nobeamer}{\togglefalse{IMEbeamer}}

\newtoggle{IMEbrazilian}
\DeclareOption{brazilian}{\toggletrue{IMEbrazilian}}
\DeclareOption{nobrazilian}{\togglefalse{IMEbrazilian}}

\newtoggle{IMEfonts}
\DeclareOption{fonts}{\toggletrue{IMEfonts}}
\DeclareOption{nofonts}{\togglefalse{IMEfonts}}

\newtoggle{IMEbiblatex}
\DeclareOption{biblatex}{\toggletrue{IMEbiblatex}}
\DeclareOption{nobiblatex}{\togglefalse{IMEbiblatex}}

\newtoggle{IMEspacing}
\DeclareOption{spacing}{\toggletrue{IMEspacing}}
\DeclareOption{nospacing}{\togglefalse{IMEspacing}}

\newtoggle{IMEcaptions}
\DeclareOption{captions}{\toggletrue{IMEcaptions}}
\DeclareOption{nocaptions}{\togglefalse{IMEcaptions}}

\newtoggle{IMEfootnotes}
\DeclareOption{footnotes}{\toggletrue{IMEfootnotes}}
\DeclareOption{nofootnotes}{\togglefalse{IMEfootnotes}}

\newtoggle{IMEhidelinks}
\newtoggle{IMEcolorlinks}
\newtoggle{IMEborderlinks}

\DeclareOption{colorlinks}{
    \togglefalse{IMEhidelinks}
    \toggletrue{IMEcolorlinks}
    \togglefalse{IMEborderlinks}
}
\DeclareOption{borderlinks}{
    \togglefalse{IMEhidelinks}
    \togglefalse{IMEcolorlinks}
    \toggletrue{IMEborderlinks}
}
\DeclareOption{hidelinks}{
    \toggletrue{IMEhidelinks}
    \togglefalse{IMEcolorlinks}
    \togglefalse{IMEborderlinks}
}

% Note que, com \ProcessOptions, as opções são processadas na ordem em
% que foram declaradas acima e *não* na ordem em que aparecem na lista
% de opções (\ProcessOptions* faz o processamento acontecer na ordem
% em que elas aparecem na lista de opções). Veja "texdoc clsguide".
% Isso é importante aqui por causa de IMEbeamer: definimos seu valor
% para os diversos tipos de documento, mas o usuário pode redefini-lo.
\ExecuteOptions{fonts,biblatex,spacing,colorlinks,captions,footnotes}
\ProcessOptions\relax


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%% LÍNGUAS (BRAZILIAN) %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn
\newtoggle{IMEfound}
\NewDocumentCommand\IMEcheckLangLoaded{m m m}{
  \togglefalse{IMEfound}
  \seq_gclear_new:N \l_tmpa_seq
  \seq_gset_from_clist:Nc \l_tmpa_seq {@classoptionslist}

  \seq_map_inline:Nn \l_tmpa_seq{
      \ifstrequal{#1}{##1}
        {\toggletrue{IMEfound}}
        {}
  }

  \ifdefvoid{\bbl@loaded}
    {}
    {
      \seq_gclear_new:N \l_tmpa_seq
      \seq_gset_from_clist:Nc \l_tmpa_seq {bbl@loaded}

      \seq_map_inline:Nn \l_tmpa_seq{
          \ifstrequal{#1}{##1}
            {\toggletrue{IMEfound}}
            {}
      }
    }

  \iftoggle{IMEfound}{#2}{#3}
}
\ExplSyntaxOff

\IMEcheckLangLoaded{brazilian}
  {
    % Por padrão, LaTeX utiliza maiúsculas no início de cada palavra
    % nestas expressões ("Lista de Figuras"); vamos usar maiúsculas
    % apenas na primeira palavra.
    \addto\captionsbrazilian{%
      \renewcommand\listfigurename{Lista de figuras}%
      \renewcommand\listtablename{Lista de tabelas}%
      \renewcommand\indexname{Índice remissivo}%
    }
  }
  {
    \iftoggle{IMEbrazilian}{
        \PackageError{imelooks}{Language "brazilian" not loaded}
        {IME theses expect "brazilian" to be set as a language\MessageBreak
        in the class options list (in general, "brazilian" and\MessageBreak
        "portuguese" are preferred over "brazil" and "portuges").\MessageBreak
        If you really do not want it, add option "nobrazilian" to\MessageBreak
        this package options, but that is not guaranteed to work.}
    }{}
  }



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% FONTES %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Se você está lendo isto, é porque gostaria de modificar os tipos de
% letra do seu documento. A maneira mais simples de fazer isso é consultar
% o sítio https://tug.org/FontCatalogue/ e utilizar as packages indicadas.
% Se o sítio informa que a fonte está disponível *apenas* em formato OTF,
% use lualatex; se *não* está disponível em formato OTF, use pdflatex
% (lualatex também funciona, mas o resultado será inferior). Se está
% disponível em formato OTF e também algum outro, você pode usar qualquer
% um dos dois. Para usar alguma outra fonte instalada em seu computador
% que não foi adaptada especificamente para LaTeX, use lualatex e leia
% a documentação da package fontspec. O que segue são mais detalhes que
% você provavelmente não precisa ler.

% Você normalmente não precisa lidar com isso, mas pode ser útil saber:
% O mecanismo usado por LaTeX para gerir fontes é o NFSS (veja "texdoc
% fntguide"). NFSS funciona com todas as versões de LaTeX, mas só com fontes
% que foram adaptadas para funcionar com ele. LuaLaTeX e XeLaTeX estendem o
% NFSS: através da package fontspec, eles podem utilizar quaisquer fontes
% instaladas no computador e acessar diversos recursos tipográficos com mais
% facilidade. De maneira geral, se quiser fazer algo especial com as fontes
% do seu documento, atualmente não é mais necessário entender o NFSS; basta
% usar lualatex e seguir a documentação da package fontspec.

% É possível usar várias famílias tipográficas diferentes em um único
% documento LaTeX, mas isso não é trivial. Algumas (poucas) packages
% fornecem comandos prontos para ativar uma família tipográfica a partir
% de seu nome, como "\carlito", mas esse tipo de recurso raramente é
% utilizado. Ao invés disso, LaTeX considera que, em geral, um documento
% precisa de apenas três estilos de letras genéricos, acionados pelos
% comandos abaixo:
%
% * \rmfamily e \textrm -> letras serifadas, para o corpo do texto. É o
%   padrão inicial do documento;
%
% * \sffamily e \textsf -> letras sem serifa, para títulos ou "entidades".
%   Por exemplo, "a classe \textsf{TimeManager} é responsável..." ou
%   "chamamos \textsf{primos} os números que...". Observe que em quase
%   todos os casos desse tipo é mais adequado usar negrito ou itálico;
%
% * \ttfamily e \texttt -> letras "teletype", para trechos de programas.
%
% LaTeX também carrega uma fonte específica, visualmente similar à fonte
% serifada, ao ativar o modo matemático.
%
% Por padrão, esses comandos selecionam fontes da família "Computer Modern",
% mas diversas packages os redefinem para carregar outras. Algumas dessas
% packages alteram apenas uma das quatro fontes, enquanto outras alteram
% todas de uma vez de maneira que o conjunto seja coerente.

% Como dito acima, é possível mudar apenas uma das fontes. Em particular,
% a fonte teletype da família Computer Modern foi criada para simular as
% impressoras dos anos 1970/1980. Sendo assim, ela é uma fonte (1) com
% serifas e (2) de espaçamento fixo. Hoje em dia, é mais comum usar fontes
% sem serifa para representar código-fonte. Além disso, ao imprimir, é
% comum adotar fontes que não são de espaçamento fixo para fazer caber
% mais caracteres em uma linha de texto. Algumas opções de fontes para
% esse fim:
%\usepackage{newtxtt} % Não funciona com fontspec (lualatex / xelatex)
%\usepackage{DejaVuSansMono}
% inconsolata é uma boa fonte, mas não tem variante itálico
%\ifPDFTeX
%  \usepackage[narrow]{inconsolata}
%\else
%  \setmonofont{inconsolatan}
%\fi
%
% Também é possível usar Times como padrão; nesse caso, a fonte sem
% serifa usualmente é Helvetica e a fonte teletype em geral é Courier:
%\ifPDFTeX
%  \usepackage[helvratio=0.95,largesc]{newtxtext}
%  \usepackage{newtxtt} % Fonte teletype
%  \usepackage{newtxmath}
%\else
%  % Clone da fonte Times como fonte principal
%  \setmainfont{TeX Gyre Termes}
%  \setmathfont[Scale=MatchLowercase]{TeX Gyre Termes Math}
%  % TeX Gyre Termes Math tem um bug e não define o caracter
%  % \setminus; Vamos contornar esse problema usando apenas
%  % esse caracter da fonte STIX Two Math
%  \setmathfont[range=\setminus]{STIX Two Math}
%  % Clone da fonte Helvetica como fonte sem serifa
%  \setsansfont{TeX Gyre Heros}
%  % Clone da Courier como fonte teletype
%  %\setmonofont{TeX Gyre Cursor}
%\fi

\iftoggle{IMEfonts}{

  % Uma boa fonte teletype
  \RequirePackage[scale=.85]{sourcecodepro}

  % Uma ótima opção de família para o corpo do texto é a libertinus,
  % similar (mas não igual) à Times, mas com suporte a Small Caps e
  % outras qualidades. A fonte teletype da família é serifada, então
  % é melhor definir outra; a opção "mono=false" faz o pacote não
  % carregá-la, mantendo a escolha anterior.
  \RequirePackage[mono=false]{libertinus}

  \ifPDFTeX
    % A família libertinus por padrão não define uma fonte matemática
    % específica para pdfLaTeX; uma opção que funciona bem com ela:
    %\RequirePackage[libertine]{newtxmath}
    % Outra, provavelmente melhor:
    \RequirePackage{libertinust1math}
  \fi

  % Com LuaLaTeX/XeLaTeX, Libertinus configura também
  % a fonte matemática; aqui só precisamos corrigir \mathit
  \ifLuaTeX
    \setmathfontface\mathit{Libertinus Serif Italic}
  \fi
  \ifXeTeX
    % O nome de arquivo da fonte mudou na versão 2019-04-04
    \@ifpackagelater{libertinus-otf}{2019/04/03}
        {\setmathfontface\mathit{LibertinusSerif-Italic.otf}}
        {\setmathfontface\mathit{libertinusserif-italic.otf}}
  \fi

  % Vamos lembrar destas configurações
  \let\LibertinusSerifFont\rmdefault
  \let\LibertinusSansFont\sfdefault
  \let\SourceCodeProFont\ttdefault
  \let\LibertinusMDDefault\mddefault
  \let\LibertinusBFDefault\bfdefault
  \let\LibertinusUPdefault\updefault
  \let\LibertinusITdefault\itdefault
  \let\LibertinusSCdefault\scdefault
  \let\LibertinusFamily\familydefault
  \let\LibertinusSeries\seriesdefault
  \let\LibertinusShape\shapedefault
  \let\LibertinusMDrm\mdseries@rm
  \let\LibertinusMDsf\mdseries@sf
  \let\LibertinusMDtt\mdseries@tt
  \let\LibertinusBFrm\bfseries@rm
  \let\LibertinusBFsf\bfseries@sf
  \let\LibertinusBFtt\bfseries@tt

  % Este comando é definido pela package url, que é carregada automaticamente
  % por hyperref; ele faz URLs com fonte sem serifa ao invés de teletype
  \urlstyle{sf}

}{} % \iftoggle{IMEfonts}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ESTRUTURA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Packages úteis que são incompatíveis com beamer
\iftoggle{IMEbeamer}
  {}
  {
    % Ao criar uma referência hyperref para um float, a referência
    % aponta para o final do caption do float, o que não é muito bom.
    % Este pacote faz a referência apontar para o início do float (é
    % possível personalizar também).
    \RequirePackage[all]{hypcap}

    % Formatação personalizada das listas "itemize", "enumerate" e
    % "description", além de permitir criar novos tipos de listas. Com
    % a opção "inline", a package define os novos ambientes "itemize*",
    % "description*" e "enumerate*", que fazem os itens da lista como
    % parte de um único parágrafo.
    \RequirePackage[inline]{enumitem}

    % titlesec permite definir formatação personalizada de títulos,
    % seções etc. Observe que titlesec é incompatível com os comandos
    % refsection e refsegment do pacote biblatex! Aqui, carregamos a
    % package apenas para fazer os títulos alinhados à esquerda.
    \RequirePackage[raggedright]{titlesec}
  }

% Só numera até o nível 2 (subseções, como 2.3.1), ou seja, não numera
% sub-subseções (como 2.3.1.1). Veja que isso afeta referências
% cruzadas: se você fizer \ref{uma-sub-subsecao} sem que ela seja
% numerada, a referência vai apontar para a seção um nível acima.
% Veja também tocdepth abaixo.
\setcounter{secnumdepth}{2}

\iftoggle{IMEreport}{
  % Formatação personalizada do sumário, lista de tabelas/figuras etc.
  % Não utilizado neste modelo.
  %\RequirePackage{titletoc}

  % biblatex pode ser configurado para inserir a bibliografia no sumário;
  % bibtex não oferece essa possibilidade. Com esta package, resolvemos
  % esse problema.
  \RequirePackage[nottoc,notlot,notlof]{tocbibind}

  % Só olha até o nível 2 (subseções) para gerar o sumário e os
  % cabeçalhos, ou seja, não coloca nomes de subsubseções (nível 3)
  % no sumário nem nos cabeçalhos. Veja também secnumdepth acima.
  \setcounter{tocdepth}{2}

  % Normalmente, o capítulo de introdução não deve ser numerado, mas
  % deve aparecer no sumário. Por padrão, LaTeX não oferece uma solução
  % para isso, então modificamos aqui os comandos \chapter, \section,
  % \subsection e \subsubsection (embora este último provavelmente nunca
  % será útil) para que, ao serem chamados com dois asteriscos, eles
  % implementem esse comportamento.

  \let\IMEorigchapter\chapter
  \let\IMEorigsection\section
  \let\IMEorigsubsection\subsection
  \let\IMEorigsubsubsection\subsubsection

  \renewcommand\chapter{%
    \@ifstar
      {\@ifstar{\unnumberedchapter}{\IMEorigchapter*}}
      {\IMEorigchapter}%
  }

  \renewcommand\section{%
    \@ifstar
      {\@ifstar{\unnumberedsection}{\IMEorigsection*}}
      {\IMEorigsection}%
  }

  \renewcommand\subsection{%
    \@ifstar
      {\@ifstar{\unnumberedsubsection}{\IMEorigsubsection*}}
      {\IMEorigsubsection}%
  }

  \renewcommand\subsubsection{%
    \@ifstar
      {\@ifstar{\unnumberedsubsubsection}{\IMEorigsubsubsection*}}
      {\IMEorigsubsubsection}%
  }

  \newcommand\unnumberedchapter[2][]{
    \IMEorigchapter*{#2}
    \phantomsection
    \ifblank{#1}
      {\addcontentsline{toc}{chapter}{#2}\chaptermark{#2}}
      {\addcontentsline{toc}{chapter}{#1}\chaptermark{#1}}
  }

  \newcommand{\unnumberedsection}[2][]{
    \IMEorigsection*{#2}
    \phantomsection
    \ifblank{#1}
      {\addcontentsline{toc}{section}{#2}\sectionmark{#2}}
      {\addcontentsline{toc}{section}{#1}\sectionmark{#1}}
  }

  \newcommand{\unnumberedsubsection}[2][]{
    \IMEorigsubsection*{#2}
    \phantomsection
    \ifblank{#1}
      {\addcontentsline{toc}{subsection}{#2}}
      {\addcontentsline{toc}{subsection}{#1}}
  }

  \newcommand{\unnumberedsubsubsection}[2][]{
    \IMEorigsubsubsection*{#2}
    \phantomsection
    \ifblank{#1}
      {\addcontentsline{toc}{subsubsection}{#2}}
      {\addcontentsline{toc}{subsubsection}{#1}}
  }

}{} % \iftoggle{IMEreport}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%% CORES E APARÊNCIA DOS LINKS %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%% CORES
% Greeny colors (based on the InterSCity project main color)
\definecolor{InterSCity}{HTML}{00998C}
\definecolor{DarkInterSCity}{HTML}{0D6D65}
\definecolor{PastelGreen}{HTML}{73937E}

% Colors defined in the IME-USP visual identity manual
\definecolor{imeblue}{RGB}{20,45,105}
\definecolor{imeyellow}{RGB}{230,175,60}
\definecolor{imered}{RGB}{130,20,60}
\definecolor{imesoftblue}{RGB}{0,100,160}

% Generic colors
\definecolor{DarkRed}{HTML}{872718}
\definecolor{Blackish}{HTML}{232830}
\definecolor{SandyPaper}{HTML}{FFFCE2}
\definecolor{BrownishGreen}{HTML}{5F603A}

%%%%%% LINKS
\iftoggle{IMEhidelinks}
  {\hypersetup{hidelinks}}
  {}

\iftoggle{IMEcolorlinks}{
    \hypersetup{
      colorlinks=true, % também desabilita pdfborderstyle
      %citecolor=black,
      %linkcolor=black,
      %urlcolor=black,
      %filecolor=black,
      citecolor=DarkGreen,
      linkcolor=NavyBlue,
      urlcolor=DarkRed,
      filecolor=green,
      anchorcolor=black,
    }
}{}

\iftoggle{IMEborderlinks}{
    \hypersetup{
      colorlinks=false,
      pdfborder={0 0 .6},
      pdfborderstyle={/S/U/W .6},
      urlbordercolor=DodgerBlue,
      citebordercolor=green!30!white,
      linkbordercolor=blue!30!white,
      filebordercolor=green!30!white,
    }
}{}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% BIBLIOGRAFIA %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Tradicionalmente, bibliografias no LaTeX são geradas com uma combinação entre
% LaTeX (muitas vezes usando o pacote natbib) e um programa auxiliar chamado
% bibtex. Nesse esquema, LaTeX e natbib são responsáveis por formatar as
% referências ao longo do texto e a formatação da bibliografia fica por conta
% do programa bibtex. A configuração dessa formatação é feita através de um
% arquivo auxiliar de "estilo", com extensão ".bst". Vários journals etc.
% fornecem o arquivo .bst que corresponde ao formato esperado da bibliografia.
%
% bibtex e natbib funcionam bem e, se você tiver alguma boa razão para usá-los,
% obterá bons resultados. No entanto, bibtex tem dois problemas: não lida
% corretamente com caracteres acentuados (embora, na prática, funcione com
% os caracteres usados em português) e o formato .bst, que define a formatação
% da bibliografia, é complexo e pouco flexível.
%
% Por conta disso, a comunidade está migrando para um novo sistema chamado
% biblatex. No biblatex, as formatações da bibliografia e das citações são
% feitas pelo próprio pacote biblatex, dentro do LaTeX. Assim, é bem mais fácil
% modificar e personalizar o estilo da bibliografia. biblatex usa o mesmo
% formato de arquivo de dados do bibtex (".bib") e, portanto, não é difícil
% migrar de um para o outro. biblatex também usa um programa auxiliar (biber),
% mas não para realizar a formatação da bibliografia. A maior desvantagem de
% biblatex é que ele é significativamente mais lento que bibtex.
%
% Observe que biblatex pode criar bibliografias independentes por capítulo
% ou outras divisões do texto. Normalmente é preciso indicar essas seções
% manualmente, mas as opções "refsection" e "refsegment" fazem biblatex
% identificar cada capítulo/seção/etc como uma nova divisão desse tipo. No
% entanto, refsection e refsegment são incompatíveis com o pacote titlesec.
% Se você pretende criar bibliografias independentes por seções, há duas
% soluções: (1) desabilitar o pacote titlesec; (2) indicar as seções
% manualmente.
%
% Algumas dicas de configuração:
% https://tex.stackexchange.com/q/12806
% https://github.com/PaulStanley/biblatex-tutorial/releases

%%%%%%%%%%%%%%%%%%%
%%%% ATENÇÃO!! %%%%
%%%%%%%%%%%%%%%%%%%
%
% Com beamer, apenas estilos bibliográficos derivados de authortitle,
% numeric, alphabetic ou authoryear (como beamer-ime) vão funcionar
% corretamente! Outros estilos, como abnt ou apa, vão gerar problemas
% de layout que você vai precisar fazer ajustes manualmente. Observe
% que, num poster ou apresentação, provavelmente é uma boa ideia usar
% apenas \nocite e não \cite.

\iftoggle{IMEbiblatex}{

  \iftoggle{IMEreport}{
    \PassOptionsToPackage{
      % variante de autor-data, similar a plainnat
      style=extras/plainnat-ime,
      % Inclui, em cada item da bibliografia, links
      % para as páginas onde o item foi citado
      backref=true
    }{biblatex}
  }
  {
    \ifboolexpr{togl {IMEslides} or togl {IMEposter}}
      {\PassOptionsToPackage{style=extras/beamer-ime}{biblatex}}
      {\PassOptionsToPackage{style=numeric}{biblatex}}
      % TODO: allow the user to set the style
  }

  \RequirePackage[
    natbib=true, % Reconhece a sintaxe de natbib (\citet, \citep)
    hyperref=true, % Ativa o suporte ao pacote hyperref
    % Se um item da bibliografia tem língua definida (com langid), permite
    % hifenizar com base na língua selecionada.
    autolang=hyphen,
  ]{biblatex}

  % Numa apresentação/poster, a bibliografia pode usar fonte menor
  \iftoggle{IMEslides}
    {\renewcommand*\bibfont{\footnotesize}}
    {}

  \iftoggle{IMEposter}
    {\renewcommand*\bibfont{\scriptsize}}
    {}

  \iftoggle{IMEposter}{
    \DeclarePrintbibliographyDefaults{heading=none}

    \defbibenvironment{bibliography}
      {%
        \list
          {%
            \color{imeblue}\raisebox{.1em}{%
            \@IMEcharscale{.26}{\ensuremath{\blacktriangleright}}}%
          }
          {%
            \setlength{\leftmargin}{\bibhang}%
            \setlength{\itemindent}{0pt}%
            \setlength{\itemsep}{\bibitemsep}%
            \setlength{\parsep}{\bibparsep}%
          }%
      }
      {\endlist}
      {\item}
  }{}

  % TODO: remover menção ao bug de atendvi/hyperxmp em 2024
  % Impede que um item da bibliografia seja dividido em duas páginas.
  % À parte a estética, isso contorna este bug, que afeta links na
  % úlima página do trabalho, ou seja, pode afetar a bibliografia
  % (atenddvi pode ser carregada por hyperxmp):
  % https://github.com/ho-tex/atenddvi/issues/1
  \AtBeginBibliography{\interlinepenalty=10000\raggedbottom}

}{} % \iftoggle{IMEbiblatex}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DIVERSOS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%% FOOTNOTES
\iftoggle{IMEfootnotes}{
  % Formatação personalizada das notas de threeparttable:
  \appto{\TPTnoteSettings}{\footnotesize\itshape}
  \def\TPTtagStyle{\textit}

  % Formato personalizado para as notas de rodapé. Copiado quase
  % literalmente do exemplo na documentação das classes-padrão de
  % LaTeX2e (texdoc classes). Seria possível fazer algo similar
  % usando list{} com um único item usando \@thefnmark como label.

  % \footnotesep não é um espaço adicional, mas sim um strut que
  % existe no começo de cada nota. É por isso que o valor é "grande"
  % (\baselineskip) mas a separação de fato é pequena.

  \renewcommand\@makefntext[1]{%
      \setlength{\footnotesep}{1\baselineskip}%
      \@setpar{%
          \@@par
          \@tempdima = \hsize
          \advance\@tempdima-4pt\relax
          \parshape \@ne 4pt \@tempdima
      }%
      \par
      \parindent 1em\noindent
      \parskip .3\baselineskip
      \hbox to \z@{\hss\@makefnmark\,}#1%
  }

  % \maketitle redefine as notas de rodapé (\thanks) para usar símbolos
  % ao invés de números, mas essa não é a única mudança. A versão de
  % \maketitle da classe article também muda \@makefnmark para que a
  % indicação de nota de rodapé não ocupe espaço horizontal (usando
  % \rlap). Isso é feito porque a lista de autores em geral é similar a
  % \author{Fulano\thanks{instituição 1}, Ciclano\thanks{instituição 2}}.
  % Com essa mudança, a nota aparece acima da vírgula entre os autores.
  % Mas isso significa que \maketitle precisa também modificar \@makefntext
  % para que esse efeito aconteça apenas na lista de autores e não na
  % nota em si. Assim, como criamos um novo formato para as notas de
  % rodapé, precisamos mudar o formato em \maketitle também.

  \newcommand\@maketitlemakefntext[1]{%
      \setlength{\footnotesep}{1\baselineskip}%
      \@setpar{%
          \@@par
          \@tempdima = \hsize
          \advance\@tempdima-4pt\relax
          \parshape \@ne 4pt \@tempdima
      }%
      \par
      \parindent 1em\noindent
      \parskip .3\baselineskip
      \hbox to \z@{\hss\@textsuperscript{\normalfont\@thefnmark}\,}#1%
  }

  % Primeiro tentamos alterar a versão padrão de \maketitle, mas isso
  % provavelmente vai falhar porque carregamos a package hyperref.
  % Nesse caso, fazemos a alteração na versão modificada por ela. Se
  % não estamos usando a classe article, nenhuma das duas alterações
  % vai funcionar, mas isso não é um problema.
  \patchcmd\maketitle
    {\long\def\@makefntext}
    {\let\@makefntext\@maketitlemakefntext\long\def\@disabledmakefntext}
    {}
    {
      \patchcmd\HyOrg@maketitle
        {\long\def\@makefntext}
        {\let\@makefntext\@maketitlemakefntext\long\def\@disabledmakefntext}
        {}{}
    }
}{} % \iftoggle{IMEfootnotes}

%%%%%%%%% SPACING
\iftoggle{IMEspacing}{

  % LaTeX por default segue o estilo americano e não faz a indentação da
  % primeira linha do primeiro parágrafo de uma seção; este pacote ativa
  % essa indentação, como é o estilo brasileiro
  \RequirePackage{indentfirst}

  % Em documentos frente-e-verso, LaTeX faz o final da página terminar sempre
  % no mesmo lugar (exceto no final dos capítulos). Esse comportamento pode ser
  % ativado explicitamente com o comando "\flushbottom". Mas se, por alguma
  % razão, o volume de texto na página é "pequeno", essa página vai ter espaços
  % verticais artificialmente grandes. Uma solução para esse problema é utilizar
  % "\raggedbottom" (padrão em documentos que não são frente-e-verso): com essa
  % opção, as páginas podem terminar em alturas ligeiramente diferentes. Outra
  % opção é corrigir manualmente cada página problemática, por exemplo com o
  % comando "\enlargethispage".
  %\raggedbottom
  \flushbottom

  % Por padrão, LaTeX coloca uma espaço aumentado após sinais de pontuação;
  % Isso não é tão bom quanto alguns TeX-eiros defendem :) .
  % Esta opção desabilita isso e, consequentemente, evita problemas com
  % "id est" (i.e.) e "exempli gratia" (e.g.)
  \frenchspacing

  % A primeira linha de cada parágrafo costuma ter um pequeno recuo para
  % tornar mais fácil visualizar onde cada parágrafo começa. Além disso, é
  % possível colocar um espaço em branco entre um parágrafo e outro. Esta
  % package coloca o espaço em branco e desabilita o recuo; como queremos
  % o espaço *e* o recuo, é preciso guardar o valor padrão do recuo e
  % redefini-lo depois de carregar a package.
  % TODO: depois que ubuntu 18.04 se tornar obsoleta (abril/2023), remover
  %       as linhas "oldparindent" e carregar a package com a opção "indent".
  \ifboolexpr{togl {IMEslides} or togl {IMEposter}}
    {}
    {
      \newlength\oldparindent
      \setlength\oldparindent\parindent
      \RequirePackage[parfill]{parskip}
      \setlength\parindent\oldparindent

      % Prefer paragraph formatting in which the last line is not too short.
      % TODO: check the "appendix A" line break in the example text.
      \setlength\parfillskip{30pt plus .8\linewidth minus 30pt\relax}
    }


  \ifboolexpr{togl {IMEbeamer} or togl {IMEposter}}
    {}
    {
      % Ao invés de definir o tamanho das margens, vamos definir os tamanhos do
      % texto, do cabeçalho e do rodapé, e deixamos a package geometry calcular
      % o tamanho das margens em função do tamanho do papel. Assim, obtemos o
      % mesmo resultado impresso, mas com margens diferentes, se o tamanho do
      % papel for diferente.
      \geometry{
        textwidth=152mm,
        hmarginratio=12:17, % 24:34 -> com A4: 24mm + 152mm + 34mm = 210mm
        textheight=237mm,
        vmarginratio=8:7, % 32:28 -> com A4: 32mm + 237mm + 28mm = 297mm
        headsep=11mm, % distância entre a base do cabeçalho e o texto
        headheight=21mm, % qquer medida grande o suficiente, ex: top - headsep
        footskip=10mm,
        marginpar=20mm,
        marginparsep=5mm,
      }
    }

}{} % \iftoggle{IMEspacing}

%%%%%%%%%%%%% CAPTIONS
\iftoggle{IMEcaptions}{
  % Captions com fonte menor, indentação normal, corpo do texto
  % negrito e nome do caption itálico
  \RequirePackage[
    font=small,
    format=plain,
    labelfont={bf,up},
    textfont={normalfont,it}]{caption}

  % Em geral, a package caption é capaz de "adivinhar" se o caption
  % está acima ou abaixo da figura/tabela, mas isso não funciona
  % corretamente com longtable. Aqui, forçamos a package a considerar
  % que os captions ficam abaixo das tabelas.
  \captionsetup*[longtable]{position=bottom}
}{}

%%%%%%%%%% PGFGANTT (GANTT CHARTS)
% Estes parâmetros definem a aparência das gantt charts e variam
% em função da fonte do documento.
\ganttset{
    vgrid,
    x unit=1.7em,
    y unit title=3ex,
    y unit chart=4ex,
    % O "strut" é necessário para alinhar o baseline dos nomes dos meses
    title label font=\strut\footnotesize,
    group label font=\footnotesize\bfseries,
    bar label font=\footnotesize,
    milestone label font=\footnotesize\itshape,
    % "align=right" é necessário para \ganttalignnewline funcionar
    group label node/.append style={align=right},
    bar label node/.append style={align=right},
    milestone label node/.append style={align=right},
    group incomplete/.append style={fill=black!50},
    bar/.append style={fill=black!25,draw=black},
    bar incomplete/.append style={fill=white,draw=black},
    % Não é preciso imprimir "0%"
    progress label text=\ifnumequal{#1}{0}{}{(#1\%)},
    % Formato e tamanho dos elementos
    title height=.9,
    group top shift=.4,
    group left shift=0,
    group right shift=0,
    group peaks tip position=0,
    group peaks width=.2,
    group peaks height=.3,
    milestone height=.4,
    milestone top shift=.4,
    milestone left shift=.8,
    milestone right shift=.2,
}

















%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% METADADOS XMP %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% TODO: Com versões recentes de hyperxmp (final de 2020), não é
%       recomendado definir pdflang; no futuro, isto deve ser mudado.
\AtEndPreamble{
\IfLanguagePatterns{brazilian}
  {
    \hypersetup{
      pdflang={pt},
      pdfmetalang={pt},
    }
  }
  {
    \hypersetup{
      pdflang={en},
      pdfmetalang={en},
    }
  }
}































%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% PÔSTERES E APRESENTAÇÕES %%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Nos pôsteres e apresentações, os triângulos às vezes ficam de tamanhos
% diferentes com pdflatex e lualatex; para contornar isso, vamos (1)
% redimensionar para o tamanho do \strut e (2) redimensionar para o
% tamanho desejado.
\newcommand\@IMEcharscale[2]{%
    \bgroup
    \scalebox{#1}{\resizebox*{!}{\totalheightof{\strut}}{#2}}%
    \egroup
}

\iftoggle{IMEslides}{
  \usetheme{imeusp} % baseado no tema metropolis
  \usepackage{appendixnumberbeamer}
  % Desabilita a cor de rodapé
  \setbeamercolor{footline}{fg=,bg=}

  % Com lualatex/xelatex, o tema metropolis usa a fonte Fira;
  % aqui, voltamos à fonte libertinus, carregada anteriormente
  \iftoggle{IMEfonts}{
    \let\rmdefault\LibertinusSerifFont
    \let\sfdefault\LibertinusSansFont
    \let\ttdefault\SourceCodeProFont
    \let\mddefault\LibertinusMDDefault
    \let\bfdefault\LibertinusBFDefault
    \let\updefault\LibertinusUPdefault
    \let\itdefault\LibertinusITdefault
    \let\scdefault\LibertinusSCdefault
    \let\familydefault\LibertinusFamily
    \let\seriesdefault\LibertinusSeries
    \let\shapedefault\LibertinusShape
    \let\mdseries@rm\LibertinusMDrm
    \let\mdseries@sf\LibertinusMDsf
    \let\mdseries@tt\LibertinusMDtt
    \let\bfseries@rm\LibertinusBFrm
    \let\bfseries@sf\LibertinusBFsf
    \let\bfseries@tt\LibertinusBFtt
  }{}

}{} % \iftoggle{IMEslides}

\iftoggle{IMEposter}{
    % Coloca uma imagem no rodapé à direita
    \newcommand{\footimage}[1]{%
        \ifstrempty{#1}
          {}
          {%
            \tikz[overlay,remember picture]
            \node[anchor=south east,inner sep=12pt] at
            (current page.south east) {#1};%
          }%
    }

    \parindent=0pt
    \parskip=0pt
    \setstretch{1.1}

    \renewcommand*\familydefault{\sfdefault}

    \iftoggle{IMEspacing}
        {\geometry{left=1.5cm,right=1.5cm,top=0cm,bottom=0cm}}
        {}

    \usepackage[poster,skins]{tcolorbox}

    \tcbposterset{
      fontsize = 32pt,
      no coverage,
    }

    \tcbset{
        skin=enhanced,
        valign=center,
        before upper = \evenRaggedRight,
        fonttitle = \large,
        top=.3\baselineskip,
        bottom=.3\baselineskip,
        toptitle=.1\baselineskip,
        bottomtitle=.1\baselineskip,
        left=.4\baselineskip,
        right=.6\baselineskip,
        colframe = imesoftblue,
        colback = SandyPaper,
    }

    \setlist{
        first={\evenRaggedRight},
        parsep=0pt,
        itemsep=0pt,
        topsep=0pt,
        partopsep=0pt,
    }

    \setlist[itemize,1]{
      left = 0pt .. .8em,
      label={\color{imeblue}\raisebox{.1em}{%
             \@IMEcharscale{.26}{\ensuremath{\blacktriangleright}}}}
    }

    \setlist[itemize,2]{
      before*={\footnotesize},
      left = -5pt .. .8em,
      label={\color{imeblue}\raisebox{-.1em}{%
             \@IMEcharscale{.4}{\ensuremath{\bullet}}}}
    }

    \setlist[itemize,3]{
      before*={\footnotesize\itshape},
      left = -1pt .. .95em,
      label={\color{imeblue}\raisebox{.05em}{%
             \@IMEcharscale{.3}{\normalfont\textbf{\guillemotright}}}}
    }

    \tcbsubskin{title}{enhanced}{colback=imeblue, coltext=white,
                                 borderline south={15pt}{-5pt}{imeyellow},
                                 boxsep=10mm, grow sidewards by = 2.3cm}

    \tcbsubskin{footer}{enhanced}{colback=imesoftblue, coltext=white,
                                  borderline north={15pt}{-5pt}{imeyellow},
                                  boxsep=4mm, left=30pt,
                                  grow sidewards by = 2.3cm}
}{} % \iftoggle{IMEposter}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%% CABEÇALHOS E RODAPÉS (REPORT/TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEreport}{

  % Permite saber o número total de páginas; útil para colocar no
  % rodapé algo como "página 3 de 10" com "\thepage\ de \zpageref{LastPage}"
  %\RequirePackage{zref-lastpage,zref-user}

  % Permite definir cabeçalhos e rodapés
  \RequirePackage{fancyhdr}

  % A formatação dos cabeçalhos/rodapés envolve duas coisas:
  %
  % 1. Definir qual texto deve ser impresso em cada página (nome
  %    do capítulo ou seção, nome do autor, número da página etc.)
  %
  % 2. Imprimir esse texto no lugar correto (esquerda, direita ou
  %    centro, cabeçalho ou rodapé)
  %
  % A definição do texto a imprimir é complexa, pois a preparação dos
  % cabeçalhos/rodapés acontece de maneira independente da construção do
  % restante da página. Textos fixos como, digamos, o nome do livro ou
  % do seu autor, não trazem dificuldades. Já textos variáveis, como o
  % nome do capítulo ou seção, o número da página etc. envolvem a
  % passagem de informações sobre a página atual para o mecanismo de
  % construção dos cabeçalhos.
  %
  % Isso é feito através de "variáveis" especiais chamadas "marks". O uso
  % mais comum das marks é armazenar o nome do capítulo e da seção atuais:
  % a cada novo capítulo ou seção, os comandos \chaptermark e \sectionmark
  % são executados (isso é automático, você não precisa fazer nada); esses
  % comandos definem uma "mark" com o nome do capítulo/seção a ser usado
  % nos cabeçalhos/rodapés. Assim, modificando a definição dos comandos
  % \chaptermark e \sectionmark, é possível modificar o texto a ser
  % incluído nos cabeçalhos/rodapés.
  %
  % Definido o conteúdo das marks, o lugar em que cada texto é impresso
  % é definido com os comandos \fancyhead e \fancyfoot. "RO" significa
  % "Right side of Odd pages"; "LE" significa "Left side of Even pages" etc.
  %
  % LaTeX por padrão tem duas "marks": "\leftmark" e "\rightmark". Elas
  % têm esses nomes porque originalmente eram usadas para armazenar o
  % conteúdo a ser impresso nas páginas pares e ímpares. Isso, no entanto,
  % não é obrigatório; a escolha desses nomes foi bastante infeliz. Para
  % definir o conteúdo dessas marks, usam-se os comandos \markboth{A}{B}
  % (define \leftmark como A e \rightmark como B) e \markright{C} (define
  % \rightmark como C). Não há o comando \markleft.
  %
  % O procedimento de definição dos cabeçalhos e rodapés, portanto, envolve:
  %
  % 1. Redefinir \chaptermark e \sectionmark (ambas recebem um parâmetro,
  %    que é o nome do capítulo/seção) para fazê-los executar \markboth e
  %    \markright, inserindo o conteúdo desejado nas marks;
  %
  % 2. Usar \fancyhead e \fancyfoot para definir os cabeçalhos e rodapés
  %    usando o conteúdo de \leftmark e \rightmark.
  %
  % Além das marks, é possível usar também as variáveis \thepage (número
  % da página), \thechapter (número do capítulo) e \thesection (número da
  % seção).
  %
  % Neste modelo, modificamos chaptermark e sectionmark para armazenar
  % o número e nome do capítulo em leftmark e o número e nome da seção
  % em rightmark. MAS imprimimos rightmark nas páginas pares (esquerda)
  % e leftmark nas páginas ímpares (direita)!
  %%%%%%%%%%

  % Sem linha separando o cabeçalho
  \renewcommand{\headrulewidth}{0pt}

  % Queremos colocar o número da página mais próximo da borda do papel (na
  % horizontal). Para isso, vamos aumentar \headwidth, somando "tamanho da
  % margem direita -10mm" (o número vai ficar a 10mm da borda).
  %
  % Observe que a package geometry define \evensidemargin, mas seu valor não
  % necessariamente corresponde ao que queremos aqui (não sei bem como nem
  % por que geometry define esse valor). Ao invés de usá-lo, vamos calcular
  % manualmente.
  %
  % A distância entre a borda esquerda/interna do papel e o início do texto
  % é dada por (1in + \hoffset + \oddsidemargin); a margem direita, portanto,
  % é dada por (\paperwidth - (1in + \hoffset + \oddsidemargin + \textwidth)).
  %
  \dimdef{\othermargin}{\paperwidth - 1in - \hoffset - \oddsidemargin - \textwidth}
  \addtolength{\headwidth}{\othermargin}
  \addtolength{\headwidth}{-10mm}

  \newcommand{\formataNumPaginas}{
    \fancyhead[RO]{\raisebox{8mm}{\footnotesize\bfseries\thepage}}
    \fancyhead[LE]{\raisebox{8mm}{\footnotesize\bfseries\thepage}}
  }

  \newcommand{\formataCabecalhosDinamicos}{
    \fancyhead[LO]{\scriptsize\MakeTextUppercase{\rightmark}}
    \fancyhead[RE]{\scriptsize\MakeTextUppercase{\leftmark}}
  }

  \fancypagestyle{mainmatter}{
    % Número e nome do capítulo no cabeçalho das páginas pares
    % (e nas ímpares quando não há seções)
    \renewcommand{\chaptermark}[1]{
      \markboth
        {\thechapter\hskip 0.3em |\hskip 0.3em ##1}
        {\thechapter\hskip 0.3em |\hskip 0.3em ##1}
    }

    % Número e nome da seção no cabeçalho das páginas ímpares
    \renewcommand{\sectionmark}[1]{
      \markright{\thesection\hskip 0.3em |\hskip 0.3em ##1}
    }

    \fancyhf{}
    \formataNumPaginas{}
    \formataCabecalhosDinamicos{}
  }

  % Formato para capítulos não-numerados mas que devem
  % aparecer no sumário (tipicamente, a introdução):
  \fancypagestyle{unnumberedchapter}{
    % Só o nome do capítulo/seção, sem numeração
    \renewcommand{\chaptermark}[1]{\markboth{##1}{##1}}
    \renewcommand{\sectionmark}[1]{\markright{##1}}

    \fancyhf{}
    \formataNumPaginas{}
    \formataCabecalhosDinamicos{}
  }

  \fancypagestyle{appendix}{
    \renewcommand{\chaptermark}[1]{%
      \markboth{%
        % Páginas ímpares: "Apêndice/Anexo X"
        \@chapapp\ \thechapter%
      }{%
        % Páginas pares: "X | nome do apêndice/anexo"
        \thechapter\hskip 0.3em |\hskip 0.3em ##1%
      }
    }

    \fancyhf{}
    \formataNumPaginas{}
    \formataCabecalhosDinamicos{}
  }

  % Na frontmatter e backmatter, não há números de capítulos e (em geral)
  % não há subdivisões (capítulos/seções/subseções), apenas um nível.
  % O correto, então, é usar o mesmo texto (nome do capítulo ou seção,
  % sem número) nas páginas pares ou ímpares.
  %
  % Normalmente, a bibliografia e o índice remissivo não definem os
  % cabeçalhos (não executam "chaptermark/sectionmark"), mas "forçamos"
  % isso manualmente (em bibconfig.tex e index.tex).
  \fancypagestyle{backmatter}{
    \renewcommand{\chaptermark}[1]{\markboth{##1}{##1}}
    \renewcommand{\sectionmark}[1]{\markboth{##1}{##1}}

    \fancyhf{}
    \formataNumPaginas{}
    \formataCabecalhosDinamicos{}
  }

  % A página inicial de cada capítulo é automaticamente configurada para
  % o estilo "plain", então vamos definir esse estilo (colocando o número
  % de página no mesmo lugar das demais). As páginas iniciais também usam
  % esse estilo.
  \fancypagestyle{plain}{
    \fancyhf{}
    \formataNumPaginas{}
  }

}{} % \iftoggle{IMEreport}






















%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%% EPÍGRAFE (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}{

  % O formato padrão do pacote epigraph é bem feinho...
  % Outra opção para epígrafes é o pacote quotchap
  \RequirePackage{epigraph}

  \setlength\epigraphwidth{.85\textwidth}

  % Sem linha entre o texto e o autor
  \setlength{\epigraphrule}{0pt}

  % Ambiente auxiliar para colocar margem à direita da epígrafe
  % (como sempre, o modo mais simples de mudar as margens de um
  % pagrágrafo é fazer de conta que é uma lista)
  \newenvironment{epShiftLeft}
    {
      \par\begin{list}{}
        {
          \leftmargin 0pt
          \labelwidth 0pt
          \labelsep 0pt
          \itemsep 0pt
          \topsep 0pt
          \partopsep 0pt
          \rightmargin 2em
        }
      \item\FlushRight
    }
    {
      \end{list}
      % O espaço padrão que epigraph coloca entre a citação
      % e o autor é muito pequeno; vamos aumentar um pouco
      \vspace*{.3\baselineskip}
    }

  \renewcommand\textflush{epShiftLeft}
  \renewcommand\sourceflush{epShiftLeft}

  \newcommand{\epigrafe}[2] {%
    \ifstrempty{#2}{
      \epigraph{\itshape #1}{}
    }{
      \epigraph{\itshape #1}{--- #2}
    }
  }

}{} % \iftoggle{IMEthesis}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%% DEDICATÓRIA (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% A dedicatória vai em uma página separada, sem numeração,
% com o texto alinhado à direita e margens esquerda e
% superior muito grandes. Vamos fazer isso com uma minipage.

\iftoggle{IMEthesis}{
  \newenvironment{dedicatoria} {
    \hypersetup{pageanchor=false} % Veja comentário em \maketitle

    \if@openright\cleardoublepage\else\clearpage\fi

    \thispagestyle{empty}
    \vspace*{140mm plus 0mm minus 100mm}
    \noindent
    \begin{FlushRight}
       \begin{minipage}[b][100mm][b]{100mm}
         \begin{FlushRight}
           \itshape
  } {
         \end{FlushRight}
       \end{minipage}\hspace*{3em}
    \end{FlushRight}
    \vspace*{50mm plus 0mm minus 10mm}
    \if@openright\cleardoublepage\else\clearpage\fi

    \hypersetup{pageanchor=true}
  }
}{} % \iftoggle{IMEthesis}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% RESUMO (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}{
  % A página de resumo deve existir em português e inglês; ambas as versões
  % utilizam o mesmo environment.

  \NewDocumentCommand{\resumo}{+m}{%
    \long\gdef\@resumo{#1}%

    \bgroup
    \@IMEremoveLinebreaksEtc{\@resumo}
    \IfLanguagePatterns{brazilian}
      {
        \hypersetup{
          pdfsubject={\@resumo},
          pdfkeywords={\@commakeywordspt},
        }
      }
      {
        \XMPLangAlt{pt}{pdfsubject={\@resumo}}
        % o item "keywords" não pode ser traduzido

        % XMPLangAlt undefines "\do"; this may cause
        % problems with biblatex, but we do not need
        % to worry here because we are in a group.
        % https://github.com/plk/biblatex/issues/1105
      }
    \egroup

    \bgroup\bgroup % Dois grupos aninhados, veja a documentação da package babel
    \selectlanguage{brazilian}
    \begin{IMEabstract}\@resumo\end{IMEabstract}
    \egroup\egroup
  }

  \DeclareDocumentCommand{\abstract}{+m}{%
    \long\gdef\@abstract{#1}%

    \bgroup
    \@IMEremoveLinebreaksEtc{\@abstract}
    \IfLanguagePatterns{brazilian}
      {
        \XMPLangAlt{en}{pdfsubject={\@abstract}}
        % o item "keywords" não pode ser traduzido

        % XMPLangAlt undefines "\do"; this may cause
        % problems with biblatex, but we do not need
        % to worry here because we are in a group.
        % https://github.com/plk/biblatex/issues/1105
      }
      {
        \hypersetup{
          pdfsubject={\@abstract},
          pdfkeywords={\@commakeywordsen},
        }
      }
    \egroup

    \bgroup\bgroup % Dois grupos aninhados, veja a documentação da package babel
    \selectlanguage{english}
    \begin{IMEabstract}\@abstract\end{IMEabstract}
    \egroup\egroup
  }

  \NewDocumentEnvironment{IMEabstract}{} {
    \if@openright\cleardoublepage\else\clearpage\fi
    \thispagestyle{empty}

      \begin{center}\Large\bfseries\abstractname\end{center}

    \vspace*{2em plus 1em minus 1em}

    \footnotesize

    % Esse é o jeito mais simples de mudar as margens de um parágrafo:
    % faz de conta que é uma lista
    \begin{list}{}{\rightmargin 4em \leftmargin 4em}
      \item\@selfReference
    \end{list}

    \vspace*{1em plus 1em minus 0em}
  } {
    % Impede uma quebra de página entre esta linha e a próxima, ou seja,
    % entre a última linha do resumo/abstract e as palavras-chave.
    \@afterheading

    \vspace*{1em plus 1em minus .5em}

    \begingroup

        \setlength{\leftmargini}{\widthof{\textbf{\keywordsname:}\quad}}
        \setlength{\labelwidth}{\widthof{\textbf{\keywordsname:}}}
        \setlength{\labelsep}{\widthof{\quad}}

        \begin{description}
          \item[\keywordsname:]\IfLanguagePatterns{brazilian}
                               {\@keywordspt}
                               {\@keywordsen}%
        \end{description}

    \endgroup
  }

}{} % \iftoggle{IMEthesis}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%% TEXTOS PADRÃO PARA A CAPA (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}{
    % Formatação de datas de acordo com a língua
    \RequirePackage[useregional]{datetime2}
    \DTMusemodule{brazilian}{portuges}
    \DTMnewdatestyle{month-year}{%
      \renewcommand*{\DTMdisplaydate}[4]{##2,\space##1}%
      \renewcommand*{\DTMDisplaydate}{\DTMdisplaydate}%
    }

    % \extrasLANGUAGE vs \captionsLANGUAGE: https://tex.stackexchange.com/a/354197

    % Palavras fixas a serem traduzidas
    \providecommand\keywordsname{} % Keywords / Palavras-chave
    \providecommand\programname{} % Program / Programa
    \providecommand\committeename{} % Examining committee / Comissão julgadora
    \providecommand\advisorname{} % Advisor / Orientador(a)
    \providecommand\coadvisorname{} % Co-advisor / Coorientador(a)
    \providecommand\workname{} % Report, Thesis / Tese, Dissertação, Monografia
    \providecommand\degreename{} % Masters, Doctorate, Bachelor / Mestrado, Doutorado, Bacharelado
    \providecommand\titlename{} % Master, Doctor, Bachelor / Mestre(a), Doutor(a), Bacharel
    \providecommand\@assembleLicenseText[1]{O conteúdo deste trabalho
                                            é publicado sob a licença #1}

    % Textos longos a serem traduzidos
    \providecommand\@coverTCCText{}
    \providecommand\@coverQualiText{}
    \providecommand\@coverThesisText{}
    \providecommand\@institutionBlockText{} % Só para TCC
    \providecommand\@provisionalFrontmatterText{}
    \providecommand\@finalFrontmatterText{}
    \providecommand\@institution{}

    % Este não precisa ser traduzido, o texto em inglês não utiliza
    \providecommand\@bywhom{%
      \ifdefstring{\@authorGender}{masc}
        {pelo candidato \@author}
        {pela candidata \@author}%
    }

    %%%%%%%%%% PORTUGUÊS %%%%%%%%%%
    \addto\captionsbrazilian{%
      \DTMrenewdatestyle{month-year}{%
        \renewcommand*{\DTMdisplaydate}[4]
          {\DTMportugesmonthname{##2}\space de\space##1}%
      }%
      \renewcommand\keywordsname{Palavras-chave}%
      \renewcommand\programname{Programa}%
      \renewcommand\committeename{Comissão julgadora}%
      \renewcommand\advisorname{%
        \iftoggle{@tcc}{%
          \ifdefstring{\@advisorGender}{masc}
            {Supervisor}
            {Supervisora}%
        }{%
          \ifdefstring{\@advisorGender}{masc}
            {Orientador}
            {Orientadora}%
        }%
      }%
      \renewcommand\coadvisorname[1]{%
        \iftoggle{@tcc}{%
          \ifcsstring{@coadvisor#1Gender}{masc}
            {Cossupervisor}
            {Cossupervisora}%
        }{%
          \ifcsstring{@coadvisor#1Gender}{masc}
            {Coorientador}
            {Coorientadora}%
        }%
      }%
      \renewcommand\workname{%
        \iftoggle{@tcc}
          {Monografia}
          {\iftoggle{@qualificacao}
            {Exame de Qualificação}
            {\iftoggle{@doutorado}
              {Tese}
              {Dissertação}%
            }%
          }%
      }%
      \renewcommand\degreename{%
        \iftoggle{@doutorado}
          {Doutorado}
          {\iftoggle{@mestrado}
            {Mestrado}
            {\iftoggle{@tcc}
              {Bacharelado}
              {Nível não definido!}%
            }%
          }%
      }%
      \renewcommand\titlename{%
        \iftoggle{@doutorado}
          {\ifdefstring{\@authorGender}{masc}{Doutor}{Doutora}}
          {\iftoggle{@mestrado}
            {\ifdefstring{\@authorGender}{masc}{Mestre}{Mestra}}
            {\iftoggle{@tcc}
              {Bacharel}{Nível não definido!}%
            }%
          }%
      }%
      %
      %
      \renewcommand\@coverTCCText{%
        Monografia Final\vspace{.5\baselineskip}\\
        \@macCDXCIX{} --- Trabalho de\\
        Formatura Supervisionado%
      }%
      \renewcommand\@coverQualiText{%
        Relatório apresentado ao\\
        Instituto de Matemática e Estatística\\
        da Universidade de São Paulo\\
        para exame de qualificação de\\
        \degreename{} em Ciências%
      }%
      \renewcommand\@coverThesisText{%
        \workname{} apresentada ao\\
        Instituto de Matemática e Estatística\\
        da Universidade de São Paulo\\
        para obtenção do título de\\
        \titlename{} em Ciências%
      }%
      \renewcommand\@institutionBlockText{%
        Universidade de São Paulo\\
        Instituto de Matemática e Estatística\\
        Bacharelado em Ciência da Computação%
      }%
      \renewcommand\@provisionalFrontmatterText{%
        \iftoggle{@qualificacao}{%
          Esta é a versão original do texto de qualificação elaborado
          \@bywhom{}, tal como submetido à Comissão Julgadora.%
        }{%
          Esta é a versão original da \MakeTextLowercase{\workname} elaborada
          \@bywhom{}, tal como submetida à Comissão Julgadora.%
        }%
      }%
      \renewcommand\@finalFrontmatterText{%
        Esta versão da \MakeTextLowercase{\workname} contém as correções e alterações
        sugeridas pela Comissão Julgadora durante a defesa da versão
        original do trabalho, realizada em \DTMusedate{@defensedate}.\\[1\baselineskip]
        Uma cópia da versão original está disponível no Instituto de
        Matemática e Estatística da Universidade de São Paulo.%
      }%
      \renewcommand\@institution{%
        Instituto de Matemática e Estatística,
        Universidade de São Paulo%
      }%
      \renewcommand{\@assembleLicenseText}[1]{O conteúdo deste trabalho
                                              é publicado sob a licença #1}%
    }


    %%%%%%%%%% INGLÊS %%%%%%%%%%
    \addto\captionsenglish{%
      \DTMrenewdatestyle{month-year}{%
        \renewcommand*{\DTMdisplaydate}[4]
          {\DTMenglishmonthname{##2},\space##1}%
      }%
      \renewcommand\keywordsname{Keywords}%
      \renewcommand\programname{Program}%
      \renewcommand\committeename{Examining Committee}
      \renewcommand\advisorname{%
        \iftoggle{@tcc}{Supervisor}{Advisor}%
      }%
      \renewcommand\coadvisorname[1]{%
        \iftoggle{@tcc}{Co-supervisor}{Coadvisor}%
      }%
      % "Tese" e "dissertação" têm sentido contrário em língua inglesa:
      % http://guides.lib.berkeley.edu/dissertations_theses
      % https://www.grad.ubc.ca/handbook-graduate-supervision/graduate-thesis
      % Como "Thesis" é o nome genérico, vamos usar para mestrado e doutorado
      %
      %%%%%
      %
      % Nomes possíveis para o TCC em inglês:
      %
      % * monograph/monography
      %     usado para trabalho de alto nível de um autor "senior",
      %     então não faz sentido para um trabalho de graduação.
      %
      % * undergraduate thesis / bachelor's thesis
      %     plausível, mas no nosso caso report parece melhor.
      %
      % * senior project / senior thesis / honor thesis
      %     usado para "TCCs" de caráter fortemente acadêmico;
      %     não é o caso aqui.
      %
      % * essay / report
      %     razoável, porque trata-se de um texto/relato
      %     sobre o projeto de TCC.
      \renewcommand\workname{%
        \iftoggle{@tcc}
          {Capstone Project Report}
          {\iftoggle{@qualificacao}
            {Qualifying Exam}
            {Thesis}%
          }%
      }%
      \renewcommand\degreename{%
        \iftoggle{@doutorado}
          {Doctorate}
          {\iftoggle{@mestrado}
            {Master's}
            {\iftoggle{@tcc}
              {Bachelor}
              {Nível não definido!}%
            }%
          }%
      }%
      \renewcommand\titlename{%
        \iftoggle{@doutorado}
          {Doctor}
          {\iftoggle{@mestrado}
            {Master}
            {\iftoggle{@tcc}
              {Bachelor}%
              {Nível não definido!}%
            }%
          }%
      }%
      %
      %
      \renewcommand\@coverTCCText{%
        Final Essay\vspace{.5\baselineskip}\\
        \@macCDXCIX{} --- Capstone Project%
      }%
      \renewcommand\@coverQualiText{%
        Report presented to the\\
        Institute of Mathematics and Statistics\\
        of the University of São Paulo\\
        for the \titlename{} of Science\\
        qualifying examination\\%
      }%
      \renewcommand\@coverThesisText{%
        \workname{} presented to the\\
        Institute of Mathematics and Statistics\\
        of the University of São Paulo\\
        in partial fulfillment\\
        of the requirements\\
        for the degree of\\
        \titlename{} of Science%
      }%
      \renewcommand\@institutionBlockText{%
        University of São Paulo\\
        Institute of Mathematics and Statistics\\
        Bachelor of Computer Science%
      }%
      \renewcommand\@provisionalFrontmatterText{%
        \iftoggle{@qualificacao}{%
          This is the original version of the qualifying text prepared
          by candidate \@author, as submitted to the Examining Committee.%
        }{%
          This is the original version of the \MakeTextLowercase{\workname} prepared
          by candidate \@author, as submitted to the Examining Committee.%
        }%
      }%
      \renewcommand\@finalFrontmatterText{%
        This version of the \MakeTextLowercase{\workname} includes the corrections
        and modifications suggested by the Examining Committee during
        the defense of the original version of the work, which took
        place on \DTMusedate{@defensedate}.\\[1\baselineskip]
        A copy of the original version is available at the Institute of
        Mathematics and Statistics of the University of São Paulo.%
      }%
      \renewcommand\@institution{%
        Institute of Mathematics and Statistics,
        University of São Paulo%
      }%
      \renewcommand{\@assembleLicenseText}[1]{The content of this work is
                                              published under the #1 license}%
    }
}{} % \iftoggle{IMEthesis}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%% COLETA E DEFINIÇÃO DE METADADOS (TESE/DISSERTAÇÃO) %%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\ExplSyntaxOn

\iftoggle{IMEthesis}{

  % Mais de um coorientador é raro, mas pode acontecer
  \newcounter{numberOfCoadvisors}
  \NewDocumentCommand\coorientador{O{masc} m}{
    \stepcounter{numberOfCoadvisors}
    \tl_gclear_new:c {@coadvisor\Roman{numberOfCoadvisors}}
    \tl_gclear_new:c {@coadvisor\Roman{numberOfCoadvisors}Gender}

    \tl_set:cn {@coadvisor\Roman{numberOfCoadvisors}} {#2}
    \tl_set:cn {@coadvisor\Roman{numberOfCoadvisors}Gender} {#1}
  }

  \seq_gclear_new:N \@committeeMembers

  \newtoggle{@mestrado}
  \newtoggle{@doutorado}
  \newtoggle{@tcc}
  \newtoggle{@qualificacao}
  \newtoggle{@finalversion}

  % Opções usando LaTeX3 (veja texdoc l3keys).
  \keys_define:nn { IME / defense }
  {
    % Chaves à esquerda definem as variáveis à direita
    data .code:n= {\DTMsavedate{@defensedate}{#1}},
    data .value_required:n = true,
    nivel .choice:,
    nivel / mestrado .code:n = {\@mestrado},
    nivel / masters .code:n = {\@mestrado},
    nivel / dissertacao .code:n = {\@mestrado},
    nivel / doutorado .code:n = {\@doutorado},
    nivel / phd .code:n = {\@doutorado},
    nivel / tese .code:n = {\@doutorado},
    nivel / graduacao .code:n = {\@tcc},
    nivel / bachelor .code:n = {\@tcc},
    nivel / tcc .code:n = {\@tcc},
    nivel .value_required:n = true,
    quali .code:n = {\ifstrequal{#1}{true}{\toggletrue{@qualificacao}}{\togglefalse{@qualificacao}}},
    quali .default:n = {true},
    definitiva .code:n = {\ifstrequal{#1}{true}{\toggletrue{@finalversion}}{\togglefalse{@finalversion}}},
    definitiva .default:n = {true},
    provisoria .code:n = {\ifstrequal{#1}{true}{\togglefalse{@finalversion}}{\toggletrue{@finalversion}}},
    provisoria .default:n = {true},
    programa .tl_gset:N = \@program,
    program .value_required:n = true,
    apoio .tl_gset:N = \@financing,
    apoio .value_required:n = true,
    local .tl_gset:N = \@defenselocation,
    local .value_required:n = true,
    direitos .tl_gset:N = \@license,
    direitos .value_required:n = true,
    fichacatalografica .tl_gset:N = \@catalogingData,
    fichacatalografica .value_required:n = true,
    membrobanca .code:n = {\seq_gput_right:Nn \@committeeMembers {#1}},
    membrobanca .value_required:n = true,
  }

  \NewDocumentCommand\defesa{+m}{%
    \keys_set:nn {IME/defense}{#1}

    \exp_args:NV \str_case:nnF \@license
    {
      {CC-BY}{\gdef\@license{\@assembleLicenseText{CC~BY~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by/4.0/}{%
        (Creative~Commons~Attribution~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by/4.0/}}
      }

      {CC-BY-NC}{\gdef\@license{\@assembleLicenseText{CC~BY-NC~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nc/4.0/}{%
        (Creative~Commons~Attribution-NonCommercial~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc/4.0/}}
      }

      {CC-BY-ND}{\gdef\@license{\@assembleLicenseText{CC~BY-ND~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nd/4.0/}{%
        (Creative~Commons~Attribution-NoDerivatives~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc-nd/4.0/}}
      }

      {CC-BY-SA}{\gdef\@license{\@assembleLicenseText{CC~BY-SA~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-sa/4.0/}{%
        (Creative~Commons~Attribution-ShareAlike~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-sa/4.0/}}
      }

      {CC-BY-NC-SA}{\gdef\@license{\@assembleLicenseText{CC~BY-NC-SA~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nc-sa/4.0/}{%
        (Creative~Commons~Attribution-NonCommercial-ShareAlike~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc-sa/4.0/}}
      }

      {CC-BY-NC-ND}{\gdef\@license{\@assembleLicenseText{CC~BY-NC-ND~4.0}\\
        \href{https\c_colon_str//creativecommons.org/licenses/by-nc-nd/4.0/}{%
        (Creative~Commons~Attribution-NonCommercial-NoDerivatives~4.0~International~License)}}
        \hypersetup{pdflicenseurl={https://creativecommons.org/licenses/by-nc-nd/4.0/}}
      }
    }
    % If there is no match, use the user-supplied text
    {}
  }

  \seq_gclear_new:N \@seqkeywordspt
  \seq_gclear_new:N \@seqkeywordsen
  \newcommand*{\palavrachave}[1]{\seq_gput_right:Nn \@seqkeywordspt {#1}}
  \newcommand*{\keyword}[1]{\seq_gput_right:Nn \@seqkeywordsen {#1}}

  % Na impressão, as palavras-chave são separadas por pontos
  \newcommand*{\@keywordspt}{\seq_use:Nn \@seqkeywordspt {.\space}.}
  \newcommand*{\@keywordsen}{\seq_use:Nn \@seqkeywordsen {.\space}.}

  % Para inclusão nos metadados com hyperxmp, são separadas por vírgulas
  \newcommand*{\@commakeywordspt}{\seq_use:Nn \@seqkeywordspt {,}}
  \newcommand*{\@commakeywordsen}{\seq_use:Nn \@seqkeywordsen {,}}

  \NewDocumentCommand{\orientador}{O{masc} m}{
    \gdef\@advisor{#2}
    \gdef\@advisorGender{#1}
  }

  \NewDocumentCommand{\@doutorado}{}{
    \toggletrue{@doutorado}
    \togglefalse{@mestrado}
    \togglefalse{@tcc}
  }

  \NewDocumentCommand{\@mestrado}{}{
    \togglefalse{@doutorado}
    \toggletrue{@mestrado}
    \togglefalse{@tcc}
  }

  \NewDocumentCommand{\@tcc}{}{
    \togglefalse{@mestrado}
    \togglefalse{@doutorado}
    \toggletrue{@tcc}
  }

  % Opções usando LaTeX3 (veja texdoc l3keys).
  \keys_define:nn { IME / title }
  {
    % Chaves à esquerda definem as variáveis à direita
    titlept .tl_gset:N = \@titlept,
    titlept .value_required:n = true,
    titleen .tl_gset:N = \@titleen,
    titleen .value_required:n = true,
    subtitlept .tl_gset:N = \@subtitlept,
    subtitlept .value_required:n = true,
    subtitleen .tl_gset:N = \@subtitleen,
    subtitleen .value_required:n = true,
  }

}{} % \iftoggle{IMEthesis}

\ExplSyntaxOff

% Às vezes é necessário forçar quebras de linha no título para a capa, mas
% essas quebras não devem aparecer em outros lugares (especialmente nos
% metadados XMP). hyperref e hyperxmp removem essas quebras automaticamente,
% mas isso pode fazer duas palavras ficarem grudadas. Estas macros "apagam"
% esses comandos de maneira mais cuidadosa.

\ExplSyntaxOn

% Primeiro definimos a regex que vamos usar. O que estamos fazendo aqui é
% "(regex1)|(regex2)|(regex3)|(regex4)"
\regex_const:Nn \@IMEbreakRegex
  {
    ( \c{break} ) % Encontra "\break"
    |
    ( \c{newline} ) % Encontra "\newline"
    |
      % Isto encontra:
      % 1. A control sequence "\linebreak" -> "\c{linebreak}"
      % 2. Opcionalmente seguida de "[NÚMERO]" -> "( \s*\x{5B}\s*\d\s*\x{5D} )?"
    ( \c{linebreak} (\s*\x{5B}\s*\d\s*\x{5D})? )
    |
      % Isto encontra:
      % 1. A control sequence "\\" (quebra de linha) -> "\c{\\}"
      % 2. Optionalmente seguida de "[...]" -> "( \s*\x{5B}\s*...\s*\x{5D} )?"
      % 3. Onde "..." é qualquer dimensão TeX válida
      %    (veja o exemplo de regex em texdoc interface3)
    ( \c{\\}
      ( \s*\x{5B}\s*
          [\+\-]?(\d+|\d*\.\d+)\s*((?i)pt|in|[cem]m|ex|[bs]p|[dn]d|[pcn]c)
        \s*\x{5D}
      )?
    )
  }

\newcommand{\@IMEremoveLinebreaksEtc}[1]{
    % Primeiro, substitui todas as quebras de linha por espaços
    \regex_replace_all:NnN \@IMEbreakRegex {\ } #1

    % Depois elimina eventuais notas de rodapé
    \regex_replace_all:nnN {\s*\c{footnote}} {\c{@gobble}} #1
    \regex_replace_all:nnN {\s*\c{thanks}} {\c{@gobble}} #1

    % Depois transforma URLs em texto simples
    \regex_replace_all:nnN {\c{url}} {\c{@firstofone}} #1
    \regex_replace_all:nnN {\c{href}} {\c{@secondoftwo}} #1

    % Substitui \par (ou uma linha em branco) por um caractere de nova linha
    \regex_replace_all:nnN {\c{par}} {\n} #1

    % Depois elimina espaços repetidos
    \regex_replace_all:nnN {\h+} {\ } #1
    \regex_replace_all:nnN {\ \n} {\n} #1
    \regex_replace_all:nnN {\n+} {\n} #1
}

\ExplSyntaxOff

\ExplSyntaxOn

\iftoggle{IMEthesis}
  {
    \renewcommand\author[2][masc]{
      \gdef\@author{#2}
      \gdef\@authorGender{#1}
      \hypersetup{pdfauthor={\@author}}
    }

    \RenewDocumentCommand\title{m}{
      \keys_set:nn {IME/title}{#1}

      \bgroup
      % O título deve existir nas duas línguas; o subtítulo é opcional,
      % mas se houver também deve existir nas duas línguas.
      \IfLanguagePatterns{brazilian}
        {
          \global\let\@title\@titlept
          \ifdefvoid{\@subtitlept}
            {}
            {\global\let\@subtitle\@subtitlept}

          \let\@mainlangtitle\@titlept
          \let\@mainlangsubtitle\@subtitlept
          \let\@otherlangtitle\@titleen
          \let\@otherlangsubtitle\@subtitleen
          \def\@otherlangname{en}
        }
        {
          \global\let\@title\@titleen
          \ifdefvoid{\@subtitleen}
            {}
            {\global\let\@subtitle\@subtitleen}

          \let\@mainlangtitle\@titleen
          \let\@mainlangsubtitle\@subtitleen
          \let\@otherlangtitle\@titlept
          \let\@otherlangsubtitle\@subtitlept
          \def\@otherlangname{pt}
        }

      % Insere os metadados XMP no arquivo PDF final.
      % \@IMEremoveLinebreaksEtc está definida em imegoodies.sty

      \@IMEremoveLinebreaksEtc{\@mainlangtitle}
      \@IMEremoveLinebreaksEtc{\@mainlangsubtitle}
      \@IMEremoveLinebreaksEtc{\@otherlangtitle}
      \@IMEremoveLinebreaksEtc{\@otherlangsubtitle}

      \hypersetup{
        pdftitle={\@mainlangtitle
                  \ifdefvoid{\@mainlangsubtitle}{}{:~\@mainlangsubtitle}%
                 },
      }

      \XMPLangAlt{\@otherlangname}{
          pdftitle={\@otherlangtitle
                    \ifdefvoid{\@otherlangsubtitle}{}{:~\@otherlangsubtitle}%
                   },
      }

      % XMPLangAlt undefines "\do"; this may cause
      % problems with biblatex, but we do not need
      % to worry here because we are in a group.
      % https://github.com/plk/biblatex/issues/1105
      \egroup
    }
  }
  {}
\ExplSyntaxOff

\iftoggle{IMEthesis}
  {
    % Defaults quando o usuário não define alguma dessas variáveis.
    \providecommand\@author{Autor não definido!}
    \orientador{Orientador não definido!}
    \DTMsavedate{@defensedate}{1970-01-01}
    \providecommand\@program{Programa não definido!}
    \providecommand\@financing{}
    \providecommand\@defenselocation{Local não definido!}
    \providecommand\@license{Direitos não definidos!}
    \providecommand\@title{Título não definido!}
    \providecommand\@titlept{Título em português não definido!}
    \providecommand\@titleen{Título em inglês não definido!}
    \providecommand\@resumo{Resumo não definido!}
    \providecommand\@abstract{Abstract não definido!}
  }
  {}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%% IMPRIME A CAPA E A FOLHA DE ROSTO %%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}{
    \RenewDocumentCommand\maketitle{}{
      % Embora as páginas iniciais *pareçam* não ter numeração, a numeração
      % existe, só não é impressa. Os comandos \frontmatter, \mainmatter,
      % \pagenumbering etc. reiniciam a contagem de páginas quando os números
      % passam a ser impressos. Isso significa que há mais de uma página com
      % o número "1". O pacote hyperref não lida bem com essa situação, então
      % vamos desabilitar hyperlinks para números de páginas aqui.
      \hypersetup{pageanchor=false}
      \bgroup
      \onehalfspacing

      \@IMEcover
      \iftoggle{@tcc}{}{\@IMEtitlePage}
      \@IMEversoPage

      \egroup
      \if@openright\cleardoublepage\else\clearpage\fi
      \hypersetup{pageanchor=true}
    }
}{}

% Layout da capa
\NewDocumentCommand{\@IMEcover}{} {
  \cleardoublepage
  \thispagestyle{empty}

  \begin{hyphenrules}{nohyphenation}
      \iftoggle{@tcc}{\@institutionBlock}{}
      \@titleBlock
      \vspace*{\fill}
      \@detailsBlock
  \end{hyphenrules}
}

% Layout para a página de rosto (duas versões, de acordo
% com a Resolução CoPGr 6018 de 13/10/2011)
\NewDocumentCommand{\@IMEtitlePage}{} {
  \if@openright\cleardoublepage\else\clearpage\fi
  \thispagestyle{empty}

  \begin{hyphenrules}{nohyphenation}
      \@titleBlock
      \vspace*{2cm plus 2cm minus 1cm}
      \@versionInfoBlock
      \vspace*{3.5cm plus 3cm minus 3.5cm}
      \iftoggle{@finalversion}{\@committeeBlock}{}
      \vspace*{2cm plus 2cm minus 2cm}
  \end{hyphenrules}
}

\NewDocumentCommand{\@IMEversoPage}{}{
  \clearpage
  \thispagestyle{empty}
  \ifcsvoid{@catalogingData}
    {\vspace*{4cm}}
    {\vspace*{2cm}}

  \begin{list}{}{\rightmargin 3em \leftmargin 3em}
    \onehalfspacing\centering\footnotesize\itshape
    \item\@license
  \end{list}

  \ifcsvoid{@catalogingData} {} {\vspace{\fill}\@catalogingData}

  \vspace{1cm minus 1cm}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%% POSIÇÃO DOS ELEMENTOS NA CAPA %%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% O IME usa uma capa padrão de cartolina para todas as teses/dissertações.
% Essa capa tem uma janela recortada por onde se vê o título e o autor do
% trabalho. Ela fica centralizada na página, tem 100m de largura, 60mm de
% altura e começa 47mm abaixo do topo da página. Como o documento já tem
% margens definidas pelo usuário, precisamos calcular quanto precisamos
% acrescentar ou subtrair dessas margens para colocar o título e autor
% na posição exata (na verdade, com uma pequena folga: 49mm abaixo do topo
% da página, 96mm de largura e 56mm de altura).
%
% Para centralizar horizontalmente, poderíamos pensar em usar "\center",
% mas isso não funciona porque ele centraliza o texto em relação à coluna
% de texto, não à página. Assim, como as margens esquerda e direita do
% documento podem ser diferentes, a janela não ficaria na posição correta.
% O que faremos, então, é colocar essa janela em uma minipage e calcular
% a margem esquerda para que essa minipage fique centralizada.
%
% Além disso, outros elementos da capa também não podem ser centralizados
% com "\center", porque eles ficariam desalinhados em relação à janela
% com o título e autor. Vamos colocar esses outros elementos em uma
% minipage também, mas de tamanho diferente da anterior.
%
% Então, precisamos calcular três valores: a margem adicional em relação ao
% topo da página, a margem esquerda da janela com título e autor e a margem
% esquerda para os demais elementos centralizados da página.

\AtEndPreamble{
  % Calcula o valor das margens (após geometry ser carregada)

  % A distância entre o topo da página e o início do texto (fora o cabeçalho)
  % é dada por (1in + \voffset + \headsep + \topmargin + \headheight).
  % Queremos colocar a caixa com o título 49mm abaixo do topo, então:
  \dimgdef\@topTitleBlockMargin{49mm - (1in + \voffset + \headsep + \topmargin + \headheight)}

  % Quando \vspace é usado no início da página, ele não tem efeito; como
  % não é isso que queremos, vamos usar \vspace*. No entanto, \vspace*
  % é implementado inserindo uma \hrule de espessura zero e depois
  % acrescentando o espaço solicitado. O resultado não é exatamente
  % o esperado, pois \topskip, \parskip e \baselineskip interagem com
  % \vspace* de maneira um tanto complexa:
  % https://tex.stackexchange.com/a/247516
  %
  % Aqui, vamos compensar essa diferença. Note que, se a primeira linha
  % da página tivesse um tamanho de fonte especial, seria necessário
  % usar o valor de \baselineskip correspondente a essa fonte. Além
  % disso, definimos espaçamento simples porque o \vspace* mencionado
  % acima é executado com espaçamento simples.
  \bgroup
  \setstretch {\setspace@singlespace}% \singlespacing adds \baselineskip
  \dimgdef\@topTitleBlockMargin{\@topTitleBlockMargin - \baselineskip - \parskip}
  \egroup

  % Queremos colocar a caixa com o título centralizada na página. "\center"
  % centraliza em função da área de texto, não da página inteira, então
  % não podemos usá-lo, pois as margens esquerda e direita podem ser
  % diferentes. A distância entre a borda esquerda/interna do papel e o
  % início do texto é dada por (1in + \hoffset + \oddsidemargin), então:
  \dimgdef\@leftTitleBlockMargin{(\paperwidth - 96mm)/2 - (1in + \hoffset + \oddsidemargin)}
  \dimgdef\@coverLeftMargin{(\paperwidth - 160mm)/2 - (1in + \hoffset + \oddsidemargin)}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%% OS ELEMENTOS QUE COMPÕEM A CAPA E A FOLHA DE ROSTO %%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Com fontspec (ou seja, lualatex/xelatex), o comando \oldstylenums funciona
% com qualquer fonte que tenha suporte a números old-style. Já com pdflatex,
% o comando para escolher números old style depende da fonte em uso. Nesse
% caso, se não soubermos qual a fonte atual (ou seja, não é libertinus), vamos
% usar latin modern e torcer para o resultado não ser % muito discrepante do
% restante do texto.

% 499 = CDXCIX
\@ifpackageloaded{fontspec}
  {\providecommand{\@macCDXCIX}{mac~\oldstylenums{499}}}
  {
    \providecommand{\@macCDXCIX}{{\fontfamily{lmr}\selectfont mac~\oldstylenums{499}}}

    \@ifpackageloaded{libertinus}
      {\renewcommand{\@macCDXCIX}{{\LibertinusSerifOsF mac~499}}}
      {}
  }

\newcommand{\@coverText}{
  \bgroup
  \setstretch{.9}

  \iftoggle{@tcc}
    {\@coverTCCText}
    {\iftoggle{@qualificacao}{\@coverQualiText}{\@coverThesisText}}
  \par
  \egroup
}

\ExplSyntaxOn
\newcounter{@IMEtmpcnt}
\newcommand*{\@coverPeople} {%
  \begin{tabular}{rl}
    \iftoggle{@tcc}{}{\programname : & \@program \tabularnewline}
    \advisorname : & \@advisor \tabularnewline
    \setcounter{@IMEtmpcnt}{0}%
    \int_while_do:nNnn {\value{@IMEtmpcnt}} < {\value{numberOfCoadvisors}} {%
      \stepcounter{@IMEtmpcnt}%
      \coadvisorname{\Roman{@IMEtmpcnt}}: & \csuse{@coadvisor\Roman{@IMEtmpcnt}} \tabularnewline
    }%
  \end{tabular}
}

\ExplSyntaxOff

\newcommand{\@selfReference} {%
  \bgroup
  \IfLanguagePatterns{brazilian}
    {%
      \let\@currlangtitle\@titlept
      \let\@currlangsubtitle\@subtitlept
    }
    {%
      \let\@currlangtitle\@titleen
      \let\@currlangsubtitle\@subtitleen
    }%
  \@IMEremoveLinebreaksEtc{\@currlangtitle}%
  \@IMEremoveLinebreaksEtc{\@currlangsubtitle}%
  \@author.
  \textbf{\@currlangtitle\ifdefvoid{\@currlangsubtitle}{}{: \textit{\@currlangsubtitle}}}.
  \workname{} (\degreename).
  \@institution,
  São Paulo, \DTMfetchyear{@defensedate}.%
  \egroup
}

% Só para TCC
\newcommand{\@institutionBlock}{

    % A posição do quadro de título é fixa em relação à página;
    % a posição deste quadro é definida em função da posição do
    % quadro de título. Assim, primeiro vamos encontrar onde
    % deve começar o quadro do título. Veja os comentários em
    % \@titleBlock para entender o mecanismo.
    \bgroup
    \hfuzz=60pt % Não precisa avisar que estamos invadindo a margem direita aqui

    \setstretch {\setspace@singlespace}% \singlespacing adds \baselineskip

    \vspace*{\@topTitleBlockMargin}
    \ifdeflength{\@normalstrutheight}
      {}
      {\newlength{\@normalstrutheight}}
    \settoheight{\@normalstrutheight}{\strut}
    \vspace{-\@normalstrutheight}

    % Estamos alinhados com o quadro do título do trabalho,
    % mas não é isso que queremos: a parte inferior deste
    % quadro deve ficar 15mm acima do quadro de título e
    % este quadro tem 20mm de altura, então precisamos subir:
    \vspace{-20mm} % Espaço ocupado por este quadro
    \vspace{-15mm} % Espaço entre este quadro e o quadro de título

    \noindent\strut%
    \hspace*{\@coverLeftMargin}%
%    \fbox{%
      \begin{minipage}[t][20mm][s]{160mm}
        \vspace{0pt plus 20mm}

        \centering\large

        \textsc{\@institutionBlockText}

        \vspace{0pt plus 20mm}
      \end{minipage}
%    }% fbox
    \par

    % Agora precisamos voltar o "cursor" para o começo da página
    % para que o quadro de título seja inserido no lugar certo.
    % Para isso, vamos:
    %
    % 1. Chegar novamente ao início do quadro de título e
    %
    % 2. Retroceder o tamanho da margem superior

    % compensa o espaço inserido por \par logo acima
    \vspace{-\parskip}
    \egroup

    % A altura da minipage já compensou o \vspace{-20mm} acima;
    % ainda precisamos compensar o \vspace{-15mm}
    \vspace{15mm}

    % Agora estamos no início do quadro de título, então
    % podemos recuar exatamente o tamanho da margem superior.
    \vspace{-\@topTitleBlockMargin}
}

% O quadro com o título e o autor que deve ser visível
% através da janela na capa.
\NewDocumentCommand{\@titleBlock}{} {

    \bgroup
    \setstretch {\setspace@singlespace}% \singlespacing adds \baselineskip

    % Este espaço coloca o topo da próxima linha
    % na posição que queremos:
    \vspace*{\@topTitleBlockMargin}

    % No entanto, a próxima linha contém apenas
    % uma minipage, e definir o topo de uma linha
    % desse tipo é complicado. Assim, vamos:
    %
    % 1. Acrescentar um \strut a essa linha;
    %
    % 2. mover o baseline dessa linha para o topo do \strut;
    %
    % 3. Alinhar o topo da minipage ao baseline da linha.
    %
    % Sobre alinhamento de minipages:
    % https://en.wikibooks.org/wiki/LaTeX/Boxes

    \ifdeflength{\@normalstrutheight}
      {}
      {\newlength{\@normalstrutheight}}
    \settoheight{\@normalstrutheight}{\strut}
    \vspace{-\@normalstrutheight}

    \noindent\strut
    \hspace*{\@leftTitleBlockMargin}%
%    \fbox{%
      \begin{minipage}[t][56mm][s]{96mm}
          \vspace*{2cm plus 1.5cm minus 1.8cm}

          \centering\large

          \textbf{\@title}

          \vspace{0.3cm plus 0.2cm minus 0.1cm}

          \ifdefvoid{\@subtitle}{}{\textbf{\textit{\@subtitle}}}

          \vspace{1cm plus 1cm minus 0.6cm}

          \@author

          \vspace*{2cm plus 1.5cm minus 1.8cm}
      \end{minipage}%
%    }% fbox
    \par
    \egroup
}

% As demais informações da capa
\NewDocumentCommand{\@detailsBlock}{} {

  \bgroup
  \hfuzz=60pt % Não precisa avisar que estamos invadindo a margem direita aqui
  \onehalfspacing
  \noindent
  \hspace*{\@coverLeftMargin}%
%  \fbox{%
    \begin{minipage}[t][130mm][s]{160mm}
      \begin{center}
        \Large

        \vspace*{0.3cm plus 0.5cm minus 0.3cm}

        \textsc{\@coverText}

        \vspace*{1.5cm plus 0.5cm minus 0.5cm}

        \large\@coverPeople

        \vspace*{2.5cm plus 1cm minus 1cm}

        \normalsize

        \bgroup
        \singlespacing
        \@financing\par
        \egroup

        \vspace*{1cm plus 1cm minus 0.3cm}

        \@defenselocation

        \iftoggle{@tcc}
          {\DTMfetchyear{@defensedate}}
          {\DTMsetdatestyle{month-year}\DTMusedate{@defensedate}}

      \end{center}
    \end{minipage}%
%  }% fbox
  \par
  \egroup
}

% As informações da banca que vão apenas na versão definitiva
% da página de rosto
\ExplSyntaxOn
\NewDocumentCommand{\@committeeBlock}{} {
    \bgroup
    \onehalfspacing
    \begin{minipage}[t][][t]{\textwidth}
      \begin{quote}
        \normalsize\noindent\committeename :\par
        \begin{list}{}
        {
          \setlength{\leftmargin}{0pt}
          \setlength{\itemsep}{.1\baselineskip}
          \setlength{\topsep}{\baselineskip}
        }
          \item[] \seq_use:Nn \@committeeMembers {\item[]}
        \end{list}
      \end{quote}
    \end{minipage}
    \par
    \egroup
}
\ExplSyntaxOff

% A informação sobre a versão provisória ou definitiva
\NewDocumentCommand{\@versionInfoBlock}{} {%
  % As diretrizes dizem que "A natureza do trabalho, o grau pretendido, o
  % nome da instituição a que é submetido e a área de concentração devem
  % ser alinhados a partir do meio da parte impressa da página para a
  % margem direita, tanto na folha de rosto como na folha de avaliação."
  %
  % Assim, queremos alinhar o texto à direita com uma grande margem
  % à esquerda. Uma solução simples é alinhar o texto à direita
  % e inserir uma minipage. Dentro dela, definimos o texto
  % também alinhado à direita.

  \bgroup
  \onehalfspacing
  \begin{FlushRight}
    %\fbox{
      % Margem direita + 80mm de largura significa que a minipage
      % começa mais ou menos no meio da página.
      \begin{minipage}[t][50mm][s]{80mm}
        \begin{FlushRight}
          \normalsize
          \iftoggle{@finalversion}{%
            \@finalFrontmatterText%
          } {%
            \@provisionalFrontmatterText%
          }%
        \end{FlushRight}
        \vspace*{0pt plus 50mm}
      \end{minipage}
      \par
    %} % fbox
  \end{FlushRight}
  \egroup
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ANEXOS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\iftoggle{IMEthesis}{
  % A classe Book inclui o comando \appendix, que (obviamente) permite inserir
  % apêndices no documento. No entanto, não há suporte similar para anexos. Esta
  % package acrescenta alguns recursos adicionais para apêndices; vamos usá-la
  % para permitir colocar a palavra "Apêndice" no sumário e também para definir
  % o comando \annex.
  \RequirePackage{appendix}
  \noappendicestocpagenum

  % Altera a formatação da palavra "Apêndice" no sumário
  %
  % Não queremos a linha "Apêndice" como a última da página no sumário;
  % para isso:
  %
  % 1. Acrescentamos um pouco de espaço elástico logo antes dela
  %
  % 2. Colocamos uma sugestão de quebra de página
  %
  % 3. Usamos \@afterheading
  %
  % 1 e 2 incentivam (mas não forçam) LaTeX a realizar a quebra antes
  % dela e 3 força LaTeX a mantê-la na mesma página que a próxima linha.
  %
  % \addtocontents pode pregar peças se usamos \include; contornamos
  % com \immediate: https://tex.stackexchange.com/a/13926
  \renewcommand\addappheadtotoc{%
    \begingroup
      \let\origwrite\write
      \def\write{\immediate\origwrite}%
      \addtocontents{toc}{{\large\vspace{0pt plus 2\baselineskip minus 0pt}}}%
      \addtocontents{toc}{\protect\pagebreak[2]}%
      \addtocontents{toc}{\vspace{.8\baselineskip}}%
      \addtocontents{toc}{{\large\bfseries\hspace{-1.3em}\appendixtocname\par}}%
      \addtocontents{toc}{\protect\@afterheading}%
    \endgroup
  }

  \let\@IMErealAppendixname\appendixname
  \let\@IMErealAppendixtocname\appendixtocname
  \let\@IMErealAppendixpagename\appendixpagename
  \def\appendixname{\@IMErealAppendixname}
  \def\appendixtocname{\@IMErealAppendixtocname}
  \def\appendixpagename{\@IMErealAppendixpagename}

  \providecommand\annexname{Annex}
  \providecommand\annextocname{Annexes}
  \providecommand\annexpagename{Annexes}

  \addto\captionsbrazil{%
    \renewcommand\annexname{Anexo}%
    \renewcommand\annextocname{Anexos}%
    \renewcommand\annexpagename{Anexos}%
    \renewcommand\@IMErealAppendixname{Apêndice}%
    \renewcommand\@IMErealAppendixtocname{Apêndices}%
    \renewcommand\@IMErealAppendixpagename{Apêndices}%
  }

  \addto\captionsbrazilian{%
    \renewcommand\annexname{Anexo}%
    \renewcommand\annextocname{Anexos}%
    \renewcommand\annexpagename{Anexos}%
    \renewcommand\@IMErealAppendixname{Apêndice}%
    \renewcommand\@IMErealAppendixtocname{Apêndices}%
    \renewcommand\@IMErealAppendixpagename{Apêndices}%
  }

  \addto\captionsenglish{%
    \renewcommand\annexname{Annex}%
    \renewcommand\annextocname{Annexes}%
    \renewcommand\annexpagename{Annexes}%
    \renewcommand\@IMErealAppendixname{Appendix}%
    \renewcommand\@IMErealAppendixtocname{Appendixes}%
    \renewcommand\@IMErealAppendixpagename{Appendixes}%
  }

  \let\@IMEorigAppendix\appendix
  \renewcommand\appendix{%
      \def\appendixname{\@IMErealAppendixname}
      \def\appendixtocname{\@IMErealAppendixtocname}
      \def\appendixpagename{\@IMErealAppendixpagename}
      \def\Hy@appendixstring{appendix}%
      \@IMEorigAppendix
  }

  \newcommand\annex{%
      \def\Hy@appendixstring{annex}
      \def\appendixname{\annexname}
      \def\appendixtocname{\annextocname}
      \def\appendixpagename{\annexpagename}
      \@IMEorigAppendix
  }

}{} % \iftoggle{IMEthesis}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% ÍNDICE REMISSIVO %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% filecontents não funciona dentro de iftoggle;
% vamos usar newif para contornar isso.
\newif\ifIMEthesisTest
\IMEthesisTestfalse

\iftoggle{IMEthesis}{
  \IMEthesisTesttrue

  % A criação do índice remissivo depende de um programa auxiliar, que pode ser
  % o "makeindex" (default) ou o xindy. xindy é mais poderoso e lida melhor com
  % línguas diferentes e caracteres acentuados, mas o programa não está mais
  % sendo mantido.
  %\RequirePackage[xindy]{imakeidx} % usando xindy
  \RequirePackage{imakeidx} % usando makeindex

  % Por padrão, o cabeçalho das páginas do índice é feito em maiúsculas;
  % vamos mudar isso e deixar fancyhdr definir a formatação
  \indexsetup{
    othercode={\chaptermark{\indexname}},
  }

  \makeindex[
    noautomatic,
    intoc,
    % Estas opções são usadas por xindy
    % "-C utf8" ou "-M lang/latin/utf8.xdy" são truques para contornar este
    % bug, que existe em outras distribuições tambem:
    % https://bugs.launchpad.net/ubuntu/+source/xindy/+bug/1735439
    % Se "-C utf8" não funcionar, tente "-M lang/latin/utf8.xdy"
    %options=-C utf8 -M hyperxindy.xdy,
    %options=-M lang/latin/utf8.xdy -M hyperxindy.xdy,
    % Estas opções são usadas por makeindex
    options=-s mkidxhead.ist -l -c,
  ]
}{} % \iftoggle{IMEthesis}

\ifIMEthesisTest

% Índices criados com xindy não funcionam em conjunto com hyperref; os criados
% com makeindex podem funcionar, mas apenas se hyperref for carregada após
% imakeidx. Para contornar esse problema, configuramos hyperref para *não*
% gerar hyperlinks no índice (mais abaixo) e configuramos xindy/makeindex
% para que eles gerem esses hyperlinks por conta própria (a configuração de
% makeindex foi copiada da documentação de hyperref).

% Cria o arquivo de configuração para xindy lidar corretamente com hyperlinks.
%\begin{filecontents*}{hyperxindy.xdy}
%(define-attributes ("emph"))
%(markup-locref :open "\hyperpage{" :close "}" :attr "default")
%(markup-locref :open "\textbf{\hyperpage{" :close "}}" :attr "textbf")
%(markup-locref :open "\textit{\hyperpage{" :close "}}" :attr "textit")
%(markup-locref :open "\emph{\hyperpage{" :close "}}" :attr "emph")
%\end{filecontents*}

% Cria o arquivo de configuração para makeindex lidar corretamente com
% hyperlinks e colocar um cabeçalho para cada letra do índice.
\begin{filecontents*}{mkidxhead.ist}
delim_0 ", \\hyperpage{"
delim_1 ", \\hyperpage{"
delim_2 ", \\hyperpage{"
delim_n "}, \\hyperpage{"
delim_t "}"
encap_prefix "}\\"
encap_infix "{\\hyperpage{"
encap_suffix "}"
headings_flag 1
heading_prefix "{\\bfseries "
heading_suffix "}\\nopagebreak\n"
\end{filecontents*}

\fi % \ifIMEthesisTest
\IMEthesisTestfalse
